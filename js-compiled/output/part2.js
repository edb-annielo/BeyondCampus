function msg(a,b){if(user.lang()==1028)return b;return a}function dict(a){switch(user.lang()){case 1028:case 1033:var a2=_.isString(a)?a.toLowerCase():String(a);var result=DICT[user.lang()][a2];if(result!=null)return result;break}return a}function locale(a){var a2=_.isString(a)?a.toLowerCase():String(a);var result=LOCALE[a2];if(result!=null)return result;return 1033}var LOCALE={"en":1033,"en-us":1033,"en-gb":1033,"en-au":1033,"zh-hk":1028,"zh-tw":1028,"zh-cn":1028};var DICT={};
DICT[1033]={"@locale":"en","@locale-sup":"zh-HK",1033:"English",1028:"繁體中文","beyond campus":"Beyond Campus","step out":"Beyond Campus","lng":"Long.","lat":"Lat.","map key":"Trip Key","@longbox-more":"more ▼",":":":","back":"Back","forward":"Forward","recent maps":"Recent Trips","this map is in a different language":"This trip is in a different language","you have to login to create and edit maps.":"You have to login to create and edit trips.","plaese enter map password":"Plaese enter trip password",
"no internet.":"No internet.","please connect to internet.":"Please connect to network (3g, 4g or WiFi) and try again.","where are you going?":"Where are you going?","which locations will you visit?":"Which locations will you visit?","what will you do at those locations?":"What will you do at those locations?","improve checkpoints' accuracy using gps.":"Improve checkpoints' accuracy using GPS.","is the trip too long or too short?":"Is the trip too long or too short?","are the tasks feasible?":"Are the tasks feasible?",
"go to the checkpoints.":"Go to the checkpoints.","complete and submit the tasks.":"Complete and submit the tasks.","review my trip's submission.":"Review my trip's submission.","review the participants' submissions.":"Review the participants' submissions.","preview map":"Preview Trip","new map":"New Trip","you may use map key to search this map":'You may use "trip key" to retrieve this map in "Get a Trip".','please enter "map key"':'Please enter "Trip Key"',"all my maps":"All My Trips","all maps":"All Trips",
"all public maps":"Public Trips","search maps":"Search Trips","get a map":"Get a Trip","open map":"Open Trip","offline map":"Offline Trips","public map":"Public Trip","private map":"Private Trip","enable map":"Enable Trip","1 page":"1 Column","2 pages":"2 Columns, Side-by-Side","switch language":"Switch U.I. Language","map name":"Trip Name",'please enter "map name"!':'Please enter "Trip Name"!',"update (by input)":"Move to Input Location","map centre":"Default Map","return to map centre":"Return to Default Map",
"change centre":"Change Default Map","zoom level of the map":"Zoom level of the map: It is the initial resolution at which to display the map, where zoom 0 corresponds to a map of the Earth fully zoomed out, and higher zoom levels zoom in at a higher resolution.","latitude and longitude of the map's centre":"Latitude and longitude of the map's central point.","move the map to change its default location.":"Change the map's default location by (a) moving the map; or (b) entering belows manually.",
"map settings":"Trip Settings","password for private map":"Private Trip: Set a Password","creative commons for public map":"Public Trip: Sharing (Creative Commons)","this map is in use.":"Enabled Trip: This trip is in use.","this map is not in use.":"Disabled Trip: This trip is not in use.","this map is searchable.":"Public Trip: This trip is searchable and accessable by the public.","this map can only be accessed by its map key.":'Private Trip: This trip can only be accessed by its "trip key". It is not searchable.',
"this map can receive participants' submissions.":"You can receive this participants' submissions of this trip.","this map will not receive any participant's submission.":"You cannot receive any participant's submission of this trip.","if this map is not public and the password is not empty, users have to enter this password before starting the trip.":'If "Public Trip" in above is selected FALSE (✘), hence "Private Trip", you may also set a password. After setting the password, participants have to access this trip by its "trip key" then enter the password, before starting the trip.',
"if this map is public, you are sharing the map.":'If "Public Trip" in above is selected TRUE (✔), hence "Public Trip", you are sharing the trip to the public (using Creative Commons BY-NC-SA 3.0).',"delete this map":"Delete this trip","are you sure to delete this map?":"Are you sure to delete this trip?","cc terms":"CC BY-NC-SA 3.0","cc url":"http://creativecommons.org/licenses/by-nc-sa/3.0/hk/","you will lose all data of this map.":"Warning: You will lose all data of this trip, including the trip's info & settings, the map, the checkpoints and tasks, the submissions, etc...",
"this is a creator-only function.":'This is a "trip creator only" function.',"@plan-advance-public-notice-line1":'The terms of "Public Trip: Sharing (Creative Commons)" has been removed. ',"@plan-advance-public-notice-line2":'If "Public Trip" in above is selected TRUE (✔), the public can search and access this trip. However, it is no longer related to copying this trip.',"@plan-advance-public-notice-line3":'If you would like others to copy your trip, please change "Copyable Trip".',"duplicate the trip's checkpoints & tasks to their trips in beyond campus,":"copy the trip's checkpoints & tasks to their trips in Beyond Campus,",
"duplicate the trip as their trips in beyond campus.":"copy the trip as their trips in Beyond Campus.","creator only":"Creator Only: \nThis trip can be copied by the trip creator.","creator + collaborators":"Creator + Collaborators: \nThis trip can be copied by the trip creator or collaborators.","creator + collaborators + public":"Creator + Collaborators + Public: \nThis trip can be copied by public.","non-copyable":"Non-Copyable: \nThis trip cannot be copied, including its creator.","all checkpoints are accessible from the start, but their tasks are locked until stepping into the locations.":"All checkpoints are accessible from the start, \nbut their tasks are locked until stepping into the locations.",
"checkpoints are locked until the previous checkpoint is stepped.\x0B(checkpoints must be stepped in order.)":"Checkpoints are locked until the previous checkpoint is stepped.\x0B\n(Checkpoints must be stepped in order.)","checkpoints are locked until the previous checkpoint's tasks are completed.\x0B(checkpoints must be completed in order.)":"Checkpoints are locked until the previous checkpoint's tasks are completed.\x0B\n(Checkpoints must be completed in order.)","checkpoints are locked until stepping into the locations.":"Checkpoints are locked until stepping into the locations.",
"all checkpoints & their tasks are accessible from the start.":"All checkpoints & their tasks are accessible from the start.","all checkpoints are accessible from the start, but their tasks are locked until the previous checkpoint is stepped.\x0B(checkpoints must be completed in order.)":"All checkpoints are accessible from the start, \nbut their tasks are locked until the previous checkpoint is stepped.\x0B\n(Checkpoints must be completed in order.)","checkpoints are locked until entering their passwords.":"Checkpoints are locked until entering their passwords.",
"all checkpoints are accessible from the start, but their tasks are locked until entering the checkpoints' passwords.":"All checkpoints are accessible from the start, \nbut their tasks are locked until entering the checkpoints' passwords.","if you change the rule, it is recommended any current participant to restart this trip.":'If you change the rule, it is recommended any CURRENT participant of this trip to restart the trip ("Quit Trip" then "Start Trip" again).',"the checkpoints/tasks could also be unlocked by entering the checkpoints' passwords.":"The checkpoints/tasks could also be unlocked by entering the checkpoints' passwords.",
"roadmap displays the default road map view.":"It displays the default road map view.","satellite displays google earth satellite images.":"It displays Google Earth satellite images.","hybrid displays a mixture of normal and satellite views.":"It displays a transparent layer of city names and major streets on satellite images.","terrain displays a physical map based on terrain information.":"It displays a physical relief map with elevation and terrain features (mountains, rivers, etc.).","street view displays the street view control.":'It enables the Street View control (the "pegman").',
"the entire map cannot contain more than 14 tasks of taking photos.":"The entire trip cannot contain more than 10 tasks of taking photos.","participant name":"Name","checkpoint is unlocked":"Checkpoint {cpOrder} ({name}) is unlocked!","you are near checkpoint":"You are near checkpoint {cpOrder}.","the rule of this trip has been changed.":"The rule of this trip has been changed.","it is recommended to restart this trip.":'It is recommended to restart this trip ("Quit Trip" then "Start Trip" again).',
"click back to return.":"Click < (back button) to return.","duplicate this map":"Copy This Trip","duplicate trip":"Copy Trip","duplicate trips":"Copy Trips","duplicate":"Copy","copyable trips":"Copyable Trips","duplicable trips":"Copyable Trips","duplicable trip":"Copyable Trip","please enter a school email":"Please enter your email which is provided by your school.","language setting":"語言","current language":"現時語言","switch to":"轉換為","by clicking this button...":'by clicking "System Reset" button...',
"@info-tel":"3698 3740","@info-email":"ite@edb.gov.hk","@info-aboutus-line1":'"Beyond Campus" is an educational e-tool designed & developed by the Education Bureau.',"@info-aboutus-line2":"Teachers can design their own mobile learning activities, using Global Positioning System (GPS) to display the route and tasks.","@info-aboutus-line3":'"Beyond Campus" is suitable for outdoor activities, such as site-visits, field trips, etc.',"@info-aboutus-line4":"Examples of activities:","@info-aboutus-line5":"Chinese Language Education: literary walks, literary sketches, cultural attraction visits",
"@info-aboutus-line6":"Personal, Social & Humanities Education: field trips in geography, field trips to historical and cultural sites","@info-aboutus-line7":"Science Education: tree studies, natural ecological observation","@info-aboutus-line8":"Question and answer types include:","@info-aboutus-line9":"text answers, multiple-choices, true or false questions, retrieve the immediate location, take a photo or select a picture from the device.","@info-aboutus-line10":"It is recommended to do activities on mobile devices, such as tablets or smart phones.",
"whats new":"What's New","@info-bestview-cat1":"Desktop / Laptop:","@info-bestview-cat1-screen":"Screen resolution: 1024x768 or 768x1024 or above","@info-bestview-cat1-browser":"Browsers: Chrome 20, Firefox 14 or Internet Explorer 9","@info-bestview-cat2":"Mobile / Tablet:","@info-bestview-cat2-screen":'Screen size: 5" or above',"@info-bestview-cat2-browser":"Browsers (for Mobile Web): iPad's Safari, Android default browser, Chrome, Firefox.","@info-bestview-cat2-browser-warning":"* If using Android Chrome, any GPS function is unavailable until Google fixes its bug.",
"@info-bestview-cat2-device":"Devices (for App): iPad (iOS 5+), Android (2.3.4+, 4.1+) ","@info-contactus-line1":"Enquiries:","@info-contactus-line2":"Information Technology in Education Section of the Education Bureau","@info-contactus-line3":"Tel: {tel}","@info-contactus-line4":"Email: {email}","@info-terms":"These teaching resources are developed by the Education Bureau for teachers' free use to facilitate learning and teaching in Hong Kong. The copyrights of these teaching resources belong to the Government of Hong Kong Special Administrative Region. Unless written permission is given, these resources should not be replicated, edited, distributed, displayed or use for commercial purposes. For enquiries, please contact the Information Technology in Education Section of the Education Bureau at {tel} or via {email}.",
"@info-disclaimer-line1":'"Beyond Campus" web application ("this website") is developed by the Education Bureau ("EDB") of the Government of the Hong Kong Special Administrative Region. You acknowledge and agree that if you decide to browse or utilize the services provided by this website, you do it entirely at your own risk. EDB is not responsible for any loss or damage whatsoever arising from or in connection with or otherwise associated with browsing or using this website.',"@info-disclaimer-line2":"EDB strives to provide and maintain the accuracy and the completeness of the contents of this website. It, however, does not assume responsibility for any mistakes or omissions, and shall not be held liable for loss and damage in this regard. ",
"@info-faq-tripicon":"Trip Icons: The Trip's Related Attributes","@info-faq-tripstatus-disable":"This trip is disabled (cannot in use).","@info-faq-tripstatus-public":"This trip is searchable and accessable by the public. It is also shared to the public.","@info-faq-tripstatus-public-cc":"The trip is shared to the public using Creative Commons","@info-faq-tripstatus-public-cc2":"The resulting work should follow CC BY-NC-SA.","@info-faq-tripstatus-private":'This trip can only be accessed by its "trip key". It is not searchable.',
"@info-faq-tripstatus-private-password":'The trip\'s creator/collaborators may also set a password. After setting the password, participants have to access this trip by its "trip key" then enter the password, before starting the trip.',"@info-faq-select-true":"Select TRUE (✔)","@info-faq-select-false":"Select FALSE (✘)","share under beyond campus,":'be a "Beyond Campus" trip and share under beyond campus,',"@info-gps-enable":'You must enable the "location service" to retrieve your position and display it on the map.',
"@info-gps-android-enable-2.3.4":"Settings » Location & security » My Location » ","@info-gps-android-enable-4.1":"Settings » Personal » Location services » ","@info-gps-ios-enable-ios6":"Settings » Privacy » Location Services » ","@info-gps-ios-enable-ios5":"Settings » Location Services » ","@info-gps-ios-enable-ipad":"Settings » Privacy » Location Services » ","@info-gps-ios-enable-iphone":"Settings » Location Services » ","@info-gps-ios-enable-ipt":"Settings » Location Services » ","@info-gps-ie-enable":"Internet options » Privacy » Location » ",
"@info-gps-chrome-enable":"Chrome Menu » Settings » Show advanced settings » [Privacy] section » Content settings » [Location] section » ","tick":"Tick","allow this site using the location service":'Allow "Beyond Campus" Using the Location Service',"@info-gps-site":'Go to this website, when the browser pops-up a dialog of "sharing location", accept the dialog.'};
DICT[1028]={"@locale":"zh-HK","@locale-sup":"zh-HK",1033:"English",1028:"繁體中文","english":"英文","chinese":"中文","beyond campus":"Beyond Campus 移動學堂","step out":"Beyond Campus 移動學堂","map":"地圖","trip":"旅程","checkpoints":"定點","checkpoint":"定點","task":"任務","tasks":"任務","longitude":"經度","lng":"經度","latitude":"緯度","lat":"緯度","zoom":"縮放","mode":"模式","mode:":"模式：","map key":"旅程代號","expand":"展開","collapse":"折疊 (收起)","@longbox-more":"繼續閲讀 ▼",": ":"：",":":"：","?":"？",", ":"，",".":"。","login":"登入","logout":"登出",
"sign up":"登記","home":"主頁","information":"資訊","back":"回到上一頁","forward":"前進下一頁","system config.":"系統設定","last update":"最後更新","offline update":"離線更新","updating":"更新中","submitting":"呈交中","error":"發生錯誤","deleted":"已刪除","please wait":"請等候","connection failed":"無法連線，請再嘗試","bad request":"錯誤請求","unauthorized":"未授權","access forbidden":"禁止","not found":"未找到","method not allowed":"方法未允許","not acceptable":"無法訪問","request timeout":"請求超時","precondition failed":"先决條件錯誤","request entity too large":"請求實體過大","unsupported media type":"不支持的媒體格式",
"requested range not satisfiable":"請求範圍無法滿足","expectation failed":"期望失敗","internal server error":"內部服務器錯誤","not implemented":"未實現","bad gateway":"錯誤的網關","service unavailable":"服務無法獲得","gateway timeout":"網關超時","http version not supported":"不支持的 HTTP 版本","please select mode":"請選擇模式","recent maps":"最近使用的旅程","current trip":"現正進行的旅程","login required":"需要登入","where are you going?":"你要往哪裡去？","which locations will you visit?":"你會去哪些位置？","what will you do at those locations?":"在這些地方，你會做什麼？","improve checkpoints' accuracy using gps.":"使用GPS提高定點的精準度。",
"is the trip too long or too short?":"行程是否過長或過短？","are the tasks feasible?":"任務是可行的嗎？","go to the checkpoints.":"前往定點。","complete and submit the tasks.":"完成並呈交習作。","review my trip's submission.":"查看我的旅程習作。","review the participants' submissions.":"檢查參加者的呈交習作。","this map is in a different language":"本旅程使用另一語言","please login!":"請先登入！","you have to login to create and edit maps.":"你需要登入，才可建立或修改旅程。","plaese enter map password":"請輸入旅程密碼","you have started another trip. quit that one?":"你現正進行的另一個旅程，是否退出該旅程？",
"(note: you may only start one trip concurrently.)":"（注意：只能同時進行一個旅程。）","no internet.":"沒有網路連線。","please connect to internet.":"請確定流動裝置成功連上網路(如：3g、4g或WiFi)後再次嘗試。","continue":"繼續","new map":"新旅程","preview map":"預覽旅程","plan the trip":"規劃旅程","pre-trip":"旅程前","the trip":"旅程","after trip":"旅程後","open":"開啟","open map":"開啟旅程","all my maps":"所有我的旅程","all maps":"所有旅程","all public maps":"公開的旅程","search maps":"搜尋旅程","get a map":"擷取旅程","offline":"離線","offline map":"離線旅程",'please enter "map key"':"請輸入「旅程代號」","no results":"沒有結果",
"loading":"載入中","more":"更多","collaborating":"我協作的","collaborator":"我協作的","created by me":"我製作的","opened":"已開啟","public":"公開","private":"非公開","public map":"公開的旅程","private map":"非公開的旅程","submitted":"已完成並呈交","disable":"被設為暫停使用","disabled":"被設為暫停使用","enable map":"啟用旅程","warning":"警告","basic":"基本資料","advance":"進階","advance settings":"進階設定","advance setting":"進階設定","checkpoints & tasks":"定點與任務","tags ":"標籤","tags":"標籤","all notes":"所有筆記","notes":"筆記","note":"筆記","notifications":"通知","users":"使用者","menu":"選單",
"1 page":"單欄","2 pages":"雙欄、並排","mapheader-notice.png":"mapheader-notice-c.png","mapheader-map.png":"mapheader-map-c.png","mapheader-cp.png":"mapheader-cp-c.png","mapheader-basic.png":"mapheader-basic-c.png","mapheader-review.png":"mapheader-review-c.png","mapheader-tags.png":"mapheader-tags-c.png","mapheader-users.png":"mapheader-users-c.png","mapheader-allnotes.png":"mapheader-allnotes-c.png","mapheader-notes.png":"mapheader-notes-c.png","mapheader-advance.png":"mapheader-advance-c.png","map name":"旅程名稱",
"map centre":"預設地圖位置","description":"簡介","my position":"我的位置","creator":"作者","created by ":"作者：","created by":"作者：","related attributes":"相關屬性","you may use map key to search this map":"你可以使用此「旅程代號」擷取此旅程。","save":"儲存","switch language":"轉換介面語言",'please enter "map name"!':"請輸入「旅程名稱」！",'please enter "creator"!':"請輸入「作者」！","close":"關閉","cancel":"取消","actions":"動作","switch mode":"轉換模式","change centre":"更改預設地圖","return to map centre":"返回預設地圖","zoom level of the map":"地圖的縮放等級(zoom level)，指定顯示地圖的解析度，而其中縮放 0 代表完全縮小的地球地圖，而縮放等級較高會以較高的解析度時放大。",
"latitude and longitude of the map's centre":"地圖中心點的經緯度","go to ...":"地圖位置","move the map to change its default location.":"設定「預設地圖位置」：(a)移動地圖 或 (b)手動輸入下列空格。","update (by input)":"手動輸入位置",'please enter valid "latitude", "longitude" and "zoom".':"請輸入有效的經緯度和縮放。","search places":"搜尋地點","enter places":"輸入地點","clear search":"清除搜尋","map settings":"旅程設定","checkpoint range":"定點範圍","(no passwords)":"(沒有密碼)","password for private map":"非公開的旅程：設定密碼","creative commons for public map":"公開的旅程：分享旅程（共享創意）","private key":"非公開旅程的密碼",
"this map is in use.":"啟用旅程：此旅程被設為可以使用。","this map is not in use.":"暫停使用旅程：此旅程被設為暫停使用。","this map is searchable.":"「公開的旅程」：公眾可以搜尋並使用此旅程。","this map can only be accessed by its map key.":"「非公開的旅程」：參加者需要使用「旅程代號」抓取此旅程，不可以搜尋此旅程。","difficulties":"難度","rule":"規則","rules":"規則","delete this map":"刪除此旅程","are you sure to delete this map?":"你是否確定刪除此旅程？","receive submissions":"接收參加者呈交習作","this map can receive participants' submissions.":"允許接收參加者呈交習作。（注意：參加者的呈交習作將於呈交的180天後自動刪除。）","this map will not receive any participant's submission.":"暫停接收參加者呈交習作。",
"if this map is not public and the password is not empty, users have to enter this password before starting the trip.":"如果在以上「公開的旅程」選擇「否」（✘），可於此輸入密碼。設定密碼後，參加者需要使用「旅程代號」抓取旅程，並輸入「密碼」，才能開始旅程。","if this map is public, you are sharing the map.":"如果在以上「公開的旅程」選擇「是」（✔），代表你願意向公眾分享此旅程。（需依照「共享創意」分享條款：署名 - 非商業性 - 相同方式分享 (CC BY-NC-SA)）","public can":"公眾可以","search and access the trip,":"搜尋並使用此旅程，","duplicate the trip's checkpoints & tasks to their trips in beyond campus,":"複製此旅程的定點與任務到他們在「移動學堂」內的旅程，","duplicate the trip as their trips in beyond campus.":"複製此旅程成為他們在「移動學堂」內的旅程。",
"for more":"詳情","cc terms":"CC BY-NC-SA 3.0 條款","cc url":"http://creativecommons.org/licenses/by-nc-sa/3.0/hk/deed.zh_TW","if the user device's location service is less accurate than the above checkpoint range, the device's accuracy will be used instead.":"如果參加者的裝置的定位系統的準確度少於「定點範圍」（比「定點範圍」差），「定點範圍」會改為依照該裝置的準確度。","the password is":"密碼是","you will lose all data of this map.":"警告：你將失去此旅程的所有資料，包括旅程內容及設定、地圖、定點與任務、習作等等...","this is a creator-only function.":"此功能只限旅程作者使用。","@plan-advance-public-notice-line1":"「公開的旅程：分享旅程（共享創意）」條款已被移除。",
"@plan-advance-public-notice-line2":"如果在以上「公開的旅程」選擇「是」（✔），公眾可以搜尋並使用此旅程。但是，此設定與「可否複製此旅程」再沒有關係。","@plan-advance-public-notice-line3":"如欲允許其他使用者（協作者、公眾）複製此旅程，請修改「可複製旅程」。","creator only":"只限作者：\n只有旅程作者才可複製此旅程。","creator + collaborators":"作者 + 協作者：\n旅程作者及協作者可以複製此旅程。","creator + collaborators + public":"作者 + 協作者 + 公眾：\n公眾可以複製此旅程。","non-copyable":"不得複製：\n任何人都不能複製此旅程，包括旅程作者。","the authorized persons can":"被允許的人可以","cautious":"注意","this copyable setting is independent to enable trip and public trip.":"此「可複製」設定是獨立於「啟用旅程」和「公開的旅程」。",
"a trip can be copyable by the public, even if it is a private trip and disabled. it can also be public trip and non-copyable.":"即使旅程是「非公開」和「暫停使用」，你仍可以讓公眾複製此旅程。相反，即使旅程「已啟用」並「公開」，你亦可以禁止複製此旅程。","range to detect a checkpoint: 5 metres":"檢測定點的範圍：5米","range to detect a checkpoint: 10 metres":"檢測定點的範圍：10米","range to detect a checkpoint: 15 metres":"檢測定點的範圍：15米","range to detect a checkpoint: 20 metres":"檢測定點的範圍：20米","range to detect a checkpoint: 25 metres":"檢測定點的範圍：25米","range to detect a checkpoint: 50 metres":"檢測定點的範圍：50米",
"range to detect a checkpoint: 75 metres":"檢測定點的範圍：75米","range to detect a checkpoint: 100 metres":"檢測定點的範圍：100米","range to detect a checkpoint: 200 metres":"檢測定點的範圍：200米","range to detect a checkpoint: 1 km":"檢測定點的範圍：1公里","all checkpoints are accessible from the start, but their tasks are locked until stepping into the locations.":"所有的定點從開始旅程便開放；但定點的任務則被鎖定，直到參加者步入定點的位置。","checkpoints are locked until the previous checkpoint is stepped.\x0B(checkpoints must be stepped in order.)":"所有定點被鎖定，直到參加者步入上一個定點。（定點必須順序步入。）",
"checkpoints are locked until the previous checkpoint's tasks are completed.\x0B(checkpoints must be completed in order.)":"所有定點被鎖定，直到完成上一個定點的任務。（定點必須順序完成。）","checkpoints are locked until stepping into the locations.":"所有定點被鎖定，直到步入定點的位置。","all checkpoints & their tasks are accessible from the start.":"所有的定點及相關任務是從開始旅程便開放。","all checkpoints are accessible from the start, but their tasks are locked until the previous checkpoint is stepped.\x0B(checkpoints must be completed in order.)":"所有的定點從開始旅程便開放；但定點的任務則被鎖定，直到參加者步入上一個定點。（定點必須順序步入。）",
"checkpoints are locked until entering their passwords.":"所有定點被鎖定，直到輸入定點的密碼。","all checkpoints are accessible from the start, but their tasks are locked until entering the checkpoints' passwords.":"所有的定點從開始旅程便開放；但定點的任務則被鎖定，直到參加者輸入定點的密碼。","required in c.p. order?":"需要依定點次序","required gps?":"需要GPS","required password?":"需要密碼","coming soon":"尚未推出","if you change the rule, it is recommended any current participant to restart this trip.":"若更改旅程規則，建議現正進行本旅程的參加者重新開始此旅程。（「退出旅程」，然後再「開始旅程」。）","the checkpoints/tasks could also be unlocked by entering the checkpoints' passwords.":"參加者亦可輸入定點的密碼來解除定點或任務的鎖定。",
"map views":"地圖檢視","default map view":"預設檢視","available map views":"設定可使用的檢視","roadmap":"地圖 (Roadmap)","roadmap view":"地圖 (Roadmap)","satellite":"衛星檢視 (Satellite)","satellite view":"衛星檢視 (Satellite)","hybrid":"混合地圖 (Hybrid)","hybrid view":"混合地圖 (Hybrid)","terrain":"地形圖 (Terrain)","terrain view":"地形圖 (Terrain)","(satellite + labels)":"(衛星檢視+地名)","(contour lines)":"(等高線)","(google map's default)":"(Google 地圖的預設)","street view":"街景功能 (Street View)","roadmap displays the default road map view.":"顯示預設道路地圖檢視畫面",
"satellite displays google earth satellite images.":"顯示「Google 地球」衛星影像","hybrid displays a mixture of normal and satellite views.":"顯示衛星檢視和一般檢視 (道路、城市名稱) 的混合畫面","terrain displays a physical map based on terrain information.":"根據地形資訊顯示實際地圖，以展現地形高度和水域圖徵 (山嶽、河流等)","street view displays the street view control.":"啟用街景控制 (「街景小人」)","add":"新增","edit":"修改","delete":"刪除","reorder":"重新排列","checkpoint ordering":"定點次序","cp ordering":"定點次序","task ordering":"任務次序","ordering":"排序","return":"返回","return & save":"返回並儲存",
"please select":"請選擇","current location":"現時位置","true":"是（正確）","false":"否（不正確）","yes":"是","no":"否","name":"名稱","if applicable":"如適用","new checkpoint":"新定點","edit checkpoint":"修改定點","new task":"新任務","edit task":"修改任務","update pin":"更新地圖針","update (current location)":"更改為「現時位置」","closest checkpoints & tasks":"最接近的定點與任務","terms":"使用條款","click + to add the checkpoint to this trip.":"按 + 把定點加入到此旅程","add this checkpoint":"加入此定點","all checkpoints & tasks":"所有定點與任務","move up":"向上移","move down":"向下移","answer":"答案",
"answer type":"作答類型","click to complete":"按下按鈕完成任務","click here":"請按一下這裡","text":"文字題","single select":"多項選擇題 (單選)","multi select":"多項選擇題 (多選)","true/false":"是非題","get current geolocation":"擷取現時位置","camera / select image":"照相 / 選擇圖片","enter url":"輸入網址","task name, question or instruction":"任務名稱、問題或指示","(optional) information":"(可選填) 內容","e.g. images, links, readings, etc.":"例如：圖片、連結、閱讀文章......","add option":"新增選項","click to complete this task":"按下按鈕完成任務","click to get current geolocation":"按下按鈕，擷取現時位置",
"capture a photo":"拍照","select from library":"選擇現有圖片","click to capture a photo / select an image":"按下按鈕進行拍照/選擇圖片","the photo image will be resized to less than ":"照片圖像將被調整到小於",'the majority of mobile devices offer "using the camera" and "selecting an image", others only allow "selecting an image".':"大部分的移動裝置均提供「拍攝照片」功能或「選擇現有的圖片」，其他設備只可以「選擇現有的圖片」。","the entire map cannot contain more than 14 tasks of taking photos.":"整個旅程不能包含超過10個照片任務。","are you sure to delete this checkpoint?":"你是否確定刪除此定點？","are you sure to delete this task?":"你是否確定刪除此任務？",
"android users: to take a photo, after clicking [choose file] button, select [android system] > [camera].":"Android 使用者：如欲照相，按下「選擇檔案」按鈕後，選擇「Android系統」 > 「相機」。","ios users: this function is only available to ios6 or above.":"iOS使用者：此功能只適用於iOS6或以上系統。","ie users: this function is only available to ie10 or above.":"Internet Explorer使用者：此功能只適用IE 10或以上系統。","this function is not available to ios5 and ie9.":"此功能不適用於 iOS5 及 Internet Explorer 9。","it is suitable for tasks required the using of other websites.":"適合需要利用其他網站的任務",
'please close the "new Checkpoint".':"請關閉「新定點」。",'please close the "new Task".':"請關閉「新任務」。",'please enter checkpoint "name" and valid "latitude" and "longitude".':"請輸入定點「名稱」及有效的經緯度。",'please enter checkpoint "name".':"請輸入定點「名稱」。",'please enter valid "latitude" and "longitude".':"請輸入有效的經緯度。",'please enter "task name".':"請輸入「任務名稱」。",'please enter "task name" and "answer".':"請輸入「任務名稱」及「答案」。","once saved, the answer type cannot be changed.":"「作答類型」不能在儲存任務後更改。","gps is not available.":"定位系統 (GPS)無效 。",
"gps is yet accurate. please try again later.":"定位系統 (GPS)的定位準確度不足，請稍後再嘗試。","not support":"不支援","go to the link":"開啟網址","to quit this trip, please return to ":"如要退出旅程，請返回","click":"按下","to enter the checkpoint's password.":"輸入定點的密碼。","to open the checkpoints.":"打開定點。","to start completing the checkpoint's tasks.":"開始定點的任務。","to complete a checkpoint.":"作為完成該定點。","to collapse the content.":"收起/折疊內容。","when you have completed trip, ":"當你完成旅程，","to add a new checkpoint / task.":"新增一個定點/任務。","to edit the checkpoint / task.":"修改該定點/任務。",
"to delete the checkpoint / task.":"刪除該定點/任務。","to manage the checkpoint and its tasks.":"管理該定點及其任務。","to view the checkpoint and its tasks.":"瀏覽該定點及其任務。","to reorder the checkpoints.":"更改定點次序。","to move down the checkpoint.":"將定點向下移。","to move up the checkpoint.":"將定點向上移。","to return to checkpoint list and save the new orders.":"返回定點列表並儲存新的定點次序。","to quick view all checkpoints & tasks.":"快速瀏覽所有定點及任務。","to change the checkpoint to current location.":"更改該定點為「現時位置」","suggested track":"建議路徑","suggested boundary":"建議範圍",
"map boundary":"地圖範圍","track":"路徑","boundary":"範圍","plot":"標繪","to plot the map boundary or the suggested track:":"在地圖上標繪「範圍」或「建議路徑」：",'click "plot".':"按下「標繪」。","click the map to add points.":"點擊地圖加入「點」。","drag the points to adjust their position.":"拖曳「點」調整位置。",'when finish, click "complete" to avoid adding extra points accidentally.':"完成後，按下「完成」，以避免意外地增加額外的「點」。","add users":"新增使用者","add user(s)":"新增使用者","add collaborators":"新增協作者","add collaborator(s)":"新增協作者","all users":"所有使用者","collaborators":"協作者",
"fill in suitable field(s).":"請填寫適當的空格。","use semi-colon":"請使用英文分號","to seperate users.":"分隔使用者。","enter username":"請輸入使用者名稱","search tags":"搜尋標籤","add tags":"新增標籤","add tag(s)":"新增標籤","all tags":"所有標籤","school":"學校","project":"計劃","organization":"機構","key learning areas":"學習領域","kla":"學習領域","other learning experiences":"其他學習經歷","ole":"其他學習經歷","subjects":"科目","other tags":"其他標籤","to seperate tags.":"分隔標籤。","chinese language education":"中國語文教育","english language education":"英國語文教育","mathematics education":"數學教育",
"science education":"科學教育","technology education":"科技教育","personal, social & humanities education":"個人、社會及人文教育","arts education":"藝術教育","physical education":"體育","applied learning":"應用學習","liberal studies for senior secondary levels":"高中通識教育科","general studies for primary schools":"小學常識科","moral and national education":"德育及國民教育科","other learning experiences":"其他學習經歷","moral and civic education":"德育及公民教育","community service":"社會服務","career-related experiences":"與工作有關的經驗","aesthetic development":"藝術發展",
"physical development":"體育發展","timer":"計時器","trip timer":"旅程時計","start trip":"開始旅程","end trip":"結束旅程","quit trip":"退出旅程","pause":"暫停","resume":"繼續","reset":"重設","start time":"開始時間","end time":"結束時間","elapsed":"實耗","days":"日","day":"日","clear":"清除","submit":"習作呈交","personal information":"個人資料","participant name":"姓名","class":"班別","class no":"學號","complete":"完成","locked":"被鎖定","checkpoint is unlocked":"定點{cpOrder} ({name}) 已被解鎖！","you are near checkpoint":"你靠近定點{cpOrder}。","are you sure to submit?":"你是否確定呈交？",
"welcome to":"歡迎使用","please enter your name":"請輸入你的「姓名」","please enter your class":"請輸入你的「班別」","please enter your class no.":"請輸入你的「學號」",'please enter your "name", "class" and "class no."!':"請輸入你的「姓名」、「班別」、「學號」！","class no. must be a number.":"學號必須為數字。","please enter a password for viewing this submission within 24 hours.":"如欲在24小時內檢查此呈交習作，請輸入一個密碼。","the rule of this trip has been changed.":"此旅程的規則剛被更改。","it is recommended to restart this trip.":"請重新開始此旅程（「退出旅程」然後再「開始旅程」）。","update trip":"更新旅程","remove offline data":"移除離線旅程",
"participant":"參加者","all submissions":"所有參加者的習作","review all submissions":"檢查所有參加者呈交的習作","my trip":"我的旅程","no names":"佚名","review my trip":"查看我的習作","email all submissions":"電郵所有參加者的習作","email this submission":"電郵此習作","send":"寄送","sent!":"已寄出！","are you sure to delete this submission?":"你是否確定刪除此習作？","view":"瀏覽","quick view":"快速瀏覽","download":"下載","click here to download":"按此下載","save as":"另存為","english version only":"只提供英文版","click back to return.":"完成後，按 ＜ 回到上一頁","duplicate this map":"複製此旅程","duplicate trip":"複製旅程",
"duplicate trips":"複製旅程","duplicate":"複製","copyable trips":"可複製旅程","duplicable trips":"可複製旅程","duplicable trip":"可複製旅程","edit (bbcode)":"修改 (BBCode)","preview":"預覽","tips":"提示","username":"使用者名稱","password":"密碼","confirm password":"確認密碼","new password":"新密碼","current password":"現時密碼","forget password":"忘記密碼","reset password":"重設密碼","change password":"更改密碼","i have received the email.":"我已經收到相關電郵。","recovery code":"重設代碼 (Recovery Code)","at least 4 characters":"最少4個英文字","email":"電郵","email address":"電郵地址",
"account":"帳戶","ok":"確定","activate account":"啟動帳戶","activate code":"啟動代碼 (Activate Code)","account activated!":"成功啟動帳戶！","this account has already been activated before.":"此帳戶已曾經被啟動。","you can now login.":"你現在可以登入。","activate failed":"啟動帳戶失敗","must be a legit address":"必須為真實電郵地址","please activate your account.":"請先啟動你的帳戶。","an activate note has been sent to you.":"我們已寄出啟動帳戶的步驟。","the activate process will be expired in 3 days.":"請於3天內完成。","please enter password":"請輸入密碼","invalid format":"格式錯誤","invalid format.":"格式錯誤",
"please enter a school email":"請輸入你學校提供的電郵","accept email from hk educational organisations only":"只接受香港教育機構的電郵地址","email has been used":"電郵已被登記","username has been used":"使用者名稱已被登記","please enter at least 4 characters":"請輸入最少4個英文字","confirm password does not match the password":"確認密碼並不相同","please check your email.":"請檢查電郵。","a recovery note has been sent to you.":"我們已寄出重設密碼的步驟。","the reset process will be expired in 3 days.":"請於3天內完成。","reset failed":"重設失敗","required":"請填寫","wrong password":"密碼錯誤",
"please enter valid email.":"請輸入有效的電郵。","login fail":"登入失敗","sign up failed":"登錄不成功","reset failed":"重設失敗","password reset succeed!":"成功重設密碼","password change succeed!":"成功更改密碼","password change failed":"更改密碼失敗","language":"語言","language setting":"語言","gps":"定位系統 (GPS)","waiting... please allow the gps in the browser.":"等候中... 請允許瀏覽器使用定位。","click this button to start using gps in beyond campus":"按下按鈕重新啟用「移動學堂」的定位系統","gps is disabled.":"定位系統未啟用。","start using gps":"啟用定位系統 (GPS)","current language":"現時語言",
"switch to":"轉換為","unknown":"未知的","device":"裝置","platform":"平台","browser":"瀏覽器","is app":"是否應用程式 (App)","timezone":"時區","time zone":"時區","misc.":"其他","compass":"指南針","accuracy":"準確度","available":"可用的","location":"位置","locations":"位置","timestamp":"時間","gps timestamp":"定位時間戳記","waiting for a higher gps accuracy.":"正在等待較佳的定位準確度","m":"米","system reset":"重設系統","danger zone":"危險區","are you sure?":"你是否確定？","you will lose all your data, including logins, submission, etc...":"你將失去所有的資料，包括登錄、習作等等...","remove all data & reset":"刪除所有資料並重設",
"by clicking this button...":"當按下「重設系統」按鈕，","all data stored locally will be removed":"將會刪除所有儲存於本裝置的資料","any server data will not be removed":"不會刪除所有儲存於網路的資料","e.g.":"例如：","your login status,":"你的登入狀態、","your language preference,":"你的預設語言、","your recent trips,":"最近使用的旅程、","your trip notes,":"你的旅程筆記、","your started trip and the task answers,":"你進行中的旅程及旅程任務的作答、","your trip submissions;":"你的旅程習作；","your account,":"你的帳戶、","the trips you created or collaborated,":"你製作或協作的旅程、","participants' submissions.":"參加者的習作。",
"terms & statements":"條款","copyright":"版權","@info-tel":"3698 3740","@info-email":"ite@edb.gov.hk","under construction":"建構中","about us":"關於我們",'about "beyond campus"':"關於「移動學堂」",'link to "beyond campus"':"連結到「移動學堂」","qr code":"QR碼","site url":"網址","@info-aboutus-line1":"「移動學堂」是由教育局研發製作的電子教學工具。","@info-aboutus-line2":"教師可自行設計移動學習的電子課業，運用全球定位系統(GPS) 以顯示路線及開關所設定的任務。","@info-aboutus-line3":"適合校外活動時使用，例如：景點參觀、實地考察等。","@info-aboutus-line4":"活動舉偶：","@info-aboutus-line5":"中國語文教育：文學散步、文學素描、文化景點參觀","@info-aboutus-line6":"個人、社會及人文教育：地理實地考察、歷史及社區考察",
"@info-aboutus-line7":"科學教育：樹木研習、自然生態觀察","@info-aboutus-line8":"電子課業作答類型包括：","@info-aboutus-line9":"文字題、多項選擇題、是非題、擷取即時位置、照相或選擇圖片。","@info-aboutus-line10":"宜應用平板電腦或智能手機等移動裝置進行活動。","whats new":"更新消息","best viewed":"系統要求","@info-bestview-cat1":"桌上電腦 / 筆記簿電腦：","@info-bestview-cat1-screen":"解像度：1024x768 或 768x1024 或以上","@info-bestview-cat1-browser":"瀏覽器：Chrome 20、Firefox 14或Internet Explorer 9或以上","@info-bestview-cat2":"智能電話 / 平板電腦：","@info-bestview-cat2-screen":"熒幕尺寸：5吋或以上","@info-bestview-cat2-browser":"瀏覽器 (移動網頁版本)：iPad的Safari、Android的原生瀏覽器、Chrome、Firefox",
"@info-bestview-cat2-browser-warning":"* 如果使用Android的Chrome瀏覽器，將不能使用任何定位功能，直至Google修正其錯誤。","@info-bestview-cat2-device":"裝置 (應用程式App版本)：iPad (iOS 5或以上)、Android (2.3.4或以上, 4.1或以上) ","contact us":"聯絡我們","@info-contactus-line1":"查詢：","@info-contactus-line2":"教育局資訊科技教育組","@info-contactus-line3":"電話：{tel}","@info-contactus-line4":"電郵：{email}","terms & conditions":"使用條款","@info-terms":"本教學資源由教育局研發製作，免費提供給教師在香港作學與教用途。本教學資源的版權均屬香港特別行政區政府所有，如未獲書面授權，不可複製、改編、分發、發布或使用本教學資源作商業用途。如有查詢，請致電 {tel} 或電郵 {email} 與教育局資訊科技教育組聯絡。",
"privacy policy statement (pps)":"私隱政策聲明","privacy policy":"私隱政策聲明","disclaimer":"免責聲明","@info-disclaimer-line1":"「移動學堂」網站（下稱「本網站」）由香港特別行政區政府教育局研發製作。閣下確認並同意，倘若閣下決定瀏覽或使用本網站提供的服務，閣下須自行承擔一切風險。教育局不會對任何因瀏覽或使用本網站而引起或與此關連或在其他方面有聯繫的損失或損害承擔責任。","@info-disclaimer-line2":"教育局承諾力求網站內容的準確性及完整性，但不會對內容有錯誤或遺漏承擔責任，亦不就此承擔任何損失及賠償責任。","faq":"常見問題","@info-faq-tripicon":"旅程圖示：旅程的相關屬性","my trips":"我的旅程","trip status":"旅程狀態","participants":"參加者","change your trip's status":"更改旅程的狀態","change your trip's settings":"更改旅程的設定",
"change your trip's language":"更改旅程的語言","add collaborators to your trip":"新增協作者","@info-faq-tripstatus-disable":"此旅程被設為暫停使用。","@info-faq-tripstatus-public":"公眾可以搜尋並使用此旅程。","@info-faq-tripstatus-public-cc":"公眾需依照「共享創意」分享條款製作衍生作品","@info-faq-tripstatus-public-cc2":"署名 - 非商業性 - 相同方式分享 (CC BY-NC-SA)","@info-faq-tripstatus-private":"參加者需要使用「旅程代號」抓取此旅程，不可以搜尋此旅程。","@info-faq-tripstatus-private-password":"作者/協作者亦可於輸入一個密碼。設定密碼後，參加者需要使用「旅程代號」抓取旅程，並輸入「密碼」，才能開始旅程。","@info-faq-select-true":"選擇「是」（✔）","@info-faq-select-false":"選擇「否」（✘）",
"the resulting work must":"衍生作品必須","attribute the author,":"標示原作者，","share under beyond campus,":"是一個「移動學堂」的旅程及只能於「移動學堂」內分享，","be noncommercial.":"不得作商業用途。","use of gps":"使用定位系統 (GPS)","enable location service of the device":"啟用裝置的定位服務","@info-gps-enable":"您必須啟用定位服務，才能擷取你的位置，及於地圖中顯示您的位置。","@info-gps-android-enable-2.3.4":"設定 » 位置及安全性 » 我的位置 » ","@info-gps-android-enable-4.1":"設定 » 個人 » 地點服務 » ","@info-gps-ios-enable-ios6":"設定 » 私隱 » 定位服務 » ","@info-gps-ios-enable-ios5":"設定 » 定位服務 » ","@info-gps-ios-enable-ipad":"設定 » 私隱 » 定位服務 » ",
"@info-gps-ios-enable-iphone":"設定 » 定位服務 » ","@info-gps-ios-enable-ipt":"設定 » 定位服務 » ","@info-gps-ie-enable":"網際網路選項 » 隱私權 » 位置 » ","@info-gps-chrome-enable":"Chrome 選單 » 設定 » 顯示進階設定 » [隱私權] 部分 » 內容設定 » [位置] 部分 » ","turn on":"開啟","tick":"選取","select":"選取","desktop / laptop":"桌上電腦 / 筆記簿電腦","use wireless networks":"使用無線網絡","use gps satellites":"使用GPS衛星定位","access to my location":"存取我的位置資訊","gps satellites":"GPS衛星定位","google's location service":"Google的定位服務","location services":"定位服務","your choice of web browser, eg. safari":"你所使用的瀏覽器，如：Safari",
"never allow websites to request your physical location":"永遠不允許網站要求您的所在位置","allow all sites to track my physical location":"允許所有網站追蹤我的實際位置","ask me when a site tries to track my physical location":"當某個網站嘗試要追蹤我的實際位置時，請詢問我","enabled as default":"預設已啟用","or":"或","wifi connection must be enabled.":"需開啟無線網路(wifi)","prerequisite":"前提條件","allow this site using the location service":"允許「移動學堂」使用定位服務","@info-gps-site":"進入本網站，當瀏覽器彈出「分享位置」的詢問，允許本網站使用定位。","references":"參考資料","downloads":"下載區"};window.MapModel=Backbone.Model.extend({idAttribute:"mapKey",defaults:{id:null,mapKey:null,name:"new trip",description:"",language:"en",mapCentre_lat:22.311655551189443,mapCentre_lng:114.18884912812496,mapCentre_zoom:12,isEnable:false,isPublic:false,privateKey:"",isDuplicable:1,submission:false,cpRange:50,rule:0,mapTypeDefault:"roadmap",mapTypes:'["roadmap","terrain","satellite","hybrid"]',mapTypeStreet:true,plotBoundary:null,plotTrack:null,ownerID:1,createDate:null,creatorName:"",lastUpdate:null,
lastUpdateTS:null,lastUpdateBy:0,isWarning:false,warningText:""},offlineStorage:function(){if(this.isNew())return null;else return{folder:"map",filename:this.id+".txt"}},url:function(){if(this.isNew())return rootURL+"/map";else return rootURL+"/map/"+this.id},validate:function(attrs){if(attrs.creatorID!=null)if(attrs.name=="")return"please enter name";else if(attrs.creatorName=="")return"please enter author"},mapAttributes:function(){return{canPlan:this.canPlan(),canPre:this.canPre(),canTrip:this.canTrip(),
canAfter:this.canAfter(),isOpenedMap:this.isOpenedMap(),isFavMap:this.isFavMap(),isCreator:this.isCreator(),isCollaborator:this.isCollaborator(),isEnable:this.isEnable(),isPublic:this.isPublic(),isSubmitted:this.isSubmitted(),isDuplicable:this.isDuplicable(),isWarning:this.isWarning()}},canPlan:function(){return this.isCreator()||this.isCollaborator()},canPre:function(){return this.isCreator()||this.isCollaborator()},canTrip:function(){return this.isEnable()},canAfter:function(){return this.isCreator()||
this.isCollaborator()||this.isSubmitted()},isOpenedMap:function(){return $.inArray(this.id,user.mapHistory())>=0},isFavMap:function(){return $.inArray(this.id,user.favMaps())>=0},isCreator:function(){return user.get("userID")==this.get("ownerID")},isCollaborator:function(){if(this.get("collaborators")==null)return false;return $.inArray(user.get("account").toLowerCase(),this.get("collaborators").toLowerCase().split(";"))>=0},isDuplicable:function(){if(user.isLogined()){var _canCopy=this.get("isDuplicable");
if(_canCopy>=4)return true;if(_canCopy>=1&&this.isCreator())return true;if(_canCopy>=2&&this.isCollaborator())return true}return false},isEnable:function(){return this.get("isEnable")==true},isPublic:function(){return this.get("isPublic")==true},enableSubmit:function(){return this.get("submission")==true},needPrivateKey:function(){return!this.isPublic()&&this.get("privateKey")!=""&&this.get("privateKey")!=null},isSubmitted:function(){return tripCollection.where1({submitted:true,mapKey:this.id})!=
null},isWarning:function(){return this.get("isWarning")==true},parse:function(response,opt){response.isEnable=Convert.ToBoolean(response.isEnable);response.isPublic=Convert.ToBoolean(response.isPublic);response.isDuplicable=Convert.ToInt(response.isDuplicable);response.submission=Convert.ToBoolean(response.submission);response.mapTypeStreet=Convert.ToBoolean(response.mapTypeStreet);response.mapTypes=response.mapTypes==null?this.defaults.mapTypes:response.mapTypes;response.mapCentre_zoom=Convert.ToInt(response.mapCentre_zoom);
response.rule=Convert.ToInt(response.rule);response.cpRange=Convert.ToInt(response.cpRange);response.lastUpdateTS=Convert.ToDateTime(response.lastUpdateTS,true);response.isWarning=Convert.ToBoolean(response.isWarning);return response},gsmap:function(){var _url_loc="center="+this.get("mapCentre_lat")+","+this.get("mapCentre_lng")+"&zoom="+(this.get("mapCentre_zoom")-1);var _url_size="size="+430/2+"x"+360/2;var _url_maptype="maptype=roadmap";var _url="http://maps.googleapis.com/maps/api/staticmap?"+
_url_loc+"&"+_url_size+"&"+_url_maptype+"&sensor=false";return _url}});window.MapCentreModel=Backbone.Model.extend({defaults:{lat:0,lng:0,zoom:1}});
window.MapCollection=Backbone.Collection.extend({model:MapModel,initialize:function(){this.fetchParams=$.extend({},this.fetchParams)},fetchParams:{keys:null,submitKeys:null,userID:null,permit:null,searchText:null,maxItems:null,start:null},resetParams:function(){var self=this;$.each(this.fetchParams,function(key){self.fetchParams[key]=null})},hasMore:function(){return this.length>=this.fetchParams.maxItems},where1:function(attributes){var result=this.where(attributes);return result.length==0?null:
result[0]},url:function(){var _url=rootURL+"/maps?";if(this.fetchParams.keys!=null)_url+="keys="+this.fetchParams.keys.join(",")+"&";if(this.fetchParams.submitKeys!=null)_url+="submitKeys="+this.fetchParams.submitKeys.join(",")+"&";if(this.fetchParams.userID!=null)_url+="userID="+this.fetchParams.userID+"&";if(this.fetchParams.permit!=null)_url+="permit="+this.fetchParams.permit+"&";if(this.fetchParams.searchText!=null)_url+="search="+encodeURIComponent(this.fetchParams.searchText)+"&";if(this.fetchParams.maxItems!=
null){_url+="max="+this.fetchParams.maxItems+"&";if(this.fetchParams.start!=null)_url+="start="+this.fetchParams.start+"&"}return _url}});window.MapUserModel=Backbone.Model.extend({defaults:{mapID:null,account:null,post:0,createDate:null,createDateTS:null,creatorID:null},url:function(){if(this.isNew())return rootURL+"/mapuser";else return rootURL+"/mapuser/"+this.id},validate:function(attrs){if(attrs.mapID==null||attrs.account==null)return""},parse:function(response,opt){response.mapID=Convert.ToInt(response.mapID);response.creatorID=Convert.ToInt(response.creatorID);response.post=Convert.ToInt(response.post);response.createDateTS=
Convert.ToDateTime(response.createDateTS,true);if(response.post>2||response.post<0)response.post=0;return response}});
window.MapUserCollection=Backbone.Collection.extend({model:MapUserModel,initialize:function(){this.fetchParams=$.extend({},this.fetchParams)},fetchParams:{mapKey:null,mapID:null,account:null},resetParams:function(){var self=this;$.each(this.fetchParams,function(key){self.fetchParams[key]=null})},url:function(){var _url=rootURL+"/mapusers?";if(this.fetchParams.mapKey!=null)_url+="mapKey="+this.fetchParams.mapKey+"&";if(this.fetchParams.mapID!=null)_url+="mapID="+this.fetchParams.mapID+"&";if(this.fetchParams.account!=
null)_url+="account="+this.fetchParams.account+"&";return _url}});window.MapTagModel=Backbone.Model.extend({defaults:{mapID:null,text:"",type:0,createDate:null,createDateTS:null},url:function(){if(this.isNew())return rootURL+"/maptag";else return rootURL+"/maptag/"+this.id},validate:function(attrs){if(attrs.text=="")return"please enter name"},parse:function(response,opt){response.mapID=Convert.ToInt(response.mapID);response.type=Convert.ToInt(response.type);response.createDateTS=Convert.ToDateTime(response.createDateTS,true);if(response.type>5||response.type<0)response.type=
0;return response}});window.MapTagCollection=Backbone.Collection.extend({model:MapTagModel,initialize:function(){this.fetchParams=$.extend({},this.fetchParams)},fetchParams:{mapKey:null,mapID:null},resetParams:function(){var self=this;$.each(this.fetchParams,function(key){self.fetchParams[key]=null})},url:function(){var _url=rootURL+"/maptags?";if(this.fetchParams.mapKey!=null)_url+="mapKey="+this.fetchParams.mapKey+"&";if(this.fetchParams.mapID!=null)_url+="mapID="+this.fetchParams.mapID+"&";return _url}});window.CheckpointModel=Backbone.Model.extend({defaults:{mapID:null,cpOrder:null,lat:0,lng:0,name:null,description:null,createDate:null,lastUpdate:null,lastUpdateTS:null,creatorID:null,lastUpdateBy:null,password:null},url:function(){if(this.isNew())return rootURL+"/cp";else return rootURL+"/cp/"+this.id},validate:function(attrs){if(attrs.creatorID!=null)if(attrs.name=="")return dict('Please enter checkpoint "name".')},parse:function(response,opt){response.mapID=Convert.ToInt(response.mapID);response.creatorID=
Convert.ToInt(response.creatorID);response.lastUpdateBy=Convert.ToInt(response.lastUpdateBy);response.cpOrder=Convert.ToInt(response.cpOrder);response.lastUpdateTS=Convert.ToDateTime(response.lastUpdateTS,true);response.password=cpPassword(Convert.ToInt(response.id),response.mapID);return response},distance:function(lat2,lng2){if(lat2==null||lng2==null){if(appFunc.geolocation==null)return null;lat2=appFunc.geolocation.lat;lng2=appFunc.geolocation.lng}var R1=6371;var R=6371E3;var lat1=Convert.ToFloat(this.get("lat")).toRad();
var lng1=Convert.ToFloat(this.get("lng")).toRad();lat2=Convert.ToFloat(lat2).toRad();lng2=Convert.ToFloat(lng2).toRad();var d=Math.acos(Math.sin(lat1)*Math.sin(lat2)+Math.cos(lat1)*Math.cos(lat2)*Math.cos(lng2-lng1))*R;return d},withinDistance:function(rangeInMetre,lat2,lng2){var d=this.distance(lat2,lng2);if(d==null)return false;if(d<=rangeInMetre){this.trigger("near");return true}this.trigger("far");return false}});
window.CheckpointCollection=Backbone.Collection.extend({model:CheckpointModel,initialize:function(){this.fetchParams=$.extend({},this.fetchParams)},fetchParams:{mapKey:null,mapID:null,excludeKey:null,lat:null,lng:null,searchRange:null,searchText:null,maxItems:null,start:null},resetParams:function(){var self=this;$.each(this.fetchParams,function(key){self.fetchParams[key]=null})},hasMore:function(){var start=this.fetchParams.start||0;if(this.fetchParams.maxItems!=null)if(this.length>=start+this.fetchParams.maxItems)return true;
return false},where1:function(attributes){var result=this.where(attributes);return result.length==0?null:result[0]},offlineStorage:function(){var _url="";if(this.fetchParams.mapKey!=null)_url+="-"+"mapKey_"+this.fetchParams.mapKey;if(this.fetchParams.mapID!=null)_url+="-"+"mapID_"+this.fetchParams.mapID;return{folder:"cps",filename:"cps"+_url+".txt",dbID:this.fetchParams.mapKey}},url:function(){var _url=rootURL+"/cps?";if(this.fetchParams.mapKey!=null)_url+="mapKey="+this.fetchParams.mapKey+"&";if(this.fetchParams.mapID!=
null)_url+="mapID="+this.fetchParams.mapID+"&";if(this.fetchParams.lat!=null&&this.fetchParams.lng!=null){_url+="lat="+this.fetchParams.lat+"&";_url+="lng="+this.fetchParams.lng+"&";if(this.fetchParams.searchRange!=null)_url+="searchRange="+this.fetchParams.searchRange+"&"}if(this.fetchParams.searchText!=null)_url+="search="+encodeURIComponent(this.fetchParams.searchText)+"&";if(this.fetchParams.excludeKey!=null)_url+="excludeKey="+this.fetchParams.excludeKey+"&";if(this.fetchParams.maxItems!=null){_url+=
"max="+this.fetchParams.maxItems+"&";if(this.fetchParams.start!=null)_url+="start="+this.fetchParams.start+"&"}return _url}});window.TaskModel=Backbone.Model.extend({defaults:{cpID:null,mapID:null,taskOrder:null,question:null,question2:null,answerType:1,answer:null,answerOptions:null,createDate:null,lastUpdate:null,lastUpdateTS:null,creatorID:null,lastUpdateBy:null},url:function(){if(this.isNew())return rootURL+"/task";else return rootURL+"/task/"+this.id},validate:function(attrs){if(attrs.creatorID!=null)if(attrs.question=="")return dict('Please enter "task name".')},parse:function(response,opt){response.cpID=Convert.ToInt(response.cpID);
response.mapID=Convert.ToInt(response.mapID);response.answerType=Convert.ToInt(response.answerType);if(response.answerType==4)response.answer=Convert.ToBoolean(response.answer);response.creatorID=Convert.ToInt(response.creatorID);response.lastUpdateBy=Convert.ToInt(response.lastUpdateBy);response.taskOrder=Convert.ToInt(response.taskOrder);response.lastUpdateTS=Convert.ToDateTime(response.lastUpdateTS,true);return response}});
window.TaskCollection=Backbone.Collection.extend({model:TaskModel,initialize:function(){this.fetchParams=$.extend({},this.fetchParams)},fetchParams:{mapKey:null,mapID:null,cpID:null},resetParams:function(){var self=this;$.each(this.fetchParams,function(key){self.fetchParams[key]=null})},whereCP:function(cpID){return this.where({cpID:cpID})},where1:function(attributes){var result=this.where(attributes);return result.length==0?null:result[0]},offlineStorage:function(){var _url="";if(this.fetchParams.mapKey!=
null)_url+="-"+"mapKey_"+this.fetchParams.mapKey;if(this.fetchParams.mapID!=null)_url+="-"+"mapID_"+this.fetchParams.mapID;if(this.fetchParams.cpID!=null)_url+="-"+"cpID_"+this.fetchParams.cpID;return{folder:"tasks",filename:"tasks"+_url+".txt"}},url:function(){var _url=rootURL+"/tasks?";if(this.fetchParams.mapKey!=null)_url+="mapKey="+this.fetchParams.mapKey+"&";if(this.fetchParams.mapID!=null)_url+="mapID="+this.fetchParams.mapID+"&";if(this.fetchParams.cpID!=null)_url+="cpID="+this.fetchParams.cpID+
"&";return _url}});window.SystemModel=Backbone.Model.extend({defaults:{device:"unknown",version:null,isApp:false,isAppIOS:false,iOS:false,android:false,browser:null,contentEditable:true,watchID_geolocation:null,watchID_compass:null,offlineReady:false,gmapReady:false},geolocation2:null,geolocation:null,compass:null,initialize:function(){var uaBrowser={"MSIE":/(msie)/i,"Firefox":/(firefox)/i,"Chrome":/((chrome)|(crios))/i,"Opera Mini":/(opera mini)/i,"Opera":/(opera)/i,"Safari":/(safari)/i,"WebKit":/(webkit)/i};var uaPlatform=
{"iOS":/((iphone)|(ipod)|(ipad))/i,"Android":/(android)/i,"Windows":/(windows)/i,"Mac":/(mac)/i};var self=this;try{if(cordova){this.set("isApp",true);if(typeof navigator.device=="undefined")document.addEventListener("deviceready",_.bind(this.phonegapReady,this),false);else this.phonegapReady()}}catch(err){}var ua=navigator.userAgent;$.each(uaPlatform,function(platformname,re){try{if(re.test(ua)){self.set("device",platformname);return false}}catch(err){}});switch(this.get("device")){case "Android":this.set("android",
true);break;case "iOS":this.set("iOS",true);break}$.each(uaBrowser,function(browsername,re){try{if(re.test(ua)){self.set("browser",browsername);return false}}catch(err){}});if(this.get("android")&&this.get("browser")=="Safari")this.set("browser","Default");if(this.get("android")||this.get("iOS")||$.browser.opera)this.set("contentEditable",false);if(this.get("device")==this.defaults.device&&!this.isApp());try{if(window["google"]&&google.maps)this.set("gmapReady",true)}catch(err){}if(!this.isApp())if(this.get("android")&&
this.get("browser")=="Chrome");else this.listenToGeolocation()},phonegapReady:function(){this.set("device",device.platform);if(this.isApp()&&$.inArray(device.platform,["iOS","iPad","iPhone","iPad Simulator","iPhone Simulator"])>-1)this.set("isAppIOS",true);document.addEventListener("resume",_.bind(this.phonegapResume,this),false);document.addEventListener("pause",_.bind(this.phonegapPause,this),false);this.loadOffline();this.listenToGeolocation();this.listenToCompass()},phonegapPause:function(){var self=
this;if(this.isApp()&&this.get("watchID_geolocation")!=null){navigator.geolocation.clearWatch(self.get("watchID_geolocation"));self.set("watchID_geolocation",null)}},phonegapResume:function(){if(this.isApp()&&this.get("watchID_geolocation")==null)this.listenToGeolocation()},isApp:function(){return this.get("isApp")},isGMapReady:function(){return this.get("gmapReady")},isOfflineReady:function(){return this.get("offlineReady")},loadGMap:function(){var script=document.createElement("script");script.type=
"text/javascript";script.src="http://maps.googleapis.com/maps/api/js?sensor=false&language=en&libraries=places&"+"callback=appFunc.loadGMapReady";document.body.appendChild(script)},loadGMapReady:function(){try{if(window["google"]&&google.maps){this.set("gmapReady",true);$("#page-home .home-menu-outer.error").removeClass("error")}}catch(err){}},loadOffline:function(){var self=this;if(!self.isApp())return;function dbReady(){try{self.set({offlineReady:true})}catch(err){}var ok=false;try{if(appRouter._content&&
appRouter._content instanceof window.HomeView)if(appRouter._content.subviews["recentMaps"]!=null){appRouter._content.subviews["recentMaps"].load();ok=true}}catch(err){}try{if(!ok&&appRouter.content&&appRouter.content instanceof window.HomeView)if(appRouter.content.subviews["recentMaps"]!=null)appRouter.content.subviews["recentMaps"].load()}catch(err2){}}var db=window.openDatabase("beyondcampus","","Beyond Campus",2*1E3*1E3);self.db=db;if(db.version==""||db.version=="1.0"){var oldVersion=db.version;
db.changeVersion(db.version,"1.1",function(tx){tx.executeSql("CREATE TABLE IF NOT EXISTS MAP (id INTEGER PRIMARY KEY, mapKey TEXT, name TEXT, description TEXT, language INTEGER TEXT, lastUpdate DATETIME, logDate DATETIME)",[]);tx.executeSql("CREATE TABLE IF NOT EXISTS CPS (mapKey TEXT PRIMARY KEY, logDate DATETIME)",[],dbReady)})}else dbReady()},listenToGeolocation:function(){if(this.get("watchID_geolocation")!=null)return;var self=this;var isWinFF=this.get("device")=="Windows"&&this.get("browser")==
"Firefox";if(false&&this.isApp()){var watchID=navigator.geolocation.watchPosition(function getCurrLoc_success(position){try{try{if(position.coords.accuracy>200){self.geolocation2={lat:position.coords.latitude,lng:position.coords.longitude,timestamp:this.get("isAppIOS")==true?position.timestamp*1E3:position.timestamp,accuracy:position.coords.accuracy,logTime:(new Date).getTime()};return}}catch(err){}self.geolocation={lat:position.coords.latitude,lng:position.coords.longitude,timestamp:this.get("isAppIOS")==
true?position.timestamp*1E3:position.timestamp,accuracy:null,logTime:(new Date).getTime()};try{self.geolocation.accuracy=position.coords.accuracy}catch(err){}self.trigger("GeolocationEvent",{name:"geolocationUpdated"})}catch(err){self.geolocation=null}},function getCurrLoc_failure(err){var msg="";if(err.code==err.PERMISSION_DENIED){self.trigger("GeolocationEvent",{name:"accessDenied"});navigator.geolocation.clearWatch(self.get("watchID_geolocation"));self.set("watchID_geolocation",null)}else if(err.code==
err.POSITION_UNAVAILABLE)self.trigger("GeolocationEvent",{name:"positionUnavailable"});else if(err.code==err.TIMEOUT){self.trigger("GeolocationEvent",{name:"timeout"});navigator.geolocation.clearWatch(self.get("watchID_geolocation"));self.set("watchID_geolocation",null)}else if(err.code==err.UNKNOWN_ERROR)self.trigger("GeolocationEvent",{name:"unknownError"});else;},{enableHighAccuracy:true,timeout:3E4,maximumAge:1E3});this.set("watchID_geolocation",watchID)}else if("geolocation"in navigator){var watchID=
navigator.geolocation.watchPosition(function getCurrLoc_success(position){try{try{if(position.coords.accuracy>200){self.geolocation2={lat:position.coords.latitude,lng:position.coords.longitude,timestamp:position.timestamp,accuracy:position.coords.accuracy,logTime:(new Date).getTime()};return}}catch(err){}self.geolocation={lat:position.coords.latitude,lng:position.coords.longitude,timestamp:position.timestamp,accuracy:null,logTime:(new Date).getTime()};try{self.geolocation.accuracy=position.coords.accuracy}catch(err){}self.trigger("GeolocationEvent",
{name:"geolocationUpdated"});if(position.coords.heading!=null&&!_.isNaN(position.coords.heading)){self.compass={orientation:position.coords.heading,timestamp:position.timestamp};$(".compass").trigger("CompassEvent",{name:"compassUpdated"})}else self.compass=null}catch(err){self.geolocation=null;self.compass=null}},function getCurrLoc_failure(err){var msg="";if(err.code==err.PERMISSION_DENIED){self.trigger("GeolocationEvent",{name:"accessDenied"});navigator.geolocation.clearWatch(self.get("watchID_geolocation"));
self.set("watchID_geolocation",null)}else if(err.code==err.POSITION_UNAVAILABLE)self.trigger("GeolocationEvent",{name:"positionUnavailable"});else if(err.code==err.TIMEOUT){self.trigger("GeolocationEvent",{name:"timeout"});navigator.geolocation.clearWatch(self.get("watchID_geolocation"));self.set("watchID_geolocation",null)}else if(err.code==err.UNKNOWN_ERROR)self.trigger("GeolocationEvent",{name:"unknownError"});else;},{enableHighAccuracy:!isWinFF,timeout:3E4,maximumAge:1E3});this.set("watchID_geolocation",
watchID)}else;},listenToCompass:function(){if(this.get("watchID_compass")!=null)return;if(this.isApp());else;},hasNetwork:function(){if(this.isApp()){var networkState=navigator.network.connection.type;return!(networkState==Connection.NONE)}return true},alert:function(msg){if(this.isApp())navigator.notification.alert(msg,function(){});else alert(msg)},confirm:function(msg){if(false&&this.isApp())return navigator.notification.confirm(msg,function(){});else return confirm(msg)},quit:function(){if(this.isApp())if(device.platform==
"iPhone")navigator.notification.alert('Press "Home" button to exit.',function(){},"Friendly Reminder");else if(device.platform=="Android")if(navigator.app.exitApp)navigator.app.exitApp();else navigator.notification.alert('Press "Home" button to exit.',function(){},"Friendly Reminder");else navigator.notification.alert('Press "Home" button to exit.',function(){},"Friendly Reminder")},hasQuitFunc:function(){if(this.isApp())if(navigator.app.exitApp)return true;return false},canCaptureImage:function(){try{return window.File&&
window.FileList&&window.FileReader}catch(e){return false}},canTouch:function(){try{document.createEvent("TouchEvent");return true}catch(e){return false}},canDrop:function(){try{document.createEvent("drop");return true}catch(e){return false}},canDragEnter:function(){try{document.createEvent("dragenter");return true}catch(e){return false}},notSupport:function(){if(this.isApp());else if($.browser.msie){if(parseInt($.browser.version,10)<=8)return true}else if(this.get("browser")=="Opera Mini")return true;
return false}});siteInfo=new SystemModel;appFunc=siteInfo;window.UserModel=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("user"),accountObj:null,initialize:function(){},defaults:{name:"",account:"",oauth_service:"",account_id:"",userID:null,mapHistory:[],favMaps:[],lang:1033,loginDate:null,sided:null},addMap:function(mapKey){var arr=this.get("mapHistory");var pos=$.inArray(mapKey,arr);while(pos>=0){arr.splice(pos,1);pos=$.inArray(mapKey,arr)}arr.unshift(mapKey);this.save("mapHistory",arr)},favMaps:function(){return this.get("favMaps")},mapHistory:function(){return this.get("mapHistory")},
recentMaps:function(){var arr=this.get("mapHistory");return arr.slice(0,5)},validate:function(attrs){},oauth_logout:function(){this.save({account:"",oauth_service:"",account_id:"",userID:null,loginDate:null})},isLogined:function(){return this.get("account")!=""&&this.get("userID")!=null},lang:function(_lang){if(_lang!=null)if(DICT[_lang]!=null)this.save("lang",_lang);return this.get("lang")}});
window.AccountModel=Backbone.Model.extend({defaults:{email:"",oldPassKey:"",passKey:"",account:"",service:"Direct",success:false,error:false,errorCode:0,id:null,recoveryPass:null,recoveryDate:null,activePass:null}});window.AccountModel_Validate=window.AccountModel.extend({url:function(){return rootURL+"/accounts/validate/"+encodeURIComponent(this.get("account"))+"/"+encodeURIComponent(this.get("email"))}});window.AccountModel_Forget=window.AccountModel.extend({url:function(){return rootURL+"/accounts/forget"}});
window.AccountModel_Reg=window.AccountModel.extend({url:function(){return rootURL+"/accounts/signup"}});window.AccountModel_Reset=window.AccountModel.extend({url:function(){return rootURL+"/accounts/reset"}});window.AccountModel_Activate=window.AccountModel.extend({url:function(){return rootURL+"/accounts/activate"}});window.AccountModel_ChangePwd=window.AccountModel.extend({url:function(){return rootURL+"/accounts/changepwd"}});
window.AccountModel_Login2=window.AccountModel.extend({url:function(){return rootURL+"/accounts/login"}});window.AccountModel_Login=window.AccountModel.extend({url:function(){return rootURL+"/accounts/login/"+encodeURIComponent(this.get("account"))+"/"+encodeURIComponent(this.get("passKey"))}});user=new UserModel({id:1});
user.fetch({success:function(){if(user.isLogined()){var loginDate=user.get("loginDate");if(loginDate==null)user.save({"loginDate":new Date});else{var d1=new Date(loginDate);var d2=new Date;d2.setDate(d2.getDate()-0.5);if(d2>d1)user.oauth_logout()}}}});window.PageModel=Backbone.Model.extend({defaults:{page:"",title:"",header:"",content:""}});window.PageCollection=Backbone.Collection.extend({model:PageModel,where1:function(attributes){var result=this.where(attributes);return result.length==0?null:result[0]}});
window.PageInterface={modelEvents:null,collectionEvents:null,initializeBoundFunc:function(){_.bindAll(this)},removeBoundFunc:function(){},bindModelAndCollection:function(){if(this.model!=null&&!_.isEmpty(this.modelEvents))_.each(this.modelEvents,function(value,key){this.model.on(key,this[value],this)},this);if(this.collection!=null&&!_.isEmpty(this.collectionEvents))_.each(this.collectionEvents,function(value,key){this.collection.on(key,this[value],this)},this)},unbindModelAndCollection:function(){if(this.model!=
null&&!_.isEmpty(this.modelEvents))_.each(this.modelEvents,function(value,key){this.model.off(key,this[value],this)},this);if(this.collection!=null&&!_.isEmpty(this.collectionEvents))_.each(this.collectionEvents,function(value,key){this.collection.off(key,this[value],this)},this)},init:function(){},load:function(){},loadSubviews:function(){},unloadSubviews:function(){if(this.subviews!=null&&!_.isEmpty(this.subviews))_.each(this.subviews,function(value,key){if(value!=null)if(value instanceof Backbone.View){value.remove();
this.subviews[key]=null}},this)}};
window.PageView=Backbone.View.extend(_.extend({viewEl:"#content",el:"#content",initialize:function(){if(this.viewEl=="#content")appRouter._content=this;else if(this.viewEl=="#header")appRouter._header=this;this.subviews={};this.initializeBoundFunc();this.init();this.bindModelAndCollection();this.render();this.load();this.loadSubviews();if($("textarea.webedit",this.el).length>0)$("textarea.webedit",this.el).webedit()},render:function(){return this.render2()},render2:function(obj,obj2){if($(this.el).length==
0)this.$el.html($(this.viewEl,this.template(obj,obj2)).html());else $(this.el).html($(this.viewEl,this.template(obj,obj2)).html());return this},render3:function(viewEl2,obj,obj2){$(viewEl2,this.el).html($(this.viewEl,this.template(obj,obj2)).find(viewEl2).html());return this},unrender:function(){},remove:function(){this.removeBoundFunc();this.unbindModelAndCollection();this.unloadSubviews();this.undelegateEvents();this.unrender();$(this.el).empty()}},window.PageInterface));
window.PageView_SubView=Backbone.View.extend(_.extend({viewEl:"#content",el:"#content",parentView:null,parent:null,initialRender:false,initialize:function(){this.subviews={};if(this.parentView)this.template=_.template(templateLoader.templates[this.parentView]);this.initializeBoundFunc();this.init();this.bindModelAndCollection();if(this.initialRender)this.render();this.load();this.loadSubviews();if($("textarea.webedit",this.el).length>0)$("textarea.webedit",this.el).webedit()},render:function(){return this.render2()},
render2:function(obj){var newEl=$(this.viewEl,this.template(obj));$(this.el).html(newEl.html());$(this.el).attr("class",newEl.attr("class"));return this},render3:function(viewEl2,obj,obj2){$(viewEl2,this.el).html($(this.viewEl,this.template(obj,obj2)).find(viewEl2).html());return this},rerender:function(){this.remove();this.render();this.delegateEvents()},remove:function(){this._remove()},_remove:function(){this.removeBoundFunc();this.unbindModelAndCollection();this.unloadSubviews();this.undelegateEvents();
$(this.el).empty()}},window.PageInterface));(function($){window.MapInterface={mapCanvas_getCentre:function(){var mapcentre=this.map().getCenter();var obj={"mapCentre_lat":mapcentre.lat(),"mapCentre_lng":mapcentre.lng(),"mapCentre_zoom":this.map().getZoom()};return obj},mapCanvas_setCentre:function(pos){if(this.map()!=null)this.map().setOptions({center:new google.maps.LatLng(pos["mapCentre_lat"],pos["mapCentre_lng"]),zoom:parseInt(pos["mapCentre_zoom"],10)});else this._map=new google.maps.Map($("#mapCanvas",this.el)[0],{center:new google.maps.LatLng(pos["mapCentre_lat"],
pos["mapCentre_lng"]),zoom:parseInt(pos["mapCentre_zoom"],10),mapTypeId:this.model.get("mapTypeDefault"),scaleControl:true,mapTypeControlOptions:{mapTypeIds:Convert.StringToJson(this.model.get("mapTypes"))},streetViewControl:this.model.get("mapTypeStreet")});return this},mapCanvas_setMapViews:function(){this.map().setOptions({mapTypeId:this.model.get("mapTypeDefault"),mapTypeControlOptions:{mapTypeIds:Convert.StringToJson(this.model.get("mapTypes"))},streetViewControl:this.model.get("mapTypeStreet")})},
mapModel_getCentre:function(){var obj={"mapCentre_lat":this.model.get("mapCentre_lat"),"mapCentre_lng":this.model.get("mapCentre_lng"),"mapCentre_zoom":this.model.get("mapCentre_zoom")};return obj},mapModel_setCentre:function(pos,isSilent){this.model.set(pos,{silent:isSilent==true?true:false});return this},mapInput_getCentre:function(){var obj={"mapCentre_lat":parseFloat($("#lat",this.el).val()),"mapCentre_lng":parseFloat($("#lng",this.el).val()),"mapCentre_zoom":parseInt($("#zoom",this.el).val())};
return obj},mapInput_setCentre:function(pos){$("#lat",this.el).val(pos["mapCentre_lat"]);$("#lng",this.el).val(pos["mapCentre_lng"]);$("#zoom",this.el).val(pos["mapCentre_zoom"]);return this},gps_getLocation:function(callback){if(appFunc.geolocation){if(callback)callback(appFunc.geolocation)}else;}};window.MapPageView=window.PageView.extend(_.extend({currLocMarker:null,currLocRange:null,currLocRangeAcc:null,_map:null,_searchBox:null,map:function(){return this._map},searchBox:function(){return this._searchBox},
subpage:null,showSubPage:function(subpage){try{if(subpage==null)subpage=$(".subpage[subpage]",this.el).attr("subpage");if(this.subpage!=subpage){$(".subpage[subpage!='"+subpage+"']",this.el).hide();$(".subpage[subpage='"+subpage+"']",this.el).show();$(this.el).trigger("subpageChanged",{from:this.subpage,to:subpage});this.subpage=subpage}var hasMap=$(".mapcontent",this.el).hasClass("map");$(".mapcontent",this.el).toggleClass("map",this.subpage=="map");$(".mapcontent",this.el).toggleClass("data",this.subpage==
"data");$("#page-pretrip.mapcontent.data .main .noteslog ",this.el).show();if(hasMap!=$(".mapcontent",this.el).hasClass("map"))try{var pos=this.mapCanvas_getCentre();google.maps.event.trigger(this.map(),"resize");this.mapCanvas_setCentre(pos)}catch(err){}$("#page").trigger({type:"goTop"})}catch(err){}},render:function(){var obj=this.render2({mapObj:this.model.toJSON(),mapAttr:this.model.mapAttributes()});this.render_selectMode();this.loadMap();return obj},render_selectMode:function(){if($(".selectmode",
this.el)){$(".selectmode .selectmode-plan",this.el).toggleClass("disable",!this.model.canPlan());$(".selectmode .selectmode-pre",this.el).toggleClass("disable",!this.model.canPre());$(".selectmode .selectmode-trip",this.el).toggleClass("disable",!this.model.canTrip());$(".selectmode .selectmode-after",this.el).toggleClass("disable",!this.model.canAfter())}},clickMode:function(e){if($(e.currentTarget).hasClass("disable"))return false},unrender:function(){this.unloadMap();return this},loadMap:function(){this.mapCanvas_setCentre(this.mapModel_getCentre());
this.loadSearchBox();this.loadMap_events();var icon=new google.maps.MarkerImage("//maps.gstatic.com/mapfiles/mobile/mobileimgs2.png",new google.maps.Size(22,22),new google.maps.Point(0,18),new google.maps.Point(11,11));icon=CONFIG.YouAreHere;this.currLocMarker=new google.maps.Marker({icon:icon,shadow:null,title:"You are here.",map:null});this.currLocRange=new google.maps.Circle({strokeColor:"#0000CC",strokeOpacity:1,strokeWeight:0.5,fillColor:"#0000CC",fillOpacity:0.1,map:null,radius:Convert.ToInt(this.model.get("cpRange")),
zIndex:0});this.currLocRangeAcc=new google.maps.Circle({strokeColor:"#0000CC",strokeOpacity:1,strokeWeight:0,fillColor:"#0000CC",fillOpacity:0.1,map:null,radius:Convert.ToInt(this.model.get("cpRange")),zIndex:0});appFunc.on("GeolocationEvent",this.updateCurrLocationMarker,this);this.updateCurrLocationMarker()},unloadMap:function(){appFunc.off("GeolocationEvent",this.updateCurrLocationMarker)},loadMap_events:function(){},loadSearchBox:function(){var $input=$("#mapSearchbox",this.el);if($input.length>
0){var pos=this.mapModel_getCentre();var defaultBounds=new google.maps.LatLngBounds(new google.maps.LatLng(22.110171417612477,113.6757925194712),new google.maps.LatLng(22.618168299864628,114.53959256829933));this._searchBox=new google.maps.places.SearchBox($input[0],{bounds:defaultBounds});var markers=[];var searchBox=this._searchBox;var $clear=$("#mapSearchbox_btnClear",this.el);if($clear.length>0)$clear.on("click",this.searchBox_clearSearch)}},searchBox_clearSearch:function(){if(this["markers"]==
null);else{for(var i=0,marker;marker=this.markers[i];i++){marker.infowindow.close();marker.infowindow=null;marker.setMap(null)}this.markers=[];$("#mapSearchbox",this.el).val("")}},searchBox_placeChanged:function(){if(this["markers"]==null)this.markers=[];var places=this.searchBox().getPlaces();for(var i=0,marker;marker=this.markers[i];i++){marker.infowindow.close();marker.infowindow=null;marker.setMap(null)}this.markers=[];if(places==null){appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("No Results")});
return}else if(places.length==0){appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("No Results")});return}var bounds=new google.maps.LatLngBounds;for(var i=0,place;place=places[i];i++){var image={url:place.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(12.5,12.5),scaledSize:new google.maps.Size(25,25)};var marker=new google.maps.Marker({map:this.map(),icon:image,title:place.name,position:place.geometry.location,zIndex:0});marker.infowindow=
new google.maps.InfoWindow({content:place.name});this.markers.push(marker);var map=this.map();google.maps.event.addListener(marker,"click",function(){this.infowindow.open(map,this)});if(i==0)marker.infowindow.open(map,marker);bounds.extend(place.geometry.location)}this.map().fitBounds(bounds)},updateCurrLocationMarker:function(){if(appFunc.geolocation==null){this.currLocMarker.setOptions({map:null});this.currLocRange.setOptions({map:null});$("#btnMyPosition").hide()}else{this.currLocMarker.setOptions({position:new google.maps.LatLng(appFunc.geolocation.lat,
appFunc.geolocation.lng),map:this.map()});var cpRange=Convert.ToInt(this.model.get("cpRange"));this.currLocRange.setOptions({center:new google.maps.LatLng(appFunc.geolocation.lat,appFunc.geolocation.lng),radius:cpRange,map:this.map()});if(appFunc.geolocation["accuracy"]){var accuracy=Math.ceil(appFunc.geolocation.accuracy);this.currLocRangeAcc.setOptions({center:new google.maps.LatLng(appFunc.geolocation.lat,appFunc.geolocation.lng),radius:accuracy,map:this.map(),visible:accuracy>cpRange})}$("#btnMyPosition").show()}},
saveMap:function(){},viewCPReport:function(){var reportObj=new ReportModel_CPList({mapKey:this.model.id,mode:"view"});var self=this;reportObj.save({},{success:function(model,response,options){appRouter.siteFooter.show({action:"error"})},error:function(model,xhr,options){var extraPage=$('<div  class="extrapage" />').html(xhr.responseText).append($('<div class="extrapageFooter" />').text(dict("Click Back to return.")));extraPage.wrapInner('<div class="extrapageInner" />');$("#content").append(extraPage);
location.href="#mode/"+self.options.param.mode+"/"+self.model.id+"/"+self.subpage+"/extrapage";appRouter.siteFooter.show({action:"msg",alert:false,msg:dict("Click Back to return.")})}})},downloadCPReport:function(){$("#btnDownloadReport",this.el).nextAll("span.download").empty();var spanDownload=$("#btnDownloadReport",this.el).nextAll("span.download");if(spanDownload.length>0)spanDownload.empty();else var spanDownload=$("<span class='download' />").insertAfter($("#btnDownloadReport",this.el));var aTag=
$("<a href='javascript:void(0)' />").text(dict("Loading")+"...");aTag.appendTo(spanDownload);var reportObj=new ReportModel_CPList({mapKey:this.model.id,mode:"view"});var self=this;reportObj.save({},{success:function(model,response,options){appRouter.siteFooter.show({action:"error"})},error:function(model,xhr,options){var fileTypes={doc:"application/vnd.ms-word",html:"text/html"};var useType="doc";if(!(appFunc.get("browser")=="Firefox"||appFunc.get("browser")=="Chrome"))useType="html";else if(appFunc.get("browser")==
"Chrome"&&appFunc.get("device")=="iOS")useType="html";aTag.text(dict("Click Here to Download")+" ("+dict("save as")+" xxxx."+useType+")").attr({download:"checkpointlist."+useType,target:"_blank",href:"data:"+fileTypes[useType]+";charset=utf-8,"+encodeURIComponent(xhr.responseText)}).addClass("show").delay(2E4,function(){$(this).remove()})}})}},window.MapInterface));window.MapPageView_SubView=window.PageView_SubView.extend(_.extend({map:function(){if(appRouter.content&&appRouter.content instanceof
window.MapPageView)return appRouter.content.map();if(appRouter._content&&appRouter._content instanceof window.MapPageView)return appRouter._content.map();return null},searchBox:function(){if(appRouter.content&&appRouter.content instanceof window.MapPageView)return appRouter.content.searchBox();if(appRouter._content&&appRouter._content instanceof window.MapPageView)return appRouter._content.searchBox();return null}},window.MapInterface));window.MapHeaderView=window.PageView.extend({initializeBoundFunc:function(){_.bindAll(this)},
viewEl:"#header",el:"#header",render:function(){var obj=this.render2({mapObj:this.model.toJSON(),mapAttr:this.model.mapAttributes()});return obj},events:{"click #btnSave":"saveMap"},saveMap:function(){appRouter.content.saveMap()}})})(jQuery);window.TimerModel=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("timer"),initialize:function(){},defaults:{mapKey:null,mode:null,startTime:null,startTimeInternal:null,endTime:null,priorElapsed:0,pause:false},reset:function(){var time=(new Date).getTime();var resetDefault=$.extend({},this.defaults,{mspKey:this.get("mapKey"),mode:this.get("mode")});this.save(resetDefault);this.trigger("timerEvent",{name:"resetTimer",time:time,elapsed:null})},start:function(){var time=(new Date).getTime();
var elapsed=this.getElapsedTime_timestamp(time);this.save({"startTime":time,"startTimeInternal":time});this.trigger("timerEvent",{name:"startTimer",time:time,elapsed:elapsed})},pause:function(){var time=(new Date).getTime();var elapsed=this.getElapsedTime_timestamp(time);this.save({"priorElapsed":elapsed,"pause":true});this.trigger("timerEvent",{name:"pauseTimer",time:time,elapsed:elapsed})},resume:function(){var time=(new Date).getTime();var elapsed=this.getElapsedTime_timestamp(time);this.save({"startTimeInternal":time,
"pause":false});this.trigger("timerEvent",{name:"resumeTimer",time:time,elapsed:elapsed})},end:function(){if(this.isStarted()){var time=(new Date).getTime();var elapsed=this.getElapsedTime_timestamp(time);this.save({"endTime":time,"priorElapsed":elapsed,"pause":false});this.trigger("timerEvent",{name:"stopTimer",time:time,elapsed:elapsed})}},isStarted:function(){return this.get("startTime")!=null},isPaused:function(){return this.get("startTime")!=null&&this.get("pause")==true},isEnded:function(){return this.get("startTime")!=
null&&this.get("endTime")!=null},getElapsedTime_timestamp:function(currTime){try{if(this.isStarted())if(this.isPaused()||this.isEnded())return this.get("priorElapsed");else{if(currTime==null)currTime=(new Date).getTime();return this.get("priorElapsed")+(currTime-this.get("startTimeInternal"))}}catch(err){return 0}return 0},getElapsedTime_hms:function(currTime){var result_timestamp=this.getElapsedTime_timestamp(currTime);return Convert.ToHms(result_timestamp)},getElapsedTime_hhmmss:function(currTime){var result_timestamp=
this.getElapsedTime_timestamp(currTime);return Convert.ToHhmmss(result_timestamp)},parse:function(response,opt){return response}});
window.TimerCollection=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("timer"),model:TimerModel,initialize:function(){},where1:function(attributes){var result=this.where(attributes);return result.length==0?null:result[0]},getTimer:function(attributes){if(attributes["mapKey"]!=null&&attributes["mode"]!=null){var result=this.where1($.extend({},attributes,{endTime:null}));if(result!=null){if(result.getElapsedTime_timestamp()>864E5)result.reset()}else if(result==null)result=this.create(attributes);
return result}return null}});var timerCollection=new TimerCollection;timerCollection.fetch();window.TripModel=window.TimerModel.extend({initialize:function(){this.cps={}},localStorage:new Backbone.LocalStorage("trip"),defaults:{mapKey:null,mode:null,rule:null,startTime:null,startTimeInternal:null,endTime:null,priorElapsed:0,pause:false,cps:null,name:"",infoClass:"",infoClassno:"",submitted:false},isSubmitted:function(){return this.get("submitted")==true},saveCPs:function(){this.save("cps",Convert.JsonToString(this.cps))},loadCPs:function(){var cpsStr=this.get("cps");if(cpsStr==null)this.cps=
{};else this.cps=Convert.StringToJson(cpsStr)},end_fail:function(){if(this.isStarted())this.save({"endTime":null,"priorElapsed":0})},participant:function(){var opts={};return opts}});
window.TripCollection=window.TimerCollection.extend({localStorage:new Backbone.LocalStorage("trip"),model:TripModel,initialize:function(){},where1:function(attributes){var result=this.where(attributes);return result.length==0?null:result[0]},currentTrips:function(){var attributes={mode:"trip",endTime:null};var resultArr=[];if(attributes["mode"]!=null){var results=this.where(attributes);for(var i=results.length-1;i>=0;i--)if(results[i].isStarted())if(results[i].getElapsedTime_hhmmss().HH>=100){this.remove(results[i]);
results[i].destroy()}else resultArr.push(results[i].get("mapKey"));return resultArr}return resultArr},removeCurrentTrips:function(){var attributes={mode:"trip",endTime:null};if(attributes["mode"]!=null){var results=this.where(attributes);for(var i=results.length-1;i>=0;i--)if(results[i].isStarted()){this.remove(results[i]);results[i].destroy({wait:true})}}},getTrip:function(attributes){if(attributes["mapKey"]!=null&&attributes["mode"]!=null){var result=this.where1($.extend({},attributes,{endTime:null}));
if(result==null)result=this.create(attributes);else if(result.getElapsedTime_hhmmss().HH>=100){this.remove(result);result.destroy();result=this.create(attributes)}else result.loadCPs();return result}return null},getTrips:function(attributes){this.clearTrips(attributes);if(attributes["mapKey"]!=null&&attributes["mode"]!=null){var result=this.where(attributes);return result}return null},clearTrips:function(attributes){var time=(new Date).getTime();if(attributes["mode"]!=null){attributes["submitted"]=
true;var results=this.where(attributes);for(var i=results.length-1;i>=0;i--)if(results[i].isSubmitted())if(time>results[i].get("endTime")+864E5){this.remove(results[i]);results[i].destroy()}}}});var tripCollection=new TripCollection;tripCollection.fetch();window.NoteModel=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("note"),initialize:function(){},defaults:{mapKey:null,mode:null,createDate:null,elapsed:null,content:null,geolocation:null},parse:function(response,opt){return response}});
window.NoteCollection=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("note"),model:NoteModel,where1:function(attributes){var result=this.where(attributes);return result.length==0?null:result[0]},getNotes:function(attributes){if(attributes["mapKey"]!=null&&attributes["mode"]!=null){var result=this.where(attributes);return result}return null},comparator:function(noteModel){return noteModel.get("createDate")}});var noteCollection=new NoteCollection;noteCollection.fetch();window.SubmissionModel=Backbone.Model.extend({initialize:function(){this.cps={}},url:function(){if(this.isNew())return rootURL+"/submission";else return rootURL+"/submission/"+this.id},parse:function(response,opt){if(response["mapID"]!=null)response.mapID=Convert.ToInt(response.mapID);response.startTime=Convert.ToInt(response.startTime);response.endTime=Convert.ToInt(response.endTime);response.lastUpdateTS=Convert.ToDateTime(response.lastUpdateTS,true);return response},isSubmitted:function(){return true},
loadCPs:function(){var cpsStr=this.get("answers");if(cpsStr==null)this.cps={};else this.cps=Convert.StringToJson(cpsStr)}});
window.SubmissionCollection=Backbone.Collection.extend({model:SubmissionModel,initialize:function(){this.fetchParams=$.extend({},this.fetchParams)},fetchParams:{mapKey:null,mapID:null},resetParams:function(){var self=this;$.each(this.fetchParams,function(key){self.fetchParams[key]=null})},url:function(){var _url=rootURL+"/submissions?";if(this.fetchParams.mapKey!=null)_url+="mapKey="+this.fetchParams.mapKey+"&";if(this.fetchParams.mapID!=null)_url+="mapID="+this.fetchParams.mapID+"&";if(this.fetchParams.userID!=
null)_url+="userID="+this.fetchParams.userID+"&";return _url}});window.ReportModel_Trip=Backbone.Model.extend({defaults:{mapKey:null,email:null,trip:null},url:function(){return rootURL+"/report/trip"}});window.ReportModel_Submission=Backbone.Model.extend({defaults:{mapKey:null,email:null,submissionIDs:null,mode:"email"},setSubmissions:function(val){if(_.isString(val)||_.isNumber(val))this.set("submissionIDs",val);else if(_.isArray(val))this.set("submissionIDs",val.join(","))},url:function(){return rootURL+"/report/submission"}});
window.ReportModel_CPList=Backbone.Model.extend({defaults:{mapKey:null,mode:"view"},url:function(){return rootURL+"/report/cp"}});window.SiteNoticeModel=Backbone.Model.extend({defaults:{id:null,startTime:null,endTime:null,postTime:null},parse:function(response,opt){response.startTime=response.startTime!=null?Convert.ToDateTime(response.startTime,true):null;response.endTime=response.endTime!=null?Convert.ToDateTime(response.endTime,true):null;response.postTime=response.postTime!=null?Convert.ToDateTime(response.postTime,true):null;return response}});
window.SiteNoticeCollection=Backbone.Collection.extend({model:SiteNoticeModel,url:function(){return rootURL+"/system/notices"}});(function($){$.fn.canvas=function(opts){var settings=$.extend({method:null,func:null,imgObj:$("<img />")},opts);switch(settings.method){case "call":return this.each(canvasCallFunc);case "isSupported":return isSupported(this[0]);case "context":return context2D(this[0]);case "canExport":return canExport(this[0]);case "toImage":return toImage(this[0]);case "toDataURL":return toDataURL(this[0]);default:return this.each(canvasTools)}function canvasCallFunc(){var canvas=this;if(isSupported(canvas)){var ctx=
context2D(canvas);if(settings.func)settings.func(ctx)}}function context2D(canvas){var ctx=canvas.getContext("2d");return ctx}function isSupported(canvas){if(canvas.getContext)return true;return false}function canExport(canvas){if(canvas.toDataURL)return true;return false}function toImage(canvas){return settings.imgObj.attr("src",canvas.toDataURL())}function toDataURL(canvas){if(canvas.toDataURL)return canvas.toDataURL();return false}}})(jQuery);$(document).ajaxSend(function(e,xhr,options){try{xhr.setRequestHeader("u1",user.id);xhr.setRequestHeader("u2",user.get("userID"));xhr.setRequestHeader("u3",user.get("account"));xhr.setRequestHeader("ulang",user.lang());xhr.setRequestHeader("isApp",appFunc.isApp())}catch(err){}});$(document).ajaxError(function(event,xhr){var status=200;try{status=xhr.status}catch(err){}if(status==401){try{appRouter.siteFooter.show({action:"error",xhr:xhr})}catch(err){}appRouter.showHome()}});
WebFontConfig={google:{families:["Sigmar+One","Roboto+Condensed","Rambla:400,700"]}};window.fontLoader=function(){try{var wf=document.createElement("script");wf.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js";wf.type="text/javascript";wf.async="true";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(wf,s)}catch(err){}};
window.templateLoader={templates:{},load:function(views,callback){var deferreds=[];var self=this;$.each(views,function(index,view){deferreds.push($.ajax({url:"tmpl/"+view+".html",success:function(data){if(window[view])window[view].prototype.template=_.template(data);self.templates[view]=data},dataType:"html",cache:appFunc.isApp()?true:false}))});$.when.apply(null,deferreds).done(callback)}};
String.prototype.repeat=function(count){if(count<1)return"";var result="",pattern=this.valueOf();while(count>0){if(count&1)result+=pattern;count>>=1,pattern+=pattern}return result};if(typeof Number.prototype.toRad==="undefined")Number.prototype.toRad=function(){return this*Math.PI/180};
Convert={ToHalfWidthEng:function(val){if(val==null)return null;var reFull=/([\uFF10-\uFF19\uFF21-\uFF34\uFF41-\uFF5A])/g;if(reFull.test(val))return val.replace(reFull,function(s,key){try{var fwChar=s.charCodeAt(0);var hwChar=fwChar-65296+48;return String.fromCharCode(hwChar)}catch(err){}return s});else return val},ToHms:function(timestamp){var result_timestamp=timestamp;return{d:Math.floor(result_timestamp/864E5),H:Math.floor(result_timestamp/36E5),h:Math.floor(result_timestamp/36E5)%24,m:Math.floor(result_timestamp/
6E4)%60,s:Math.floor(result_timestamp/1E3)%60,ms:result_timestamp%1E3}},ToHhmmss:function(timestamp){var result_hms=Convert.ToHms(timestamp);return $.extend({days:Convert.IntToString(result_hms.days,1),HH:Convert.IntToString(result_hms.H,2),hh:Convert.IntToString(result_hms.h,2),mm:Convert.IntToString(result_hms.m,2),ss:Convert.IntToString(result_hms.s,2),ms:result_hms.ms+""},result_hms)},IntToString:function(val,digits){var str=val+"";return"0".repeat(digits-str.length)+str},ToBoolean:function(val){if(_.isUndefined(val)||
_.isNull(val))return false;else if(_.isBoolean(val))return val;else if(_.isNumber(val))return val>0;else if(_.isString(val))try{switch(val.toLowerCase()){case "true":case "yes":case "1":return true;case "false":case "no":case "0":case "":return false}return parseInt(val,10)>0}catch(err){}return false},ToInt:function(val){try{return parseInt(val,10)}catch(err){return 0}},ToFloat:function(val){try{return parseFloat(val)}catch(err){return 0}},ToDateTime:function(val,fromDB){if(_.isUndefined(val)||_.isNull(val))return null;
else if(_.isDate(val))return val;else if(_.isNumber(val))return new Date(val);else if(_.isString(val)){if(fromDB===true){var momentObj=moment.unix(parseInt(val,10));if(momentObj.isValid())return momentObj.toDate();momentObj=moment(val,["YYYY-MM-DD HH:mm:ss","YYYY-MM-DD"]);if(momentObj.isValid())return momentObj.toDate()}return new Date(val)}return null},JsonToString:function(obj){return JSON.stringify(obj,null,2)},StringToJson:function(str){return $.parseJSON(str)},BBCodetoHtml:function(bbcode){if(bbcode==
null)return"";var fix_search=[{search:/\s*\[list(=([0-9]+))?\]\s*/ig,fix:"[list$1]"},{search:/\s*\[\*\]\s*/ig,fix:"[*]"},{search:/\s*\[\/list\]\s*/ig,fix:"[/list]"}];for(var i=0;i<fix_search.length;i++)bbcode=bbcode.replace(fix_search[i].search,fix_search[i].fix);var htmlConvert_search=[{search:/</ig,fix:"&lt;"},{search:/>/ig,fix:"&gt;"},{search:/\n/ig,fix:"<br />"}];for(var i=0;i<htmlConvert_search.length;i++)bbcode=bbcode.replace(htmlConvert_search[i].search,htmlConvert_search[i].fix);var bbTag_search=
[{search:/\[b\](.*?)\[\/b\]/ig,fix:"<strong>$1</strong>"},{search:/\[i\](.*?)\[\/i\]/ig,fix:"<em>$1</em>"},{search:/\[u\](.*?)\[\/u\]/ig,fix:'<span style="text-decoration: underline;">$1</span>'},{search:/\[s\](.*?)\[\/s\]/ig,fix:'<span style="text-decoration: line-through;">$1</span>'},{search:/\[url=([^\s\]]+)\](.*?)\[\/url\]/ig,fix:'<a href="$1" target="_blank">$2</a>'},{search:/\[url\]([^\s]+)\[\/url\]/ig,fix:'<a href="$1" class="url" target="_blank">$1</a>'},{search:/\[img\](.*?)\[\/img\]/ig,
fix:'<img src="$1" />'},{search:/\[\*\]/ig,fix:"<li>"},{search:/\[li\](.*?)\[\/li\]/ig,fix:"<li>$1</li>"},{search:/\[list=([0-9]+)\](.*?)\[\/list\]/ig,fix:'<ol start="$1">$2</ol>'},{search:/\[list\](.*?)\[\/list\]/ig,fix:"<ul>$1</ul>"}];for(var i=0;i<bbTag_search.length;i++)bbcode=bbcode.replace(bbTag_search[i].search,bbTag_search[i].fix);return bbcode}};CONFIG={YouAreHere:baseURL+"/img/thetrip-youarehere.png",ImgSize:{maxWidth:300,maxHeight:300}};
PATTERN={Int:"-?[0-9]+",UInt:"[0-9]+",Float:"-?[0-9]+(\\.[0-9]+)?",Zoom:"[0-9]+",Lat:"[\\+-]?[0-9]+(\\.[0-9]+)?",Lng:"[\\+-]?[0-9]+(\\.[0-9]+)?",Username:"[a-zA-Z0-9\\*\\-\\._]+",Password:"^.{4,}$",Email:"\\S+@\\S+",Url:"\\S+://\\S+"};
OPTIONS={lang:{"en":"English","zh-HK":"繁體中文"},isDuplicable:{1:"Creator Only",2:"Creator + Collaborators",4:"Creator + Collaborators + Public","0":"Non-Copyable"},duplicableID:{1:"C1",2:"C2",4:"C3","0":"C0"},isEnable:{"true":"This map is in use.","false":"This map is not in use."},isPublic:{"true":"This map is searchable.","false":"This map can only be accessed by its map key."},submission:{"true":"This map can receive participants' submissions.","false":"This map will not receive any participant's submission."},
mapType:{"Roadmap":"roadmap","Terrain":"terrain","Satellite":"satellite","Hybrid":"hybrid"},mapType2:{"roadmap":"Roadmap","terrain":"Terrain","satellite":"Satellite","hybrid":"Hybrid"},cpRange:{5:"Range to detect a checkpoint: 5 metres",10:"Range to detect a checkpoint: 10 metres",15:"Range to detect a checkpoint: 15 metres",20:"Range to detect a checkpoint: 20 metres",25:"Range to detect a checkpoint: 25 metres",50:"Range to detect a checkpoint: 50 metres",75:"Range to detect a checkpoint: 75 metres",
100:"Range to detect a checkpoint: 100 metres",200:"Range to detect a checkpoint: 200 metres",1E3:"Range to detect a checkpoint: 1 km"},ruleOrderArray:[5,0,7,1,2,3,6,4],ruleOrder:{5:{available:false,cpLock:false,taskLock:true,needGPS:true,needPass:false,inOrder:true},"0":{available:true,cpLock:false,taskLock:true,needGPS:true,needPass:false,inOrder:false},7:{available:true,cpLock:false,taskLock:true,needGPS:false,needPass:true,inOrder:false},1:{available:true,cpLock:true,taskLock:true,needGPS:true,
needPass:false,inOrder:true},2:{available:true,cpLock:true,taskLock:true,needGPS:false,needPass:false,inOrder:true},3:{available:true,cpLock:true,taskLock:true,needGPS:true,needPass:false,inOrder:false},6:{available:true,cpLock:true,taskLock:true,needGPS:false,needPass:true,inOrder:false},4:{available:true,cpLock:false,taskLock:false,needGPS:false,needPass:false,inOrder:false}},rule:{5:"All checkpoints are accessible from the start, but their tasks are locked until the previous checkpoint is stepped.\x0B(Checkpoints must be completed in order.)",
"0":"All checkpoints are accessible from the start, but their tasks are locked until stepping into the locations.",7:"All checkpoints are accessible from the start, but their tasks are locked until entering the checkpoints' passwords.",1:"Checkpoints are locked until the previous checkpoint is stepped.\x0B(Checkpoints must be stepped in order.)",2:"Checkpoints are locked until the previous checkpoint's tasks are completed.\x0B(Checkpoints must be completed in order.)",3:"Checkpoints are locked until stepping into the locations.",
6:"Checkpoints are locked until entering their passwords.",4:"All checkpoints & their tasks are accessible from the start."},ruleID:{5:"R1","0":"R2",7:"R3",1:"R4",2:"R5",3:"R6",6:"R7",4:"R8"},klaole:{"Chinese Language Education":"Chinese Language Education","English Language Education":"English Language Education","Mathematics Education":"Mathematics Education","Science Education":"Science Education","Technology Education":"Technology Education","Personal, Social & Humanities Education":"Personal, Social & Humanities Education",
"Arts Education":"Arts Education","Physical Education":"Physical Education","Applied Learning":"Applied Learning","Liberal Studies for Senior Secondary Levels":"Liberal Studies for Senior Secondary Levels","General Studies for Primary Schools":"General Studies for Primary Schools","Moral and National Education":"Moral and National Education","Other Learning Experiences":{"Moral and Civic Education":"Moral and Civic Education","Community Service":"Community Service","Career-related Experiences":"Career-related Experiences",
"Aesthetic Development":"Aesthetic Development","Physical Development":"Physical Development"}},answerType:{"0":"Click to complete",1:"Text",2:"Single Select",3:"Multi Select",4:"True/False",5:"Get Current Geolocation",6:"Camera / Select Image",7:"Enter URL"}};function showAlert(message,title){if(navigator.notification)navigator.notification.alert(message,null,title,"OK");else alert(title+": "+message)}
function taskNumber(taskOrder){return"<span class='taskNumber'>"+dict("Task")+" "+taskOrder+".</span> "}function cpPassword(cpID,mapID){var digit=(mapID+cpID)*7%10*1E3+cpID*17%100*100+cpID*11;digit=digit%1E4;var str=Convert.IntToString(digit,4).substring(0,4);return str}
$.fn.webedit=function(){if($(this).length>0){var $webedits=$(this).filter(function(){return $(this).closest(".webedit-wrapper").length===0});if($webedits.length>0){var template=_.template(window.templateLoader.templates["Others_Tips"]);var $preview=$(".webedit-wrapper",template()).html();$($webedits).wrap('<div class="webedit-wrapper" />').after($preview);$($webedits).bbedit({highlight:true,enableSmileybar:false,tags:"b,i,u,ol,ul,li,url,img"});$($webedits).bind("change focusout keyup keydown",function(){$(this).parents(".webedit-wrapper").find(".webedit-preview").html(Convert.BBCodetoHtml($(this).val()))}).change()}}};
$.fn.getInt=function(){if($(this).length>0)try{var val=parseInt($(this).val());if(isNaN(val))val=0;return val}catch(e){}return 0};$.fn.getIndex=function(){return $(this).parent().children().index($(this))};$.fn.getParentIndex=function(){var parentElem=$(this).parent();return $(parentElem).parent().children().index($(parentElem))};
$.fn.selectedValue=function(a){if(a==null)if($(this).filter(":checked").length==0)return null;else return $(this).filter(":checked").val();else{$(this).check(false).filter("[value='"+a+"']").check(true);return $(this)}};
$.fn.selectedValueMultiple=function(a){if(a==null){var result=[];$(this).filter(":checked").each(function(){result.push($(this).filter(":checked").val())});return result}else{$(this).check(false);if($.isArray(a))for(var i=0;i<a.length;i++)$(this).filter("[value='"+a[i]+"']").check(true);else $(this).filter("[value='"+a+"']").check(true);return $(this)}};$.fn.mustSelect=function(){if($(this).filter(":checked").length==0)$(this).first().check(true);return $(this)};
$.fn.disable=function(a){if(a==true||a==false){$(this).each(function(){$(this)[0].disabled=a});return $(this)}else return $(this)[0].disabled};$.fn.check=function(a){if(a==true||a==false){$(this).each(function(){$(this)[0].checked=a});return $(this)}else return $(this)[0].checked};
$.fn.checkValidity=function(){if($(this).length>=1)if($(this)[0].validity)return $(this)[0].validity;else{var validity={valueMissing:false,typeMismatch:false,patternMismatch:false,tooLong:false,rangeUnderflow:false,rangeOverflow:false,stepMismatch:false,badInput:false,customError:false,valid:true};if($(this).is("input:not(:radio):not(:checkbox), select, textarea")){var require=$(this).attr("required");if(typeof require=="undefined");else if(require==null||require==""||require=="required"||require.toLowerCase()==
"true")if($(this).val()==""){validity.valueMissing=true;validity.valid=false;return validity}if($(this).is("input[type=email]")){var re=new RegExp("^"+PATTERN.Email+"$");if(!re.test($(this).val())){validity.typeMismatch=true;validity.valid=false;return validity}}else if($(this).is("input[type=url]")){var re=new RegExp("^"+PATTERN.Url+"$");if(!re.test($(this).val())){validity.typeMismatch=true;validity.valid=false;return validity}}else if($(this).is("input[type=number]")){var re=new RegExp("^"+PATTERN.Float+
"$");if(!re.test($(this).val())){validity.typeMismatch=true;validity.valid=false;return validity}}var pattern=$(this).attr("pattern");if(typeof pattern=="undefined");else{var re=new RegExp("^"+pattern+"$");if(!re.test($(this).val())){validity.patternMismatch=true;validity.valid=false;return validity}}}return validity}return};$.fn.checkValidityAll=function(){var result=true;$(this).each(function(){try{if($(this).checkValidity().valid==false){result=false;return false}}catch(err){}});return result};
$.fn.delay=function(time,callback){jQuery.fx.step.delay=function(){};return this.animate({delay:1},time,callback)};$.fn.imageURL=function(val){var imgObj=null;if($(this).is("img"))imgObj=$(this);else if($("img",this).length>0)imgObj=$("img",this);if(imgObj)if(val==null)return $(imgObj).attr("src");else return $(imgObj).attr("src",val);return null};
$.fn.captureImage=function(event){var orientation=1;var selectImage=$(this);var captureImage=$(this).parents(".captureImage");if(siteInfo.isApp())imageSelectedApp(event);else imageSelected(event);function imageSelectedApp(event){navigator.camera.getPicture(function captureSuccess(imgURL){if(imgURL!=null&&imgURL!="")var img=$("<img />").attr({src:imgURL}).bind("load",imageSelected2)},function captureError(error){},{destinationType:Camera.DestinationType.FILE_URI,sourceType:$(event.currentTarget).is(".fromLibrary")?
Camera.PictureSourceType.PHOTOLIBRARY:Camera.PictureSourceType.CAMERA})}function imageSelected(event){var fileObj=null;var selectImage=$(this);if(window.File&&window.FileList&&window.FileReader)try{var files=event.originalEvent.target.files;if(files.length==1){fileObj=files[0];var reader=new FileReader;var reader2=new FileReader;reader2.onload=function(event){var imgDataURI=event.target.result;var img=$("<img />").attr({src:imgDataURI}).bind("load",imageSelected2);$(selectImage).val("")};reader.onload=
function(event){try{var exif=EXIF.readFromBinaryFile(new BinaryFile(event.target.result));orientation=exif.Orientation}catch(err){}reader2.readAsDataURL(fileObj)};if(reader.readAsBinaryString)reader.readAsBinaryString(fileObj);else reader.readAsArrayBuffer(fileObj)}}catch(err){alert(dict("Not support"))}else alert(dict("Not support"))}function imageSelected2(){try{}catch(err){}var imgObj=$(this);var localImg_width=$(this)[0].width;var localImg_height=$(this)[0].height;if(localImg_width>CONFIG.ImgSize.maxWidth||
localImg_height>CONFIG.ImgSize.maxHeight||orientation!=1){if(localImg_width>CONFIG.ImgSize.maxWidth||localImg_height>CONFIG.ImgSize.maxHeight){var rationH=localImg_width/CONFIG.ImgSize.maxWidth;var rationV=localImg_height/CONFIG.ImgSize.maxHeight;if(rationH>=rationV){localImg_width=Math.round(localImg_width/rationH);localImg_height=Math.round(localImg_height/rationH)}else{localImg_width=Math.round(localImg_width/rationV);localImg_height=Math.round(localImg_height/rationV)}}var $canvas=$('<canvas id="theCanvas"></canvas>');
$canvas.attr({width:localImg_width,height:localImg_height});if($canvas.canvas({method:"isSupported"})&&$canvas.canvas({method:"canExport"})){$canvas.canvas({method:"call",func:function(ctx){switch(orientation){case 6:ctx.canvas.width=localImg_height;ctx.canvas.height=localImg_width;ctx.rotate(Math.PI/2);ctx.translate(localImg_width/2,-localImg_height/2);ctx.drawImage(imgObj[0],-localImg_width/2,-localImg_height/2,localImg_width,localImg_width);break;case 8:ctx.canvas.width=localImg_height;ctx.canvas.height=
localImg_width;ctx.rotate(-Math.PI/2);ctx.translate(-localImg_width/2,localImg_height/2);ctx.drawImage(imgObj[0],-localImg_width/2,-localImg_height/2,localImg_width,localImg_width);break;case 3:ctx.translate(localImg_width,localImg_height);ctx.rotate(Math.PI);case 1:default:ctx.drawImage(imgObj[0],0,0,localImg_width,localImg_height);break}}});var imgDataURI=$canvas.canvas({method:"toDataURL"});imgObj=$("<img />").attr({src:imgDataURI})}}$(".selectImage-preview",captureImage).empty().append(imgObj)}
};
$.fn.rotateImage=function(deg){var imgObj=$(this);var localImg_width=$(this)[0].width;var localImg_height=$(this)[0].height;imageRotate();function imageRotate(){var $canvas=$('<canvas id="theCanvas"></canvas>');$canvas.attr({width:localImg_width,height:localImg_height});if($canvas.canvas({method:"isSupported"})&&$canvas.canvas({method:"canExport"})){$canvas.canvas({method:"call",func:function(ctx){var _orientation=deg;switch(_orientation){case 90:case -90:case 270:ctx.canvas.width=localImg_height;ctx.canvas.height=
localImg_width}ctx.rotate(_orientation*Math.PI/180);switch(_orientation){case 90:ctx.translate(localImg_width/2,-localImg_height/2);break;case -90:case 270:ctx.translate(-localImg_width/2,localImg_height/2);break;case 180:ctx.translate(-localImg_width/2,-localImg_height/2);break;case 0:default:ctx.translate(localImg_width/2,localImg_height/2);break}ctx.drawImage(imgObj[0],-localImg_width/2,-localImg_height/2,localImg_width,localImg_height)}});var imgDataURI=$canvas.canvas({method:"toDataURL"});imgObj.attr({src:imgDataURI})}}
};function longbox_hideMore(baseEl){$(baseEl).find(".longbox.short").each(function(){try{var longbox2=$(".longbox2",this)[0];if(longbox2.scrollHeight<=longbox2.clientHeight){$(".morebox",this).hide();$(this).toggleClass("short",false)}}catch(err){}})}$.fn.classList=function(){try{return $(this).attr("class").split(/\s+/)}catch(err){return[]}};
$("#content").on("click",".webedit-toolbar a",function(){$(this).parents(".webedit-wrapper").toggleClass("preview",$(this).is(".btnPreview")).toggleClass("tips",$(this).is(".btnTips"))});$("#header").on("click",".btnSided",function(){$("#page").toggleClass("sided-1p");try{user.save("sided",$("#page").hasClass("sided-1p")?"sided-1p":null)}catch(err){}try{var pos=appRouter.content.mapCanvas_getCentre();google.maps.event.trigger(appRouter.content.map(),"resize");appRouter.content.mapCanvas_setCentre(pos)}catch(err){}});
$("#header").on("click",".mapfuncs-btnExpand",function(){$(this).parents(".mapfuncs").toggleClass("expand")});$("#content").on("click",".longbox .morebox",function(){$(this).parents(".longbox").toggleClass("short")});$("#content").on("focusin focusout",".searchbox input",function(e){$(this).parents(".searchbox").toggleClass("focus",e.type=="focusin")});$("#content").on("click",".checkbox .checkbox-tick",function(){$(this).siblings("input[type=checkbox]").click()});
$("#content").on("click",".radio .radio-tick",function(){$(this).siblings("input[type=radio]").click()});$("#content").on("click",".flipper .flipper-btnOpen",function(){if($(this).parents(".flipper-normal.tap-box").length>0)return;$(this).parents(".flipper").toggleClass("open")});$("#content").on("click",".slider .slider-btnOpen, .slider .slider-btnClose",function(){$(this).parents(".slider").toggleClass("open")});
$("#page").on("goTop",function(e){if(e["slide"]==true)if($("#page:not(.android-default)").length>0)$(".mapcontent .left").delay(0.5*1E3,function(){$(this).scrollTop(0)});else $(".mapcontent .left").scrollTop(0);else $(".mapcontent .left").scrollTop(0)});$("#content").on("click",".captureImage .selectImageApp",function(event){$(this).captureImage(event)});$("#content").on("change",".captureImage .selectImage",function(event){$(this).captureImage(event)});
$("#content").on("click",".captureImage .selectImage-anticlockwise, .captureImage .selectImage-clockwise",function(event){var imgObj=$(this).parents(".captureImage").find(".selectImage-preview img");if(imgObj.length>0)$(imgObj).rotateImage($(this).hasClass("selectImage-clockwise")?90:-90)});
$(document).on("CompassEvent",".compass",function(e){if(appFunc.compass!=null){var deg=Math.round(appFunc.compass.orientation);$(this).removeClass("disable");$(".compass-direction",this).css({"-moz-transform":"rotate("+deg+"deg)","-webkit-transform":"rotate("+deg+"deg)","-o-transform":"rotate("+deg+"deg)","-ms-transform":"rotate("+deg+"deg)"})}else $(this).addClass("disable")});(function($){window.PlanTripView=window.MapPageView.extend({initializeBoundFunc:function(){_.bindAll(this,"updateByInput","changeCentre","mapCanvas_getCentre","updateByMap","goMyPosition_setLoc","mapModel_getCentre","searchBox_placeChanged","searchBox_clearSearch");user.addMap(this.model.id)},loadSubviews:function(){this.subviews["tags"]=new PlanTripView_Tags({model:this.model});this.subviews["users"]=new PlanTripView_Users({model:this.model});this.subviews["plot"]=new PlanTripView_Plot({model:this.model});
this.subviews["searchCPs"]=new PlanTripView_SearchCPs({model:this.model});this.subviews["cps"]=new PlanTripView_CPs({model:this.model})},reorderCP:function(){if(this.subviews["reordercps"]!=null)this.subviews["reordercps"].unrender();if(this.subviews["cps"]!=null)this.subviews["reordercps"]=new PlanTripView_ReorderCPs({model:this.model,collection:this.subviews["cps"].collection});else this.subviews["reordercps"]=new PlanTripView_ReorderCPs({model:this.model})},events:{"click .selectmode a":"clickMode",
"subpageChanged":"changedSubPage","click #btnUpdateByInput":"updateByInput","click #btnChangeCentre":"changeCentre","click #btnReturnCentre":"returnCentre","click #btnMyPosition":"goMyPosition","click #btnDeleteMap":"deleteMap","click #btnReorderCP":"reorderCP","change [subpage=advance] .checkbox input[type=checkbox]":"changeAdvance","change [subpage=advance] .flipper input[type=text]":"changeAdvance","change [subpage=advance] select":"changeAdvance","click #btnViewReport":"viewCPReport","click #btnDownloadReport":"downloadCPReport",
"click .btnGPS-Note":"clickGPSNote"},loadMap_events:function(){google.maps.event.addListener(this.map(),"center_changed",this.updateByMap);google.maps.event.addListener(this.map(),"zoom_changed",this.updateByMap);google.maps.event.addListener(this.searchBox(),"places_changed",this.searchBox_placeChanged)},changedSubPage:function(e,pageObj){switch(pageObj.from){case "advance":this.subviews["plot"].updateModel();this.subviews["plot"].removeListener();this.subviews["plot"].showHideMarkers(false);this.save();
break;case "cp":this.subviews["searchCPs"].showResults(false);break;case "basic":this.saveBasic();this.save();break;case "cpreorder":this.subviews["cps"].reorderItems();this.subviews["plot"].showHideMarkers(false);case null:this.subviews["plot"].showHideMarkers(false);break}switch(pageObj.to){case "advance":this.subviews["plot"].showHideMarkers(true);break;case "cp":this.subviews["searchCPs"].loadCPs();this.subviews["searchCPs"].showResults(true);break;case "cpreorder":this.reorderCP()}},goMyPosition:function(){this.gps_getLocation(this.goMyPosition_setLoc)},
goMyPosition_setLoc:function(position){var pos=$.extend(this.mapCanvas_getCentre(),{"mapCentre_lat":position.lat,"mapCentre_lng":position.lng});this.mapCanvas_setCentre(pos).gotoInput_setCentre(pos)},returnCentre:function(){var pos=this.mapModel_getCentre();this.mapCanvas_setCentre(pos).mapInput_setCentre(pos)},changeCentre:function(){var pos=this.mapCanvas_getCentre();this.mapModel_setCentre(pos,true).mapInput_setCentre(pos)},updateByInput:function(position){if($("#goto_lat, #goto_lng, #goto_zoom",
this.el).checkValidityAll())this.mapCanvas_setCentre(this.gotoInput_getCentre());else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter valid "latitude", "longitude" and "zoom".')})},updateByMap:function(){this.gotoInput_setCentre(this.mapCanvas_getCentre())},gotoInput_getCentre:function(){var obj={"mapCentre_lat":parseFloat($("#goto_lat",this.el).val()),"mapCentre_lng":parseFloat($("#goto_lng",this.el).val()),"mapCentre_zoom":parseInt($("#goto_zoom",this.el).val())};return obj},
gotoInput_setCentre:function(pos){$("#goto_lat",this.el).val(pos["mapCentre_lat"]);$("#goto_lng",this.el).val(pos["mapCentre_lng"]);$("#goto_zoom",this.el).val(pos["mapCentre_zoom"]);return this},changeAdvance:function(e){var val=null;var id=$(e.currentTarget).attr("id");var obj={};switch(id){case "isEnable":case "isPublic":case "submission":case "mapTypeStreet":val=$(e.currentTarget).check();break;case "isDuplicable":case "privateKey":case "cpRange":case "rule":case "mapTypeDefault":val=$(e.currentTarget).val();
break;case "mapType-roadmap":case "mapType-terrain":case "mapType-satellite":case "mapType-hybrid":val=Convert.JsonToString($(".maptypes input[type=checkbox]",this.el).selectedValueMultiple());id="mapTypes";break;default:return}obj[id]=val;this.model.set(obj,{silent:true});if(id=="cpRange")try{this.currLocRange.setOptions({radius:Convert.ToInt(this.model.get("cpRange"))})}catch(err){}else if(id=="isPublic")try{$(".privateKey",this.el).toggle(!val);$(".publicCC",this.el).toggle(val)}catch(err){}try{if(id==
"privateKey")try{this.render3(".privateKeyNote",{mapObj:this.model.toJSON(),mapAttr:this.model.mapAttributes()})}catch(err){}else if($(e.currentTarget).parents(".mapviews").length>0)try{this.mapCanvas_setMapViews()}catch(err){}else $(e.currentTarget).parents(".subsection").first().find(".note:not(.psnote)").text(dict(OPTIONS[id][val]))}catch(err){}},saveBasic:function(){if($("#name",this.el).val()=="")$("#name",this.el).val(this.model.get("name"));if($("#creatorName",this.el).val()=="")$("#creatorName",
this.el).val(this.model.get("creatorName"));this.model.set({name:$("#name",this.el).val(),description:$("#description",this.el).val(),language:$("#language",this.el).val(),creatorName:$("#creatorName",this.el).val()},{silent:true})},saveMap:function(){switch(this.subpage){case "advance":this.subviews["plot"].updateModel();break;case "basic":this.saveBasic();break}this.save()},save:function(){if(this.model.hasChanged()){appRouter.siteFooter.show({action:"updating"});this.model.save({lastUpdateBy:user.get("userID")},
{success:function(model,response,options){model.set({});appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}});this.render_selectMode()}},deleteMap:function(){if(confirm(dict("Are you sure to delete this map?"))){appRouter.siteFooter.show({action:"updating"});$("#page").hide();this.model.destroy({wait:true,success:function(model,response,options){location.href="#page/home";$("#page").show();
appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Deleted")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"error",xhr:xhr});$("#page").show()}})}},clickGPSNote:function(){appFunc.alert(dict("The checkpoints/tasks could also be unlocked by entering the checkpoints' passwords."))}});window.PlanTripView_Users=window.MapPageView_SubView.extend({viewEl:".subpage[subpage=users]",el:".subpage[subpage=users]",initializeBoundFunc:function(){_.bindAll(this,"render","appendItem",
"postRender","addUsers","removeItem")},events:{"click #btnAddUsers":"addUsers"},collectionEvents:{"add":"appendItem","remove":"removeItem","destroy":"destroyItem","reset":"resetItems"},init:function(){this.collection=new MapUserCollection;this.collection.fetchParams.mapKey=this.model.id},load:function(){this.collection.fetch()},initialRender:true,resetItems:function(){var self=this;$(".mapUsers[postType]",this.el).empty();_(this.collection.models).each(function(item){self.appendItem(item)},this);
this.postRender()},render:function(){$(this.el).empty();var obj=this.render2({mapObj:this.model.toJSON(),param:this.options.param});this.postRender();return obj},postRender:function(){$(".mapUsers",this.el).each(function(){$(this).parents(".line:first").toggle($(".mapUser",this).length>0)})},addUsers:function(){var self=this;$("#post_collaborator, #post_checker",this.el).each(function(){var postType=parseInt($(this).attr("postType"),10);var emails=$(this).val().split(/;|\n|\r/gi);for(var i=0;i<emails.length;i++){var emailText=
$.trim(emails[i]);if(emailText.length>0)self.collection.create({account:emailText,post:postType,mapID:self.model.get("id"),creatorID:user.get("userID")},{success:function(model,response,options){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("createDateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"error",xhr:xhr})}})}$(this).val("")});this.postRender()},appendItem:function(item){var itemView=new PlanTripView_User({model:item});this.subviews[itemView.cid]=
itemView;$(".mapUsers[postType="+item.get("post")+"]",this.el).append(itemView.render().el)},removeItem:function(){},destroyItem:function(){this.postRender()}});window.PlanTripView_User=window.PageView_SubView.extend({events:{"click .btnDelete":"deleteItem"},modelEvents:{"remove":"unrender"},tagName:"div",className:"mapUser",viewEl:null,el:null,initializeBoundFunc:function(){_.bindAll(this)},render:function(){$(this.el).text(this.model.get("account")).attr("mapUserID",this.model.id);if(this.model.get("post")!=
1&&this.model.get("account")!=user.get("account"))$(this.el).append("<span class='btnDelete'>✘</span>");return this},unrender:function(){this.remove();$(this.$el).remove()},deleteItem:function(){this.model.destroy({success:function(model,response,options){appRouter.siteFooter.show({action:"msg",msg:dict("Deleted")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"error",xhr:xhr})}})}});window.PlanTripView_Tags=window.MapPageView_SubView.extend({viewEl:".subpage[subpage=tags]",
el:".subpage[subpage=tags]",initializeBoundFunc:function(){_.bindAll(this,"render","appendItem","postRender","addTags","removeItem")},events:{"click #btnAddTags":"addTags"},collectionEvents:{"add":"appendItem","remove":"removeItem","destroy":"destroyItem","reset":"resetItems"},init:function(){this.collection=new MapTagCollection;this.collection.fetchParams.mapKey=this.model.id},load:function(){this.collection.fetch()},initialRender:true,resetItems:function(){var self=this;$(".searchTags[tagType]",
this.el).empty();_(this.collection.models).each(function(item){self.appendItem(item)},this);this.postRender()},render:function(){$(this.el).empty();var obj=this.render2({mapObj:this.model.toJSON(),param:this.options.param});this.postRender();return obj},postRender:function(){$(".searchTags",this.el).each(function(){$(this).parents(".line:first").toggle($(".searchTag",this).length>0)})},addTags:function(){var self=this;$("#tag_school,#tag_klaole,#tag_subject,#tag_location, #tag_other",this.el).each(function(){var tagType=
parseInt($(this).attr("tagType"),10);var tags=$(this).val().split(/;|\n|\r/gi);appRouter.siteFooter.show({action:"updating"});var noupdate=true;for(var i=0;i<tags.length;i++){var tagText=$.trim(tags[i]);if(tagText.length>0){noupdate=false;self.collection.create({text:tagText,type:tagType,mapID:self.model.get("id")},{success:function(model,response,options){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("createDateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"error",
xhr:xhr})}})}}$(this).val("");if(noupdate)appRouter.siteFooter.hide()});this.postRender()},appendItem:function(item){var itemView=new PlanTripView_Tag({model:item});this.subviews[itemView.cid]=itemView;$(".searchTags[tagType="+item.get("type")+"]",this.el).append(itemView.render().el)},removeItem:function(){},destroyItem:function(){this.postRender()}});window.PlanTripView_Tag=window.PageView_SubView.extend({events:{"click .btnDelete":"deleteItem"},modelEvents:{"remove":"unrender"},tagName:"div",className:"searchTag",
viewEl:null,el:null,initializeBoundFunc:function(){_.bindAll(this)},render:function(){$(this.el).text(this.model.get("text")).attr("tagID",this.model.id).append("<span class='btnDelete'>✘</span>");return this},unrender:function(){this.remove();$(this.$el).remove()},deleteItem:function(){this.model.destroy({success:function(model,response,options){appRouter.siteFooter.show({action:"msg",msg:dict("Deleted")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"error",xhr:xhr})}})}});
window.PlanTripView_Plot=window.MapPageView_SubView.extend({viewEl:".main .subpage[subpage=advance]",el:".main .subpage[subpage=advance]",trackMarkers:null,boundaryMarkers:null,trackColor:"blue",boundaryColor:"red",trackPolyline:null,boundaryPolyline:null,initialRender:true,initializeBoundFunc:function(){_.bindAll(this,"createMarker","createPolyline","updatePolylines");this.trackMarkers=[];this.boundaryMarkers=[]},listener:null,render:function(){var obj=this.render2();this.loadModel();return obj},
events:{"click #btnPlotBoundary":"clickPlotBoundary","click #btnPlotTrack":"clickPlotTrack","click #btnCompleteBoundary":"clickCompleteBoundary","click #btnCompleteTrack":"clickCompleteTrack","click #btnClearBoundary":"clickClearBoundary","click #btnClearTrack":"clickClearTrack"},clickPlotBoundary:function(){this.removeListener();$("#btnPlotBoundary",this.el).addClass("greenbg-lt").removeClass("greybg-lt");var self=this;this.listener=google.maps.event.addListener(this.map(),"click",function(event){self.boundaryMarkers.push(self.createMarker(event.latLng,
self.boundaryColor));if(self.boundaryPolyline)self.boundaryPolyline.setMap(null);self.boundaryPolyline=self.createPolyline(self.boundaryMarkers,self.boundaryColor,true)})},clickPlotTrack:function(){this.removeListener();$("#btnPlotTrack",this.el).addClass("greenbg-lt").removeClass("greybg-lt");var self=this;this.listener=google.maps.event.addListener(this.map(),"click",function(event){self.trackMarkers.push(self.createMarker(event.latLng,self.trackColor));if(self.trackPolyline)self.trackPolyline.setMap(null);
self.trackPolyline=self.createPolyline(self.trackMarkers,self.trackColor,false)})},clickCompleteBoundary:function(){this.removeListener()},clickCompleteTrack:function(){this.removeListener()},clickClearBoundary:function(){this.removeListener();if(this.boundaryPolyline){this.boundaryPolyline.setMap(null);this.boundaryPolyline=null}for(var i in this.boundaryMarkers)this.boundaryMarkers[i].setMap(null);this.boundaryMarkers=[]},clickClearTrack:function(){this.removeListener();if(this.trackPolyline){this.trackPolyline.setMap(null);
this.trackPolyline=null}for(var i in this.trackMarkers)this.trackMarkers[i].setMap(null);this.trackMarkers=[]},removeListener:function(){$("#btnPlotBoundary, #btnPlotTrack, #btnCompleteBoundary, #btnCompleteTrack",this.el).addClass("greybg-lt").removeClass("greenbg-lt");if(this.listener!=null){google.maps.event.removeListener(this.listener);this.listener=null}},getPolylinePath:function(markers,isClosedPath){var path=[];for(var i=0;i<markers.length;i++)path.push(markers[i].getPosition());if(isClosedPath&&
path.length>=3)path.push(markers[0].getPosition());return path},createPolyline:function(markers,color,isPolygon){var path=this.getPolylinePath(markers,isPolygon);var opt={path:path,strokeColor:color,strokeWeight:1.5,strokeOpacity:0.75,fillOpacity:0,editable:false,map:this.map(),zIndex:1};var polyline=new google.maps.Polyline(opt);return polyline},updatePolylines:function(){var self=this;if(self.boundaryPolyline)self.boundaryPolyline.setMap(null);self.boundaryPolyline=self.createPolyline(self.boundaryMarkers,
self.boundaryColor,true);if(self.trackPolyline)self.trackPolyline.setMap(null);self.trackPolyline=self.createPolyline(self.trackMarkers,self.trackColor,false)},createMarker:function(latlng,color){var icon={path:google.maps.SymbolPath.CIRCLE,fillColor:color,fillOpacity:0.25,strokeColor:color,strokeWeight:0.5,scale:4,zIndex:2};var marker=new google.maps.Marker({position:latlng,map:this.map(),draggable:true,icon:icon});var self=this;google.maps.event.addListener(marker,"dragend",function(e){self.updatePolylines()});
return marker},showHideMarkers:function(isShow){for(var i=0;i<this.boundaryMarkers.length;i++)this.boundaryMarkers[i].setMap(isShow?this.map():null);for(var i=0;i<this.trackMarkers.length;i++)this.trackMarkers[i].setMap(isShow?this.map():null)},deleteMarker:function(marker,markers){marker.setMap(null);var pos=jQuery.inArray(marker,markers);if(pos>=0)markers.splice(pos,1)},loadModel:function(){var self=this;if(!_.isNull(this.model.get("plotBoundary"))){var arr=$.parseJSON(this.model.get("plotBoundary"));
if(_.isArray(arr))for(var i=0;i<arr.length;i++){var latlng=new google.maps.LatLng(arr[i].lat,arr[i].lng);self.boundaryMarkers.push(self.createMarker(latlng,self.boundaryColor))}}if(self.boundaryPolyline)self.boundaryPolyline.setMap(null);if(self.boundaryMarkers.length>0)self.boundaryPolyline=self.createPolyline(self.boundaryMarkers,self.boundaryColor,true);if(!_.isNull(this.model.get("plotTrack"))){var arr=$.parseJSON(this.model.get("plotTrack"));if(_.isArray(arr))for(var i=0;i<arr.length;i++){var latlng=
new google.maps.LatLng(arr[i].lat,arr[i].lng);self.trackMarkers.push(self.createMarker(latlng,self.trackColor))}}if(self.trackPolyline)self.trackPolyline.setMap(null);if(self.trackMarkers.length>0)self.trackPolyline=self.createPolyline(self.trackMarkers,self.trackColor,false)},updateModel:function(){this.model.set({"plotBoundary":this.markersToJson(this.boundaryMarkers),"plotTrack":this.markersToJson(this.trackMarkers)},{silent:true})},markersToJson:function(markers){var arr=[];for(var i=0;i<markers.length;i++){var latlng=
markers[i].getPosition();arr.push({lat:latlng.lat(),lng:latlng.lng()})}return Convert.JsonToString(arr)},removeBoundFunc:function(){this.removeListener()}});window.PlanTripHeaderView=window.MapHeaderView.extend({})})(jQuery);(function($){window.PlanTripView_CPs=window.MapPageView_SubView.extend({viewEl:".left .subpage[subpage=cp]",el:".left .subpage[subpage=cp]",parentView:"PlanTripView",initialRender:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){this.collection=new CheckpointCollection;this.collection.comparator=function(cp){return cp.get("cpOrder")};this.collection.fetchParams.mapKey=this.model.id},events:{"click #btnAddCP":"addItem"},collectionEvents:{"reset":"resetItems","remove":"removeItem"},
load:function(){this.updateLayout()},updateLayout:function(){this.collection.fetch()},removeItem:function(){var url=this.collection.url();var self=this;$.ajax({async:false,dataType:"json",url:url,data:{orderOnly:true},success:function(_models){$.each(_models,function(index,_model){if(Convert.ToInt(_model.mapID)==self.model.get("id")){var model=self.collection.get(Convert.ToInt(_model.id));if(model!=null)model.set("cpOrder",Convert.ToInt(_model.cpOrder))}})}})},resetItems:function(){$(".checkpoints",
this.el).empty();this.appendItems()},reorderItems:function(){appRouter.siteFooter.show({action:"updating"});var idAndOrders=[];var self=this;_(this.collection.models).each(function(item,index){$(".checkpoints",this.el).append(item.view.$el);idAndOrders.push({id:item.id,cpOrder:item.get("cpOrder")})},this);var url=this.collection.url();$.ajax({type:"POST",contentType:"application/json",dataType:"json",url:url,data:Convert.JsonToString({mode:"reorder",newOrders:idAndOrders}),success:function(_model){var lastUpdate=
Convert.ToDateTime(_model.lastUpdateTS,true);appRouter.siteFooter.show({action:"save",lastUpdate:lastUpdate})},error:function(xhr){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new PlanTripView_CP({model:item});item.view=itemView;this.subviews[itemView.cid]=itemView;$(".checkpoints",this.el).append(itemView.$el)},addItem:function(){if(this.subviews["newCP"]==
null){$("#btnAddCP",this.el).hide();var pos=appRouter.content.mapCanvas_getCentre();this.subviews["newCP"]=new PlanTripView_NewCP({model:new CheckpointModel({mapID:this.model.get("id"),lat:pos.mapCentre_lat,lng:pos.mapCentre_lng,cpOrder:this.collection.length+1})});this.subviews["newCP"].parent=this}},addItem_fail:function(){$("#btnAddCP",this.el).show();this.subviews["newCP"]=null},addItem_success:function(){var self=this;var newCP=this.subviews["newCP"].model;self.appendItem(newCP,self.collection.length);
$("#btnAddCP",self.el).show();this.collection.add(newCP);this.subviews["newCP"]=null},addItem_closest:function(cp){if($(".checkpoint-new",this.el).length>0)if($(".checkpoint-new",this.el).is(":not(:empty)")){appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please close the "New Checkpoint".')});return}if($(".slider.open .checkpoint-detail .task-new",this.el).length>0)if($(".slider.open .checkpoint-detail .task-new",this.el).is(":not(:empty)")){appRouter.siteFooter.show({action:"msg",
"alert":true,msg:dict('Please close the "New Task".')});return}var self=this;var newCP=cp.clone();newCP.set({"fromCP":newCP.id});newCP.id=null;appRouter.siteFooter.show({action:"updating"});newCP.save({id:null,fromCP:cp.id,mapID:this.model.get("id"),cpOrder:this.collection.length+1,creator:user.get("userID")},{success:function(model,response,options){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")});self.appendItem(model,self.collection.length-1)},error:function(model,
xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}});this.collection.add(newCP)},showCPDetail:function(cpModel,cpCollection){if(this.subviews["cpdetail"])this.subviews["cpdetail"].remove();if(cpModel){this.subviews["cpdetail"]=new PlanTripView_CPDetail({model:cpModel,collection:cpCollection});$("#page").trigger({type:"goTop",slide:true})}}});window.PlanTripView_NewCP=window.MapPageView_SubView.extend({viewEl:".checkpoint-new",el:".checkpoint-new",parent:null,marker:null,initialRender:true,
events:{"click .btnClose":"close","click .btnSave":"save","click .btnUpdatePin":"updateMarker"},render:function(){var obj=this.render2({cpObj:this.model.toJSON()});this.createMarker();return obj},createMarker:function(){var icon="http://chart.apis.google.com/chart?chst=d_map_xpin_letter&chld=pin_star|"+this.model.get("cpOrder")+"|FFFF42|000000";this.marker=new google.maps.Marker({position:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")),map:this.map(),draggable:true,icon:icon});
var self=this;google.maps.event.addListener(this.marker,"dragend",function(e){self.updateLatLng()})},updateMarker:function(){if(this.marker){var pos=new google.maps.LatLng($("#newCP-lat",this.el).val(),$("#newCP-lng",this.el).val());if(pos.lat()&&pos.lng()){this.model.set({lat:pos.lat(),lng:pos.lng()},{silent:true});this.marker.setPosition(pos)}else this.updateLatLng()}},removeMarker:function(){if(this.marker){this.marker.setMap(null);this.marker=null}},updateLatLng:function(){var pos=this.marker.getPosition();
this.model.set({lat:pos.lat(),lng:pos.lng()},{silent:true});$("#newCP-lat",this.el).val(pos.lat());$("#newCP-lng",this.el).val(pos.lng())},save:function(){var self=this;if($("#newCP-name, #newCP-lat, #newCP-lng",this.el).checkValidityAll()){this.model.set({name:$("#newCP-name",this.el).val(),lat:$("#newCP-lat",this.el).val(),lng:$("#newCP-lng",this.el).val(),description:$("#newCP-description",this.el).val()},{silent:true});appRouter.siteFooter.show({action:"updating"});this.model.save({creatorID:user.get("userID")},
{success:function(model,response,options){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")});self.parent.addItem_success(model);self.unrender()},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter checkpoint "name" and valid "latitude" and "longitude".')})},unrender:function(){this.removeMarker();this.remove()},close:function(){this.unrender();this.model=
null;this.parent.addItem_fail()}});window.PlanTripView_CP=window.MapPageView_SubView.extend({marker:null,viewEl:".checkpoint",el:null,tagName:"div",className:"checkpoint section",init:function(){this.collection=new TaskCollection;this.collection.comparator=function(task){return task.get("taskOrder")};this.collection.fetchParams.cpID=this.model.id},load:function(){this.collection.fetch()},initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},initialRender:true,events:{"click .btnCPDetail":"showDetail"},
modelEvents:{"change":"updateLayout","remove":"unrender"},collectionEvents:{"reset":"resetTaskItems","add":"resetTaskItems","delete":"resetTaskItems","change":"resetTaskItems"},render:function(){this.createMarker();return this.updateLayout()},unrender:function(){this.removeMarker();this.remove();$(this.$el).remove()},updateLayout:function(){if(this.model.hasChanged("cpOrder")){var icon="http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+this.model.get("cpOrder")+"|FF0000|000000";this.marker.setOptions({icon:icon})}var isOpen=
$(".flipper.open",this.el).length>0;var obj=this.render2({cpObj:this.model.toJSON()});$(".flipper",this.el).toggleClass("open",isOpen);this.updateMarker();if(this.model.hasChanged("cpOrder"))this.resetTaskItems();return obj},updateMarker:function(){if(this.marker){var pos=new google.maps.LatLng(this.model.get("lat"),this.model.get("lng"));if(pos.lat()&&pos.lng())this.marker.setPosition(pos);else;}},createMarker:function(){var icon="http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+this.model.get("cpOrder")+
"|FF0000|000000";this.marker=new google.maps.Marker({position:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")),map:this.map(),draggable:true,icon:icon});var self=this;google.maps.event.addListener(this.marker,"dragend",function(e){self.updateLatLng()})},updateLatLng:function(){var pos=this.marker.getPosition();this.model.set({lat:pos.lat(),lng:pos.lng()},{silent:true});if(this.model.hasChanged()){appRouter.siteFooter.show({action:"updating"});this.model.save({lastUpdateBy:user.get("userID")},
{success:function(model,response){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}},removeMarker:function(){if(this.marker){this.marker.setMap(null);this.marker=null}},resetTaskItems:function(){$(".task-simple",this.el).empty();if(this.collection.length==0)$(".task-simple",this.el).append("<div class='line'>-</div>");else{var self=this;this.collection.sort();_(this.collection.models).each(function(item,
index){var taskNum=taskNumber(item.get("taskOrder"));$(".task-simple",self.el).append($("<div class='line' />").text(item.get("question")).prepend(taskNum))},this)}},showDetail:function(){appRouter.content.subviews["cps"].showCPDetail(this.model,this.collection)}});window.PlanTripView_CPDetail=window.MapPageView_SubView.extend({viewEl:".left .subpage[subpage=cp] .checkpoint-detail",el:".left .subpage[subpage=cp] .checkpoint-detail",initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},
removeBoundFunc:function(){},initialRender:true,loadSubviews:function(){this.subviews["tasks"]=new PlanTripView_Tasks({model:this.model,collection:this.collection})},events:{"click .btnCPEdit":"editCP","click .btnCPDelete":"deleteCP","click .btnClose":"closeEditCP","click .btnSave":"saveCP","click .btnUpdatePin":"updateMarker","click #btnReorderTask":"reorderTask","click #btnReturnTask":"returnTask"},modelEvents:{"change":"updateLayout2"},render:function(){var obj=this.render2({cpObj:this.model.toJSON()});
$(".checkpoint-edit",this.el).hide();return obj},updateLayout:function(){this.render3(".checkpoint-main",{cpObj:this.model.toJSON()});this.render3(".checkpoint-edit",{cpObj:this.model.toJSON()});$(".checkpoint-edit",this.el).hide();$(".checkpoint-main",this.el).show();if($("textarea.webedit",this.el).length>0)$("textarea.webedit",this.el).webedit();return this},updateLayout2:function(){if(this.model.hasChanged("name"))this.updateLayout();else{$(".lat").text(this.model.get("lat"));$(".lng").text(this.model.get("lng"));
$("#editCP-lat").val(this.model.get("lat"));$("#editCP-lng").val(this.model.get("lng"))}return this},reorderTask:function(){if(this.subviews["reordertasks"]!=null)this.subviews["reordertasks"].unrender();if(this.subviews["tasks"]!=null)this.subviews["reordertasks"]=new PlanTripView_ReorderTasks({model:this.model,collection:this.subviews["tasks"].collection});else this.subviews["reordertasks"]=new PlanTripView_ReorderTasks({model:this.model});$(".checkpoint-tasks",this.el).hide();$(".checkpoint-tasks-reorder",
this.el).show()},returnTask:function(){this.subviews["tasks"].reorderItems();$(".checkpoint-tasks-reorder",this.el).hide();$(".checkpoint-tasks",this.el).show()},editCP:function(){$(".checkpoint-edit",this.el).show();$(".checkpoint-main",this.el).hide()},closeEditCP:function(){$(".checkpoint-edit",this.el).hide();$(".checkpoint-main",this.el).show()},updateMarker:function(){if($("#editCP-lat, #editCP-lng",this.el).checkValidityAll()){this.model.set({lat:$("#editCP-lat",this.el).val(),lng:$("#editCP-lng",
this.el).val()},{silent:true});if(this.model.hasChanged()){appRouter.siteFooter.show({action:"updating"});this.model.save({lastUpdateBy:user.get("userID")},{success:function(model,response){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}}else appRouter.siteFooter.show({action:"msg",msg:dict('Please enter valid "latitude" and "longitude".'),"alert":true})},saveCP:function(){if($("#editCP-name, #editCP-lat, #editCP-lng",
this.el).checkValidityAll()){var self=this;this.model.set({name:$("#editCP-name",this.el).val(),lat:$("#editCP-lat",this.el).val(),lng:$("#editCP-lng",this.el).val(),description:$("#editCP-description",this.el).val()},{silent:true});if(this.model.hasChanged()){appRouter.siteFooter.show({action:"updating"});this.model.save({lastUpdateBy:user.get("userID")},{success:function(model,response,options){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")});self.updateLayout()},
error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}$(".checkpoint-edit",this.el).hide();$(".checkpoint-main",this.el).show()}else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter checkpoint "name" and valid "latitude" and "longitude".')})},deleteCP:function(){if(confirm(dict("Are you sure to delete this checkpoint?"))){$(".left .subpage[subpage=cp] .slider").removeClass("open");appRouter.content.subviews["cps"].showCPDetail(null);
this.model.destroy({wait:true,success:function(){appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Deleted")})},error:function(){}})}}});window.PlanTripView_SearchCPs=window.MapPageView_SubView.extend({viewEl:".main .subpage[subpage=cp]",el:".main .subpage[subpage=cp]",marker:null,listener:null,initialRender:false,initializeBoundFunc:function(){_.bindAll(this,"render","loadCPs")},init:function(){this.collection=new CheckpointCollection},collectionEvents:{"reset":"resetItems","remove":"removeItem",
"add":"appendItem"},showResults:function(turnOn){if(turnOn){this.loadCPs();this.listener=google.maps.event.addListener(this.map(),"dragend",this.loadCPs)}else{if(this.listener!=null){google.maps.event.removeListener(this.listener);this.listener=null}if(this.marker!=null)this.marker.setMap(null)}try{_(this.collection.models).each(function(item,index){try{item.view.showHideGeo(turnOn)}catch(err){}},this)}catch(err2){}},loadCPs:function(){var obj=this.mapCanvas_getCentre();this.collection.fetchParams.excludeKey=
this.model.id;this.collection.fetchParams.lat=obj.mapCentre_lat;this.collection.fetchParams.lng=obj.mapCentre_lng;this.collection.fetchParams.searchRange=5E3;this.collection.fetchParams.maxItems=20;this.fetchCPs()},fetchCPs:function(){var self=this;this.collection.fetch({data:{mode:"searchCP"},update:true,add:true,remove:true})},render:function(){$("#closestCPList",this.el).empty()},resetItems:function(models){this.unloadSubviews();$("#closestCPList",this.el).empty();this.appendItems()},removeItem:function(item){item.view.remove();
this.subviews[item.view.cid]=null},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){if(self.collection.fetchParams.start!=null)if(index<self.collection.fetchParams.start)return true;self.appendItem(item)},this);if(this.collection.hasMore());else if(this.collection.length==0)if(this.collection.fetchParams.start==null);},appendItem:function(item){var itemView=new PlanTripView_SearchCP({model:item,param:this.options.param});item.view=itemView;this.subviews[itemView.cid]=
itemView;$("#closestCPList",this.el).append(itemView.$el)}});window.PlanTripView_SearchCP=window.MapPageView_SubView.extend({viewEl:".closestCPItem",el:null,tagName:"div",className:"closestCPItem",events:{"mouseenter .closestCPItem-content":"overCP","mouseleave .closestCPItem-content":"leaveCP","touchstart .closestCPItem-content":"overCP","touchend .closestCPItem-content":"leaveCP","touchcancel .closestCPItem-content":"leaveCP","click .btnAdd":"addCP"},modelEvents:{"remove":"unrender"},icon:null,
marker:null,initializeBoundFunc:function(){_.bindAll(this,"render")},initialRender:true,render:function(){return this.render2({cpObj:this.model.toJSON()})},addCP:function(){appRouter.content.subviews["cps"].addItem_closest(this.model)},load:function(){this.geo()},overCP:function(){var icon=$.extend({},this.icon,{strokeColor:"black",scale:5,fillOpacity:1,strokeWeight:2});if(this.marker!=null)this.marker.setOptions({icon:icon,zIndex:1})},leaveCP:function(){if(this.marker!=null)this.marker.setOptions({icon:this.icon,
zIndex:0})},geo:function(){this.icon={path:google.maps.SymbolPath.CIRCLE,fillColor:"green",fillOpacity:0.75,strokeColor:"#666666",strokeWeight:1,scale:4,zIndex:0};if(this.marker==null)this.marker=new google.maps.Marker({position:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")),map:this.map(),icon:this.icon,zIndex:0,title:this.model.get("name")})},showHideGeo:function(isShow){if(this.marker!=null)this.marker.setOptions({map:isShow?this.map():null})},removeGeo:function(){if(this.marker!=
null){this.marker.setOptions({map:null});this.marker=null}},remove:function(){this.removeGeo();this._remove();$(this.$el).remove()},unrender:function(){}})})(jQuery);(function($){window.PlanTripView_ReorderCPs=window.MapPageView_SubView.extend({viewEl:".left .subpage[subpage=cpreorder]",el:".left .subpage[subpage=cpreorder]",parentView:"PlanTripView",initialRender:false,hasLoaded:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){if(this["collection"]==null)this.collection=new CheckpointCollection;else this.hasLoaded=true;this.collection.comparator=function(cp){return cp.get("cpOrder")};this.collection.fetchParams.mapKey=this.model.id},
events:{},collectionEvents:{"reset":"resetItems"},load:function(){if(!this.hasLoaded)this.updateLayout();else this.resetItems()},updateLayout:function(){this.collection.fetch()},resetItems:function(){$(".checkpoints",this.el).empty();this.appendItems()},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new PlanTripView_ReorderCP({model:item});item.orderView=itemView;itemView.parent=
this;this.subviews[itemView.cid]=itemView;$(".checkpoints",this.el).append(itemView.$el)},swapItems:function(itemView,toMoveUp){var item=itemView.model;var ids=this.collection.pluck("id");var pos=ids.indexOf(item.id);if(toMoveUp){if(pos>0){var preItem=this.collection.at(pos-1);var preOrder=preItem.get("cpOrder");var itemOrder=item.get("cpOrder");item.set("cpOrder",preOrder);preItem.set("cpOrder",itemOrder);$(itemView.el).insertBefore($(preItem.orderView.el));this.collection.sort()}}else if(pos<ids.length-
1){var nextItem=this.collection.at(pos+1);var nextOrder=nextItem.get("cpOrder");var itemOrder=item.get("cpOrder");item.set("cpOrder",nextOrder);nextItem.set("cpOrder",itemOrder);$(itemView.el).insertAfter($(nextItem.orderView.el));this.collection.sort()}},unrender:function(){this.removeBoundFunc();this.unbindModelAndCollection();this.unloadSubviews();this.undelegateEvents()}});window.PlanTripView_ReorderCP=window.MapPageView_SubView.extend({viewEl:".checkpoint",el:null,tagName:"div",className:"checkpoint section",
parent:null,init:function(){},load:function(){},initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},initialRender:true,events:{"click .btnMoveUp, .btnMoveDown":"moveUpDown"},modelEvents:{"change":"updateLayout"},render:function(){this.updateLayout();return this},updateLayout:function(){var obj=this.render2({cpObj:this.model.toJSON()});return obj},moveUpDown:function(e){this.parent.swapItems(this,$(e.currentTarget).is(".btnMoveUp"))}})})(jQuery);(function($){window.PlanTripView_Tasks=window.MapPageView_SubView.extend({viewEl:".left .subpage[subpage=cp] .checkpoint-tasks",el:".left .subpage[subpage=cp] .checkpoint-tasks",initialRender:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){},events:{"click .btnTaskAdd":"addItem"},collectionEvents:{"reset":"resetItems","remove":"removeItem"},load:function(){this.updateLayout()},updateLayout:function(){this.resetItems()},removeItem:function(){var url=this.collection.url();
var self=this;$.ajax({async:false,dataType:"json",url:url,data:{orderOnly:true},success:function(_models){$.each(_models,function(index,_model){if(Convert.ToInt(_model.mapID)==self.model.get("mapID")&&Convert.ToInt(_model.cpID)==self.model.id){var model=self.collection.get(Convert.ToInt(_model.id));if(model!=null)model.set("taskOrder",Convert.ToInt(_model.taskOrder))}})}})},resetItems:function(){$(".tasks",this.el).empty();this.appendItems()},reorderItems:function(){appRouter.siteFooter.show({action:"updating"});
var idAndOrders=[];var self=this;_(this.collection.models).each(function(item,index){$(".tasks",this.el).append(item.view.$el);idAndOrders.push({id:item.id,taskOrder:item.get("taskOrder")})},this);var url=this.collection.url();$.ajax({type:"POST",contentType:"application/json",dataType:"json",url:url,data:Convert.JsonToString({mode:"reorder",newOrders:idAndOrders}),success:function(_model){var lastUpdate=Convert.ToDateTime(_model.lastUpdateTS,true);appRouter.siteFooter.show({action:"save",lastUpdate:lastUpdate})},
error:function(xhr){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new PlanTripView_Task({model:item});item.view=itemView;this.subviews[itemView.cid]=itemView;$(".tasks",this.el).append(itemView.$el)},addItem:function(){if(this.subviews["newTask"]==null){$("#btnTaskAdd",this.el).hide();this.subviews["newTask"]=new PlanTripView_NewTask({model:new TaskModel({mapID:this.model.get("mapID"),
cpID:this.model.get("id"),taskOrder:this.collection.length+1})});this.subviews["newTask"].parent=this}},addItem_fail:function(){$("#btnTaskAdd",this.el).show();this.subviews["newTask"]=null},addItem_success:function(){var self=this;var newTask=this.subviews["newTask"].model;self.appendItem(newTask,self.collection.length);$("#btnTaskAdd",self.el).show();this.collection.add(newTask);this.subviews["newTask"]=null}});window.PlanTripView_NewTask=window.MapPageView_SubView.extend({viewEl:".task-new",el:".task-new",
parent:null,initialRender:true,events:{"click .btnTaskClose":"close","click .btnTaskSave":"save","change #newTask-answerType":"changeAnsType","click .btnOptionAdd":"addOption","click .btnOptionRemove":"removeOption"},render:function(){return this.updateLayout()},updateLayout:function(){var obj=this.render2({taskObj:this.model.toJSON(),param:{cid:this.cid}});if(this.model.get("answerType")==2)$("input[type=radio]",this.el).mustSelect();if($("textarea.webedit",this.el).length>0)$("textarea.webedit",
this.el).webedit();return obj},changeAnsType:function(){this.storeTaskToModel();var ansType_o=this.model.get("answerType");var ansType_n=parseInt($("#newTask-answerType",this.el).val(),10);if(ansType_o!=ansType_n){switch(ansType_n){case 0:case 5:case 6:case 7:this.model.set({answer:null,answerOptions:null},{silent:true});break;case 1:switch(ansType_o){case 0:case 5:case 6:case 7:this.model.set({answer:null,answerOptions:null},{silent:true});break;case 2:this.model.set({answerOptions:null},{silent:true});
break;case 3:var ansArr=Convert.StringToJson(this.model.get("answer"));this.model.set({answer:ansArr.length>0?ansArr[0]:"",answerOptions:null},{silent:true});break;case 4:break}break;case 4:switch(ansType_o){case 0:case 2:case 3:case 5:case 6:case 7:this.model.set({answer:true,answerOptions:null},{silent:true});break;case 1:this.model.set({answer:Convert.ToBoolean(this.model.get("answer")),answerOptions:null},{silent:true});break}break;case 2:switch(ansType_o){case 0:case 1:case 4:case 5:case 6:case 7:var key=
"";if(ansType_o==1)key=this.model.get("answer");if(key==null||key=="")key="Option 1";var opts={};opts[key]=true;if(ansType_o==4)opts[key]=Convert.ToBoolean(this.model.get("answer"));this.model.set({answer:key,answerOptions:Convert.JsonToString(opts)},{silent:true});break;case 3:var ansArr=Convert.StringToJson(this.model.get("answer"));var ansOpts=Convert.StringToJson(this.model.get("answerOptions"));var ans=ansArr.length>0?ansArr[0]:_.keys(ansOpts)[0];if(ansArr.length>1)$.each(ansOpts,function(key){ansOpts[key]=
ansOpts[key]==ans});this.model.set({answer:ans,answerOptions:Convert.JsonToString(ansOpts)},{silent:true});break}break;case 3:switch(ansType_o){case 0:case 1:case 4:case 5:case 6:case 7:var key="";if(ansType_o==1)key=this.model.get("answer");if(key==null||key=="")key="Option 1";var opts={};opts[key]=true;var answerArr=[];if(ansType_o==4){opts[key]=Convert.ToBoolean(this.model.get("answer"));if(opts[key])answerArr.push(key)}else answerArr.push(key);this.model.set({answer:Convert.JsonToString(answerArr),
answerOptions:Convert.JsonToString(opts)},{silent:true});break;case 2:var answerArr=[];answerArr.push(this.model.get("answer"));this.model.set({answer:Convert.JsonToString(answerArr)},{silent:true});break}break}this.model.set({answerType:ansType_n},{silent:true});this.updateLayout()}},addOption:function(){this.storeTaskToModel();var ansOpts=Convert.StringToJson(this.model.get("answerOptions"));if(ansOpts["New Option"]==null)ansOpts["New Option"]=false;else{var i=2;while(ansOpts["New Option "+i]!=
null)i++;ansOpts["New Option "+i]=false}this.model.set({answerOptions:Convert.JsonToString(ansOpts)},{silent:true});return this.updateLayout()},removeOption:function(e){$(e.currentTarget).parents(".answerOption").remove();this.storeTaskToModel();return this.updateLayout()},storeTaskToModel:function(){var ansType_o=this.model.get("answerType");switch(ansType_o){case 0:case 5:case 6:case 7:this.model.set({question:$("#newTask-question",this.el).val(),question2:$("#newTask-question2",this.el).val(),
answer:null,answerOptions:null},{silent:true,validate:false});break;case 1:this.model.set({question:$("#newTask-question",this.el).val(),question2:$("#newTask-question2",this.el).val(),answer:$("#newTask-answer",this.el).val(),answerOptions:null},{silent:true,validate:false});break;case 2:case 3:var opts={};var ans=[];if(ansType_o==2)$("input[type=radio]",this.el).mustSelect();$(".answerOption",this.el).each(function(){var key=$.trim($(".newTask-answer",this).val());var val=$("input[type=radio], input[type=checkbox]",
this).check();if(key!=null&&key!="")if(opts[key]==null){opts[key]=val;if(val==true)ans.push(key)}});if(_.isEmpty(opts)){var key="Option 1";opts[key]=true;ans.push(key)}this.model.set({question:$("#newTask-question",this.el).val(),question2:$("#newTask-question2",this.el).val(),answer:ansType_o==2?ans[0]:Convert.JsonToString(ans),answerOptions:Convert.JsonToString(opts)},{silent:true,validate:false});break;case 4:this.model.set({question:$("#newTask-question",this.el).val(),question2:$("#newTask-question2",
this.el).val(),answer:Convert.ToBoolean($("input[type=radio]",this.el).selectedValue()),answerOptions:null},{silent:true,validate:false});break}},save:function(){var self=this;this.storeTaskToModel();if($("#newTask-question, .newTask-answer",this.el).checkValidityAll()){appRouter.siteFooter.show({action:"updating"});this.model.save({creatorID:user.get("userID")},{success:function(model,response){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")});self.parent.addItem_success(model);
self.unrender()},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}else if($(".newTask-answer",this.el).length==0)appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter "task name".')});else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter "task name" and "answer".')})},unrender:function(){this.remove()},close:function(){this.unrender();this.model=null;this.parent.addItem_fail()}});window.PlanTripView_Task=
window.MapPageView_SubView.extend({viewEl:".task",el:null,tagName:"div",className:"task subsection",initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},initialRender:true,events:{"click .btnTaskEdit":"editTask","click .btnTaskDelete":"deleteTask","click .btnTaskClose":"closeEditTask","click .btnTaskSave":"saveTask","click .btnOptionAdd":"addOption","click .btnOptionRemove":"removeOption"},modelEvents:{"change":"updateLayout","remove":"unrender"},render:function(){return this.updateLayout()},
unrender:function(){this.remove();$(this.$el).remove()},updateLayout:function(){var obj=this.render2({taskObj:this.model.toJSON()});$(".task-edit",this.el).hide();if($("textarea.webedit",this.el).length>0)$("textarea.webedit",this.el).webedit();return obj},editTask:function(){$(".task-edit",this.el).show();$(".task-main",this.el).hide()},closeEditTask:function(){$(".task-edit",this.el).hide();$(".task-main",this.el).show()},addOption:function(){this.storeTaskToModel();var ansOpts=Convert.StringToJson(this.model.get("answerOptions"));
if(ansOpts["New Option"]==null)ansOpts["New Option"]=false;else{var i=2;while(ansOpts["New Option "+i]!=null)i++;ansOpts["New Option "+i]=false}this.model.set({answerOptions:Convert.JsonToString(ansOpts)},{silent:true});this.updateLayout();this.editTask();return this},removeOption:function(e){$(e.currentTarget).parents(".task-edit .answerOption").remove();this.storeTaskToModel();this.updateLayout();this.editTask();return this},storeTaskToModel:function(){var ansType_o=this.model.get("answerType");
switch(ansType_o){case 0:case 5:case 6:case 7:this.model.set({question:$("#editTask-question",this.el).val(),question2:$("#editTask-question2",this.el).val(),answer:null,answerOptions:null},{silent:true});break;case 1:this.model.set({question:$("#editTask-question",this.el).val(),question2:$("#editTask-question2",this.el).val(),answer:$("#editTask-answer",this.el).val(),answerOptions:null},{silent:true});break;case 2:case 3:var opts={};var ans=[];if(ansType_o==2)$(".task-edit input[type=radio]",this.el).mustSelect();
$(".task-edit .answerOption",this.el).each(function(){var key=$.trim($(".editTask-answer",this).val());var val=$("input[type=radio], input[type=checkbox]",this).check();if(key!=null&&key!="")if(opts[key]==null){opts[key]=val;if(val==true)ans.push(key)}});if(_.isEmpty(opts)){var key="Option 1";opts[key]=true;ans.push(key)}this.model.set({question:$("#editTask-question",this.el).val(),question2:$("#editTask-question2",this.el).val(),answer:ansType_o==2?ans[0]:Convert.JsonToString(ans),answerOptions:Convert.JsonToString(opts)},
{silent:true});break;case 4:this.model.set({question:$("#editTask-question",this.el).val(),question2:$("#editTask-question2",this.el).val(),answer:Convert.ToBoolean($(".task-edit input[type=radio]",this.el).selectedValue()),answerOptions:null},{silent:true});break}},saveTask:function(){var self=this;if($("#editTask-question, .editTask-answer",this.el).checkValidityAll()){this.storeTaskToModel();if(this.model.hasChanged()){appRouter.siteFooter.show({action:"updating"});this.model.save({lastUpdateBy:user.get("userID")},
{success:function(model,response){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")});self.updateLayout()},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}$(".task-edit",this.el).hide();$(".task-main",this.el).show()}else if($(".editTask-answer",this.el).length==0)appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter "task name".')});else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter "task name" and "answer".')})},
deleteTask:function(){if(confirm(dict("Are you sure to delete this task?"))){appRouter.siteFooter.show({action:"updating"});this.model.destroy({wait:true,success:function(){appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Deleted")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}}})})(jQuery);(function($){window.PlanTripView_ReorderTasks=window.MapPageView_SubView.extend({viewEl:".left .subpage[subpage=cp] .checkpoint-tasks-reorder",el:".left .subpage[subpage=cp] .checkpoint-tasks-reorder",initialRender:false,hasLoaded:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){if(this["collection"]==null)this.collection=new TaskCollection;else this.hasLoaded=true;this.collection.comparator=function(task){return task.get("taskOrder")}},events:{},collectionEvents:{"reset":"resetItems"},
load:function(){if(!this.hasLoaded)this.updateLayout();else this.resetItems()},updateLayout:function(){this.collection.fetch()},resetItems:function(){$(".tasks",this.el).empty();this.appendItems()},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new PlanTripView_ReorderTask({model:item});item.orderView=itemView;itemView.parent=this;this.subviews[itemView.cid]=itemView;$(".tasks",
this.el).append(itemView.$el)},swapItems:function(itemView,toMoveUp){var item=itemView.model;var ids=this.collection.pluck("id");var pos=ids.indexOf(item.id);if(toMoveUp){if(pos>0){var preItem=this.collection.at(pos-1);var preOrder=preItem.get("taskOrder");var itemOrder=item.get("taskOrder");item.set("taskOrder",preOrder);preItem.set("taskOrder",itemOrder);$(itemView.el).insertBefore($(preItem.orderView.el));this.collection.sort()}}else if(pos<ids.length-1){var nextItem=this.collection.at(pos+1);
var nextOrder=nextItem.get("taskOrder");var itemOrder=item.get("taskOrder");item.set("taskOrder",nextOrder);nextItem.set("taskOrder",itemOrder);$(itemView.el).insertAfter($(nextItem.orderView.el));this.collection.sort()}},unrender:function(){this.removeBoundFunc();this.unbindModelAndCollection();this.unloadSubviews();this.undelegateEvents()}});window.PlanTripView_ReorderTask=window.MapPageView_SubView.extend({viewEl:".task",el:null,tagName:"div",className:"task subsection",parent:null,init:function(){},
load:function(){},initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},initialRender:true,events:{"click .btnMoveUp, .btnMoveDown":"moveUpDown"},modelEvents:{"change":"updateLayout"},render:function(){this.updateLayout();return this},updateLayout:function(){var obj=this.render2({taskObj:this.model.toJSON()});return obj},moveUpDown:function(e){this.parent.swapItems(this,$(e.currentTarget).is(".btnMoveUp"))}})})(jQuery);(function($){window.PreTripView=window.MapPageView.extend({intervalVal:null,initializeBoundFunc:function(){_.bindAll(this,"changeCentre","mapCanvas_getCentre","autoDisplay","displayTimerPanel","displayGeolocation","timerEvent_func","goMyPosition_setLoc");user.addMap(this.model.id)},removeBoundFunc:function(){clearInterval(this.intervalVal);this.intervalVal=null;this.timer.off();if(this.timer.isEnded())this.timer.destroy()},init:function(){this.timer=timerCollection.getTimer({mapKey:this.model.id,
mode:"pre"});this.timer.on("timerEvent",this.timerEvent_func,this)},loadSubviews:function(){this.subviews["notes"]=new PreTripView_Notes({model:this.model});this.subviews["plot"]=new PreTripView_Plot({model:this.model});this.subviews["cps"]=new PreTripView_CPs({model:this.model})},events:{"click .selectmode a":"clickMode","subpageChanged":"changedSubPage","change .flipper select#cpRange":"changeAdvance","click #btnChangeCentre":"changeCentre","click #btnReturnCentre":"returnCentre","click #btnMyPosition":"goMyPosition",
"click .btnStartTrip":"startTimer","click .btnEndTrip":"endTimer","click .btnPauseTrip":"pauseTimer","click .btnResumeTrip":"resumeTimer","click .btnResetTrip":"resetTimer","click .btnNoteAdd":"addNote","click #btnViewReport":"viewCPReport","click #btnDownloadReport":"downloadCPReport"},load:function(){this.displayTimer();this.intervalVal=setInterval(_.bind(this.autoDisplay,this),1E3);$(".compass").trigger("CompassEvent",{name:"compassUpdated"})},loadMap_events:function(){},timerEvent_func:function(e){var content=
e.name;switch(e.name){case "startTimer":content="Start Trip";break;case "stopTimer":content="End Trip";break;case "pauseTimer":content="Pause";break;case "resumeTimer":content="Resume";break;case "resetTimer":content="- RESET -";break}this.subviews["notes"].collection.create({mapKey:this.model.id,mode:"pre",createDate:e.time,elapsed:e.elapsed,content:content})},changedSubPage:function(e,pageObj){switch(pageObj.from){case "cp":break;case "basic":this.save();break;case null:break}switch(pageObj.to){case "cp":break}},
changeAdvance:function(e){var val=null;var id=$(e.currentTarget).attr("id");var obj={};switch(id){case "cpRange":val=$(e.currentTarget).val();break;default:return}obj[id]=val;this.model.set(obj,{silent:true});if(id=="cpRange")try{this.currLocRange.setOptions({radius:Convert.ToInt(this.model.get("cpRange"))});this.save()}catch(err){}try{$(e.currentTarget).parents(".flipper").first().find(".note:not(.psnote)").text(OPTIONS[id][val])}catch(err){}},addNote:function(){var time=(new Date).getTime();var geo=
appFunc.geolocation?{lat:appFunc.geolocation.lat,lng:appFunc.geolocation.lng}:null;this.subviews["notes"].collection.create({mapKey:this.model.id,mode:"pre",geolocation:geo,createDate:time,elapsed:this.timer.isStarted()?this.timer.getElapsedTime_timestamp(time):null,content:$("#note",this.el).val()});$("#note",this.el).val("")},autoDisplay:function(){this.displayTimerPanel();this.displayGeolocation()},startTimer:function(){if(!this.timer.isStarted())this.timer.start();else if(this.timer.isEnded()){var _timer=
timerCollection.getTimer({mapKey:this.model.id,mode:"pre"});if(this.timer!=_timer){this.timer.off();this.timer.destroy()}this.timer=_timer;this.timer.on("timerEvent",this.timerEvent_func,this);this.timer.start()}this.displayTimer()},pauseTimer:function(){if(this.timer.isStarted()&&!this.timer.isEnded()&&!this.timer.isPaused())this.timer.pause();this.displayTimer()},resumeTimer:function(){if(this.timer.isStarted()&&!this.timer.isEnded()&&this.timer.isPaused())this.timer.resume();this.displayTimer()},
endTimer:function(){if(!this.timer.isEnded())this.timer.end();this.displayTimer()},resetTimer:function(){this.timer.reset();this.displayTimer()},displayTimer:function(){var self=this;$(".btnStartTrip, .btnEndTrip, .btnResumeTrip, .btnPauseTrip",this.el).removeClass("greenbg greybg-lt").addClass(function(){return(self.timer.isStarted()&&!self.timer.isEnded())==$(this).is(".btnEndTrip, .btnResumeTrip, .btnPauseTrip")?"greenbg":"greybg-lt"});if(this.timer.isPaused()){$(".btnPauseTrip",this.el).hide();
$(".btnResumeTrip",this.el).show()}else{$(".btnResumeTrip",this.el).hide();$(".btnPauseTrip",this.el).show()}this.displayTimerPanel()},displayTimerPanel:function(){if(this.timer.isStarted()){var timerCount=this.timer.isEnded()?this.timer.getElapsedTime_hhmmss(this.timer.get("endTime")):this.timer.getElapsedTime_hhmmss();$(".timer-display").text(timerCount.hh+":"+timerCount.mm+":"+timerCount.ss)}else $(".timer-display").text("--:--:--")},displayGeolocation:function(){if(appFunc.geolocation==null);
else{$("#currLat",this.el).text(appFunc.geolocation.lat);$("#currLng",this.el).text(appFunc.geolocation.lng)}},goMyPosition:function(){this.gps_getLocation(this.goMyPosition_setLoc)},goMyPosition_setLoc:function(position){var pos=$.extend(this.mapCanvas_getCentre(),{"mapCentre_lat":position.lat,"mapCentre_lng":position.lng});this.mapCanvas_setCentre(pos)},returnCentre:function(){var pos=this.mapModel_getCentre();this.mapCanvas_setCentre(pos)},changeCentre:function(){var pos=this.mapCanvas_getCentre();
this.mapModel_setCentre(pos,true).mapInput_setCentre(pos);this.save()},saveMap:function(){this.save()},save:function(){if(this.model.hasChanged()){appRouter.siteFooter.show({action:"updating"});this.model.save({mode:"pre",lastUpdateBy:user.get("userID")},{success:function(model,response,options){model.set({});appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}}});window.PreTripView_Notes=
window.MapPageView_SubView.extend({viewEl:".main .section.notes",el:".main .section.notes",parent:null,temp:null,initialRender:true,init:function(){this.collection=new NoteCollection;this.temp=$(".pretripNoteItem",this.el).clone()},events:{"click .btnNoteClear":"clearNotes"},render:function(){$(".pretripNoteItem",this.el).remove();return this},collectionEvents:{"reset":"resetItems","add":"appendItem"},load:function(){this.updateLayout()},updateLayout:function(){this.collection.reset(noteCollection.getNotes({mapKey:this.model.id,
mode:"pre"}))},clearNotes:function(){var self=this;var noteModels=this.collection.models;for(var i=noteModels.length-1;i>=0;i--){this.subviews[noteModels[i].view.cid]=null;delete this.subviews[noteModels[i].view.cid];noteModels[i].view.removeGeo();noteModels[i].destroy()}$(".pretripNoteItem",this.el).remove();this.updateLayout()},resetItems:function(){$(".pretripNoteItem",this.el).remove();this.appendItems()},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,
index)},this)},appendItem:function(item,index){var itemView=new PreTripView_NoteItem({model:item});item.view=itemView;this.subviews[itemView.cid]=itemView;$("#pretripNoteList",this.el).append(itemView.$el)}});window.PreTripView_NoteItem=window.MapPageView_SubView.extend({viewEl:".pretripNoteItem",el:null,tagName:"div",className:"pretripNoteItem",initialRender:true,marker:null,events:{"click .geo":"geo"},render:function(){var obj=this.render2();var noteEl=this.$el;var createDate=Convert.ToDateTime(this.model.get("createDate"));
var createDateStr=moment(createDate).format("YYYY/M/D")+"<br />"+moment(createDate).format("HH:mm:ss");noteEl.children(":eq(0)").html(createDateStr);if(this.model.get("elapsed")==null)noteEl.children(":eq(2)").text("--:--:--");else{var elapsedObj=Convert.ToHhmmss(this.model.get("elapsed"));var elapsedStr=elapsedObj.hh+":"+elapsedObj.mm+":"+elapsedObj.ss;noteEl.children(":eq(2)").text(elapsedStr)}noteEl.children(":eq(3)").text(this.model.get("content"));if(this.model.get("geolocation")==null)$(".geo",
this.el).hide()},geo:function(){var geolocation=this.model.get("geolocation");if(geolocation!=null){var icon="http://chart.apis.google.com/chart?chst=d_map_xpin_letter&chld=pin||00FFFF|000000";if(this.marker==null)this.marker=new google.maps.Marker({position:new google.maps.LatLng(geolocation.lat,geolocation.lng),map:this.map(),icon:icon,zIndex:0});else this.removeGeo();var pos=$.extend(this.mapCanvas_getCentre(),{"mapCentre_lat":geolocation.lat,"mapCentre_lng":geolocation.lng});this.mapCanvas_setCentre(pos);
if(appRouter.content.subpage=="data")location.href="#mode/pre/"+appRouter.content.model.id+"/map"}},removeGeo:function(){if(this.marker!=null){this.marker.setOptions({map:null});this.marker=null}}});window.PreTripView_Plot=window.MapPageView_SubView.extend({viewEl:".main .subpage[subpage=basic] .track",el:".main .subpage[subpage=basic] .track",trackLatLngs:null,boundaryLatLngs:null,trackColor:"blue",boundaryColor:"red",trackPolyline:null,boundaryPolyline:null,initialRender:true,initializeBoundFunc:function(){_.bindAll(this,
"createPolyline");this.trackLatLngs=[];this.boundaryLatLngs=[]},render:function(){this.loadModel();return this},getPolylinePathByLatLngs:function(latlngs,isClosedPath){var path=[];for(var i=0;i<latlngs.length;i++)path.push(latlngs[i]);if(isClosedPath&&path.length>=3)path.push(latlngs[0]);return path},createPolyline:function(latlngs,color,isPolygon){var path=this.getPolylinePathByLatLngs(latlngs,isPolygon);var opt={path:path,strokeColor:color,strokeWeight:1.5,strokeOpacity:0.75,fillOpacity:0,editable:false,
map:this.map(),zIndex:1};var polyline=new google.maps.Polyline(opt);return polyline},loadModel:function(){var self=this;if(!_.isNull(this.model.get("plotBoundary"))){var arr=$.parseJSON(this.model.get("plotBoundary"));if(_.isArray(arr))for(var i=0;i<arr.length;i++){var latlng=new google.maps.LatLng(arr[i].lat,arr[i].lng);self.boundaryLatLngs.push(latlng)}}if(self.boundaryPolyline)self.boundaryPolyline.setMap(null);if(self.boundaryLatLngs.length>0){self.boundaryPolyline=self.createPolyline(self.boundaryLatLngs,
self.boundaryColor,true);$(".lblSuggestedBoundary",this.el).css("color",self.boundaryColor)}else $(".lblSuggestedBoundary",this.el).hide();if(!_.isNull(this.model.get("plotTrack"))){var arr=$.parseJSON(this.model.get("plotTrack"));if(_.isArray(arr))for(var i=0;i<arr.length;i++){var latlng=new google.maps.LatLng(arr[i].lat,arr[i].lng);self.trackLatLngs.push(latlng)}}if(self.trackPolyline)self.trackPolyline.setMap(null);if(self.trackLatLngs.length>0){self.trackPolyline=self.createPolyline(self.trackLatLngs,
self.trackColor,false);$(".lblSuggestedTrack",this.el).css("color",self.trackColor)}else $(".lblSuggestedTrack",this.el).hide();if(!(self.trackLatLngs.length>0||self.boundaryLatLngs.length>0))$(this.el).hide()}});window.PreTripHeaderView=window.MapHeaderView.extend({})})(jQuery);(function($){window.PreTripView_CPs=window.MapPageView_SubView.extend({viewEl:".left .subpage[subpage=cp]",el:".left .subpage[subpage=cp]",parentView:"PreTripView",initialRender:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){this.collection=new CheckpointCollection;this.collection.comparator=function(cp){return cp.get("cpOrder")};this.collection.fetchParams.mapKey=this.model.id},collectionEvents:{"reset":"resetItems"},load:function(){this.updateLayout()},updateLayout:function(){this.collection.fetch()},
resetItems:function(){$(".checkpoints",this.el).empty();this.appendItems()},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new PreTripView_CP({model:item});this.subviews[itemView.cid]=itemView;$(".checkpoints",this.el).append(itemView.$el)},showCPDetail:function(cpModel,cpCollection){if(this.subviews["cpdetail"])this.subviews["cpdetail"].remove();if(cpModel){this.subviews["cpdetail"]=
new PreTripView_CPDetail({model:cpModel,collection:cpCollection});$("#page").trigger({type:"goTop",slide:true})}}});window.PreTripView_CP=window.MapPageView_SubView.extend({marker:null,infowindow:null,viewEl:".checkpoint",el:null,tagName:"div",className:"checkpoint section",init:function(){this.collection=new TaskCollection;this.collection.comparator=function(task){return task.get("taskOrder")};this.collection.fetchParams.cpID=this.model.id},load:function(){this.collection.fetch()},initializeBoundFunc:function(){_.bindAll(this,
"render","updateLayout","updateByCurrLoc_setLoc","gps_getLocation")},initialRender:true,events:{"click .btnCPDetail":"showDetail","click .btnUpdateCurrLoc":"updateByCurrLoc"},modelEvents:{"change":"updateLayout"},collectionEvents:{"reset":"resetTaskItems"},render:function(){this.updateLayout();this.createMarker();return this},updateLayout:function(){var isOpen=$(".flipper.open",this.el).length>0;var obj=null;if(this.model.hasChanged("lat")||this.model.hasChanged("lng"))obj=this.render3(".cp-latlng",
{cpObj:this.model.toJSON()});else{obj=this.render2({cpObj:this.model.toJSON()});$(".flipper",this.el).toggleClass("open",isOpen)}if(this.marker)this.marker.setPosition(new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")));return obj},updateByCurrLoc:function(){this.gps_getLocation(this.updateByCurrLoc_setLoc)},updateByCurrLoc_setLoc:function(position){this.model.set({lat:position.lat,lng:position.lng},{silent:true});this.model.save({mode:"pre",lastUpdateBy:user.get("userID")},{success:function(model,
response){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})},createMarker:function(){var self=this;var icon="http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+this.model.get("cpOrder")+"|FF0000|000000";this.marker=new google.maps.Marker({position:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")),map:this.map(),icon:icon,title:this.model.get("name")});
this.infowindow=new google.maps.InfoWindow;google.maps.event.addListener(this.marker,"click",function(marker,i){self.infowindow.setContent("<div><strong>"+self.model.get("cpOrder")+". "+_.escape(self.model.get("name"))+"</strong></div>");self.infowindow.open(self.map(),this)})},updateLatLng:function(){var pos=this.marker.getPosition();this.model.set({lat:pos.lat(),lng:pos.lng()},{silent:true});this.model.save({mode:"pre",lastUpdateBy:user.get("userID")},{success:function(model,response){appRouter.siteFooter.show({action:"save",
lastUpdate:model.get("lastUpdateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})},removeMarker:function(){if(this.marker){this.marker.setMap(null);this.marker=null}},resetTaskItems:function(){$(".task-simple",this.el).empty();if(this.collection.length==0)$(".task-simple",this.el).append("<div class='line'>-</div>");else{var self=this;_(this.collection.models).each(function(item,index){var taskNum=taskNumber(item.get("taskOrder"));$(".task-simple",
self.el).append($("<div class='line' />").text(item.get("question")).prepend(taskNum))},this)}},showDetail:function(){appRouter.content.subviews["cps"].showCPDetail(this.model,this.collection)}});window.PreTripView_CPDetail=window.MapPageView_SubView.extend({viewEl:".left .subpage[subpage=cp] .checkpoint-detail",el:".left .subpage[subpage=cp] .checkpoint-detail",initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout","updateByCurrLoc","updateByCurrLoc_setLoc","gps_getLocation")},removeBoundFunc:function(){},
initialRender:true,loadSubviews:function(){this.subviews["tasks"]=new PreTripView_Tasks({model:this.model,collection:this.collection})},modelEvents:{"change":"updateLayout"},events:{"click .btnUpdateCurrLoc":"updateByCurrLoc"},render:function(){var obj=this.render2({cpObj:this.model.toJSON()});return obj},updateLayout:function(){this.render3(".checkpoint-main",{cpObj:this.model.toJSON()});return this},updateByCurrLoc:function(){this.gps_getLocation(this.updateByCurrLoc_setLoc)},updateByCurrLoc_setLoc:function(position){this.model.set({lat:position.lat,
lng:position.lng},{silent:true});this.model.save({mode:"pre",lastUpdateBy:user.get("userID")},{success:function(model,response){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}})})(jQuery);(function($){window.PreTripView_Tasks=window.MapPageView_SubView.extend({viewEl:".left .subpage[subpage=cp] .checkpoint-tasks",el:".left .subpage[subpage=cp] .checkpoint-tasks",initialRender:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){},collectionEvents:{"reset":"resetItems"},load:function(){this.updateLayout()},updateLayout:function(){this.resetItems()},resetItems:function(){$(".tasks",this.el).empty();this.appendItems()},appendItems:function(){var self=this;_(this.collection.models).each(function(item,
index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new PreTripView_Task({model:item});this.subviews[itemView.cid]=itemView;$(".tasks",this.el).append(itemView.$el)}});window.PreTripView_Task=window.MapPageView_SubView.extend({viewEl:".task",el:null,tagName:"div",className:"task subsection",initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},initialRender:true,modelEvents:{"change":"updateLayout","remove":"unrender"},render:function(){return this.updateLayout()},
unrender:function(){this.remove();$(this.$el).remove()},updateLayout:function(){var obj=this.render2({taskObj:this.model.toJSON()});return obj}})})(jQuery);(function($){window.TheTripInterface={trip:function(){if(appRouter.content&&appRouter.content instanceof window.TheTripView)return appRouter.content.timer;if(appRouter._content&&appRouter._content instanceof window.TheTripView)return appRouter._content.timer;return null},addNote:function(msg){try{var content=null;if(appRouter.content&&appRouter.content instanceof window.TheTripView)content=appRouter.content;else if(appRouter._content&&appRouter._content instanceof window.TheTripView)content=appRouter._content;
var note=noteCollection.create({mapKey:content.model.id,mode:"trip",createDate:(new Date).getTime(),elapsed:null,content:msg});content.subviews["notes"].collection.add(note)}catch(err){}}};window.TheTripView=window.MapPageView.extend(_.extend({intervalVal:null,initializeBoundFunc:function(){_.bindAll(this,"mapCanvas_getCentre","autoDisplay","displayTimerPanel","displayGeolocation","timerEvent_func","goMyPosition_setLoc");user.addMap(this.model.id)},removeBoundFunc:function(){clearInterval(this.intervalVal);
this.intervalVal=null;this.timer.off();if(!this.timer.isStarted())this.timer.destroy()},init:function(){this.timer=tripCollection.getTrip({mapKey:this.model.id,mode:"trip"});this.timer.on("timerEvent",this.timerEvent_func,this)},loadSubviews:function(){this.subviews["notes"]=new TheTripView_Notes({model:this.model});this.subviews["plot"]=new TheTripView_Plot({model:this.model});this.subviews["cps"]=new TheTripView_CPs({model:this.model})},events:{"click .selectmode a":"clickMode","click #btnReturnCentre":"returnCentre",
"click .btnStartTrip":"startTimer","click .btnQuitTrip":"quitTrip","click .btnEndTrip":"endTimer","click #btnSubmit":"submitMap","click #btnMyPosition":"goMyPosition","change #info-name, #info-class, #info-classno":"changeInfo","click .btnToggleQR":"showQR","click .btnGPS-Note":"clickGPSNote","click .btnOfflineUpdate":"clickOfflineUpdate","click .btnOfflineRemove":"clickOfflineRemove"},clickOfflineUpdate:function(){if(!appFunc.isApp())return;try{var networkState=navigator.network.connection.type;
if(networkState==Connection.NONE){appFunc.alert(dict("No Internet.")+"\n"+dict("Please connect to internet."));return}}catch(err){}appRouter.reloadPage()},clickOfflineRemove:function(){if(!appFunc.isApp())return;var self=this;appRouter.siteFooter.show({action:"updating"});$("#page").hide();this.model.destroyOffline({wait:true,success:function(model,response,options){location.href="#page/home";$("#page").show();appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Deleted")})},error:function(model,
xhr,options){appRouter.siteFooter.show({action:"error",xhr:xhr});$("#page").show()}})},load:function(){if(this.timer.isStarted()){this.displayTimer();appRouter.header.started();$("#info-name",this.el).val(this.timer.get("name"));$("#info-class",this.el).val(this.timer.get("infoClass"));$("#info-classno",this.el).val(this.timer.get("infoClassno"));try{var rule=this.timer.get("rule");if(rule!=null){if(rule!=this.model.get("rule")){var alertText=dict("The rule of this trip has been changed.")+"\n"+dict("It is recommended to restart this trip.");
this.addNote(alertText);appRouter.siteFooter.show({action:"cpAlert","alert":true,msg:alertText});this.timer.save({"rule":this.model.get("rule")})}}else this.timer.save({"rule":this.model.get("rule")})}catch(err){}}this.intervalVal=setInterval(_.bind(this.autoDisplay,this),1E3);$(".compass").trigger("CompassEvent",{name:"compassUpdated"})},loadMap_events:function(){},timerEvent_func:function(e){var content=e.name;switch(e.name){case "startTimer":content="Start Trip";this.subviews["notes"].collection.create({mapKey:this.model.id,
mode:"trip",createDate:e.time,elapsed:e.elapsed,content:dict("Welcome to")+" "+this.model.get("name")+dict(".")+" \n"+dict(OPTIONS.rule[this.model.get("rule")])});break;case "stopTimer":content=dict("End Trip");break;case "pauseTimer":content=dict("Pause");break;case "resumeTimer":content=dict("Resume");break;case "resetTimer":content=dict("- RESET -");break}},autoDisplay:function(){this.displayTimerPanel();this.displayGeolocation()},startTimer:function(){if(!this.timer.isStarted()){this.timer.save({"rule":this.model.get("rule")});
this.initTripInfo();this.timer.start();$("#info-name",this.el).val(prompt(dict("Please Enter Your Name")+dict(":"),""));$("#info-class",this.el).val(prompt(dict("Please Enter Your Class")+dict(":"),""));$("#info-classno",this.el).val(prompt(dict("Please Enter Your Class No.")+dict(":"),""));this.changeInfo();appRouter.header.started();location.href="#mode/trip/"+this.model.id+"/cp"}else if(this.timer.isEnded()){var _timer=tripCollection.getTrip({mapKey:this.model.id,mode:"trip"});if(this.timer!=_timer)this.timer.off();
this.timer=_timer;this.timer.on("timerEvent",this.timerEvent_func,this);this.initTripInfo();this.timer.start()}this.displayTimer()},initTripInfo:function(){var cps={};var cpCollection=this.subviews["cps"].collection;var self=this;_(cpCollection.models).each(function(item,index){var tripCP={cpID:item.id,cpOrder:item.get("cpOrder"),lock:true,lockTasks:true,near:false,completed:false,ans:null};switch(this.model.get("rule")){case 0:tripCP.lock=false;tripCP.lockTasks=true;break;case 1:if(tripCP.cpOrder==
1){tripCP.lock=false;tripCP.lockTasks=false}else{tripCP.lock=true;tripCP.lockTasks=true}break;case 2:if(tripCP.cpOrder==1){tripCP.lock=false;tripCP.lockTasks=false}else{tripCP.lock=true;tripCP.lockTasks=true}break;case 3:tripCP.lock=true;tripCP.lockTasks=true;break;case 4:tripCP.lock=false;tripCP.lockTasks=false;break;case 5:tripCP.lock=false;tripCP.lockTasks=true;break;case 6:tripCP.lock=true;tripCP.lockTasks=true;break;case 7:tripCP.lock=false;tripCP.lockTasks=true;break}cps[tripCP.cpID]=tripCP},
this);this.trip().cps=cps;this.trip().saveCPs();_(cpCollection.models).each(function(item,index){item.view.updateLayout()})},quitTrip:function(){if(confirm(dict("Are you sure?"))){this.endTimer();this.subviews["notes"].clearNotes();location.href="#mode/trip"}},endTimer:function(){if(!this.timer.isEnded())this.timer.end();this.displayTimer()},endTimer_fail:function(){if(this.timer.isEnded())this.timer.end_fail();this.displayTimer()},resetTimer:function(){this.timer.reset();this.displayTimer()},displayTimer:function(){var self=
this;if(this.timer.isStarted()){$(".startTrip, .offlinetrip",this.el).hide();$(".quitTrip",this.el).show()}else $(".quitTrip",this.el).hide();this.displayTimerPanel()},displayTimerPanel:function(){if(this.timer.isStarted()){var timerCount=this.timer.isEnded()?this.timer.getElapsedTime_hhmmss(this.timer.get("endTime")):this.timer.getElapsedTime_hhmmss();if(timerCount.H>=100)$(".timer-display").text(timerCount.d+" "+(timerCount.d>1?dict("days"):dict("day")));else $(".timer-display").text(timerCount.HH+
":"+timerCount.mm+":"+timerCount.ss)}else $(".timer-display").text("--:--:--")},displayGeolocation:function(){if(appFunc.geolocation==null);else if(this.timer.isStarted()&&this.subviews["cps"]!=null){$(".btnNear",this.subviews["cps"].el).hide();var cpCollection=this.subviews["cps"].collection;var self=this;var cpRange=self.model.get("cpRange");if(appFunc.geolocation["accuracy"])if(appFunc.geolocation.accuracy>cpRange)cpRange=Math.ceil(appFunc.geolocation.accuracy);_(cpCollection.models).each(function(item,
index){item.withinDistance(cpRange)},this)}},goMyPosition:function(){this.gps_getLocation(this.goMyPosition_setLoc)},goMyPosition_setLoc:function(position){var pos=$.extend(this.mapCanvas_getCentre(),{"mapCentre_lat":position.lat,"mapCentre_lng":position.lng});this.mapCanvas_setCentre(pos)},returnCentre:function(){var pos=this.mapModel_getCentre();this.mapCanvas_setCentre(pos)},changeInfo:function(){$("#info-class",this.el).val(Convert.ToHalfWidthEng($("#info-class",this.el).val()));this.timer.save({"name":$("#info-name",
this.el).val(),"infoClass":$("#info-class",this.el).val(),"infoClassno":$("#info-classno",this.el).val()})},showQR:function(){$(".qr img.imgQR",this.el).toggle()},clickGPSNote:function(){appFunc.alert(dict("The checkpoints/tasks could also be unlocked by entering the checkpoints' passwords."))},submitMap:function(){if($(".basic-information input",this.el).checkValidityAll()){$("#info-class",this.el).val(Convert.ToHalfWidthEng($("#info-class",this.el).val()));if(confirm(dict("Are you sure to submit?"))){this.endTimer();
this.submit()}}else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter your "Name", "Class" and "Class No."!')+"\n"+"(* "+dict("Class No. must be a number.")+")"})},submit:function(){this.trip().saveCPs();this.timer.save({"name":$("#info-name",this.el).val(),"infoClass":$("#info-class",this.el).val(),"infoClassno":$("#info-classno",this.el).val(),"submitted":false});appRouter.header.submitted();appRouter.siteFooter.show({action:"submitting"});this.showSubPage("basic");$(".quitTrip",
this.el).hide();var self=this;if(!self.model.enableSubmit()){var pwd=prompt(dict("Please enter a password for viewing this submission within 24 hours."));if(pwd=="")pwd=null;self.timer.save({"submitted":true,"pwd":pwd});appRouter.siteFooter.show({action:"submit",lastUpdate:new Date});location.href="#mode/after/"+self.model.id}else{var mySubmission=new SubmissionModel;var obj=this.timer.toJSON();obj.id=null;mySubmission.save(obj,{wait:true,success:function(model,response){var pwd=prompt(dict("Please enter a password for viewing this submission within 24 hours."));
if(pwd=="")pwd=null;self.timer.save({"submitted":true,"pwd":pwd});appRouter.siteFooter.show({action:"submit",lastUpdate:model.get("lastUpdateTS")});location.href="#mode/after/"+self.model.id},error:function(model,xhr,options){self.endTimer_fail();appRouter.header.submitted_fail();self.showSubPage("cp");appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}}},window.TheTripInterface));window.TheTripView_Notes=window.MapPageView_SubView.extend(_.extend({viewEl:".main .notes",el:".main .notes",
parent:null,temp:null,initialRender:true,init:function(){this.collection=new NoteCollection},events:{"click .btnNoteClear":"clearNotes"},render:function(){$(".thetripNoteItem",this.el).remove();return this},collectionEvents:{"reset":"resetItems","add":"appendItem"},load:function(){if(!this.trip().isStarted()){$("#thetripNoteList",this.el).empty();this.clearNotes()}else this.updateLayout()},updateLayout:function(){this.collection.reset(noteCollection.getNotes({mapKey:this.model.id,mode:"trip"}))},
clearNotes:function(){var self=this;var noteModels=noteCollection.getNotes({mapKey:this.model.id,mode:"trip"});for(var i=noteModels.length-1;i>=0;i--)noteModels[i].destroy();this.updateLayout()},resetItems:function(){$("#thetripNoteList",this.el).empty();$(".thetripNoteItem",this.el).remove();this.appendItems()},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var lines=item.get("content").split(/\n/gi);
var noteEl=$("<div class='thetripNoteItem' />");var createDate=Convert.ToDateTime(item.get("createDate"));var createDateStr=moment(createDate).format("YYYY/M/D HH:mm:ss");noteEl.append($("<div />").html(createDateStr));$.each(lines,function(){noteEl.append($("<div />").text(this))});$("#thetripNoteList",this.el).prepend(noteEl)}},window.TheTripInterface));window.TheTripView_Plot=window.MapPageView_SubView.extend(_.extend({viewEl:".main .subpage[subpage=basic] .track",el:".main .subpage[subpage=basic] .track",
trackLatLngs:null,boundaryLatLngs:null,trackColor:"blue",boundaryColor:"red",trackPolyline:null,boundaryPolyline:null,initialRender:true,initializeBoundFunc:function(){_.bindAll(this,"createPolyline");this.trackLatLngs=[];this.boundaryLatLngs=[]},render:function(){this.loadModel();return this},getPolylinePathByLatLngs:function(latlngs,isClosedPath){var path=[];for(var i=0;i<latlngs.length;i++)path.push(latlngs[i]);if(isClosedPath&&path.length>=3)path.push(latlngs[0]);return path},createPolyline:function(latlngs,
color,isPolygon){var path=this.getPolylinePathByLatLngs(latlngs,isPolygon);var opt={path:path,strokeColor:color,strokeWeight:1.5,strokeOpacity:0.75,fillOpacity:0,editable:false,map:this.map(),zIndex:1};var polyline=new google.maps.Polyline(opt);return polyline},loadModel:function(){var self=this;if(!_.isNull(this.model.get("plotBoundary"))){var arr=$.parseJSON(this.model.get("plotBoundary"));if(_.isArray(arr))for(var i=0;i<arr.length;i++){var latlng=new google.maps.LatLng(arr[i].lat,arr[i].lng);self.boundaryLatLngs.push(latlng)}}if(self.boundaryPolyline)self.boundaryPolyline.setMap(null);
if(self.boundaryLatLngs.length>0){self.boundaryPolyline=self.createPolyline(self.boundaryLatLngs,self.boundaryColor,true);$(".lblSuggestedBoundary",this.el).css("color",self.boundaryColor)}else $(".lblSuggestedBoundary",this.el).hide();if(!_.isNull(this.model.get("plotTrack"))){var arr=$.parseJSON(this.model.get("plotTrack"));if(_.isArray(arr))for(var i=0;i<arr.length;i++){var latlng=new google.maps.LatLng(arr[i].lat,arr[i].lng);self.trackLatLngs.push(latlng)}}if(self.trackPolyline)self.trackPolyline.setMap(null);
if(self.trackLatLngs.length>0){self.trackPolyline=self.createPolyline(self.trackLatLngs,self.trackColor,false);$(".lblSuggestedTrack",this.el).css("color",self.trackColor)}else $(".lblSuggestedTrack",this.el).hide();if(!(self.trackLatLngs.length>0||self.boundaryLatLngs.length>0))$(this.el).hide()}},window.TheTripInterface));window.TheTripHeaderView=window.MapHeaderView.extend(_.extend({started:function(){$(".btnCP",this.el).show()},submitted:function(){$(".btnCP",this.el).hide()},submitted_fail:function(){$(".btnCP",
this.el).show()},saveMap:function(){appRouter.content.submitMap()}},window.TheTripInterface))})(jQuery);(function($){window.TheTripView_CPs=window.MapPageView_SubView.extend(_.extend({viewEl:".left .subpage[subpage=cp]",el:".left .subpage[subpage=cp]",parentView:"TheTripView",initialRender:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){this.collection=new CheckpointCollection;this.collection.comparator=function(cp){return cp.get("cpOrder")};if(this.model["offline"]==true)this.collection.offline=true;this.collection.fetchParams.mapKey=this.model.id},collectionEvents:{"reset":"resetItems"},
load:function(){this.updateLayout()},updateLayout:function(){if(appFunc.isApp())if(this.collection["offline"]==true)this.collection.fetchOffline();else this.collection.fetch2();else this.collection.fetch()},resetItems:function(){$(".checkpoints",this.el).empty();this.appendItems()},appendItems:function(){var self=this;var prevItem=null;_(this.collection.models).each(function(item,index){self.appendItem(item,index,prevItem);prevItem=item},this)},appendItem:function(item,index,prevItem){if(this.model["offline"]==
true)item.offline=true;var itemView=new TheTripView_CP({model:item,param:{rule:this.model.get("rule")}});item.view=itemView;item.nextCP=null;itemView.nextCPView=null;if(prevItem!=null)prevItem.view.nextCPView=itemView;if(prevItem!=null)prevItem.nextCP=item;this.subviews[itemView.cid]=itemView;$(".checkpoints",this.el).append(itemView.$el)},showCPDetail:function(cpModel,cpCollection){if(this.subviews["cpdetail"])this.subviews["cpdetail"].remove();if(cpModel){this.subviews["cpdetail"]=new TheTripView_CPDetail({model:cpModel,
collection:cpCollection,param:{rule:this.model.get("rule")}});$("#page").trigger({type:"goTop",slide:true})}}},window.TheTripInterface));window.TheTripView_CP=window.MapPageView_SubView.extend(_.extend({marker:null,infowindow:null,viewEl:".checkpoint",el:null,tagName:"div",className:"checkpoint section",init:function(){this.model.taskItems=null;this.collection=new TaskCollection;this.collection.comparator=function(task){return task.get("taskOrder")};this.collection.fetchParams.cpID=this.model.id;
if(this.model["offline"]==true)this.collection.offline=true},tripCP:function(){try{var trip=this.trip();if(trip!=null)if(trip.cps==null||_.isEmpty(trip.cps));else return trip.cps[this.model.id]}catch(err){}return{lock:true,lockTasks:true,near:false,completed:false}},load:function(){if(appFunc.isApp())if(this.collection["offline"]==true)this.collection.fetchOffline();else this.collection.fetch2();else this.collection.fetch()},initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},
initialRender:true,events:{"click .btnCPDetail":"showDetail","click .btnPwd":"clickUnlock"},modelEvents:{"change":"updateLayout","near":"nearCP","far":"offCP","completed":"completedTasks","unlock":"unlockCP"},collectionEvents:{"reset":"resetTaskItems"},render:function(){this.updateLayout();this.createMarker();return this},offCP:function(){if(!this.trip().isStarted())return;if(this.tripCP().near)this.tripCP().near=false},nearCP:function(){if(!this.trip().isStarted())return;$(".btnNear",this.el).show();
if(!this.tripCP().near){this.tripCP().near=true;var stat=dict("you are near checkpoint").replace("{cpOrder}",this.model.get("cpOrder"));this.addNote(stat)}switch(this.options.param.rule){case 0:if(this.tripCP().lockTasks){this.tripCP().lockTasks=false;this.trip().saveCPs();this.model.trigger("unlock")}break;case 1:try{if(this.nextCPView!=null&&!this.tripCP().lock){var nextCPView=this.nextCPView;if(nextCPView.tripCP().lock){nextCPView.tripCP().lock=false;nextCPView.tripCP().lockTasks=false;nextCPView.trip().saveCPs();
nextCPView.model.trigger("unlock")}}}catch(err){}break;case 3:if(this.tripCP().lock){this.tripCP().lock=false;this.tripCP().lockTasks=false;this.trip().saveCPs();this.model.trigger("unlock")}break}},clickUnlock:function(){switch(this.options.param.rule){case 1:case 3:case 6:if(this.tripCP().lock){var result=prompt(dict("Please enter password"));if(result==null)return;else if(result.toUpperCase()!=this.model.get("password").toUpperCase()){alert(dict("wrong password"));return}else{this.tripCP().lock=
false;this.tripCP().lockTasks=false;this.trip().saveCPs();this.model.trigger("unlock")}}break;case 0:case 7:if(this.tripCP().lockTasks){var result=prompt(dict("Please enter password"));if(result==null)return;else if(result.toUpperCase()!=this.model.get("password").toUpperCase()){alert(dict("wrong password"));return}else{this.tripCP().lockTasks=false;this.trip().saveCPs();this.model.trigger("unlock")}}break}},unlockCP:function(){var alertText=dict("checkpoint is unlocked").replace("{cpOrder}",this.model.get("cpOrder")).replace("{name}",
this.model.get("name"));this.addNote(alertText);this.updateLayout();$(".flipper",this.el).toggleClass("open",true);appRouter.siteFooter.show({action:"cpAlert","alert":true,msg:alertText})},completedTasks:function(){this.updateLayout();$(".flipper",this.el).toggleClass("open",false)},updateLayout:function(){var isOpen=$(".flipper.open",this.el).length>0;var obj=this.render2({cpObj:this.model.toJSON(),cpAttr:_.extend(this.tripCP(),{rule:this.options.param.rule}),tasks:this.model.taskItems});$(".flipper",
this.el).toggleClass("open",isOpen);if(this.marker)this.marker.setPosition(new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")));return obj},createMarker:function(){var self=this;var icon="http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+this.model.get("cpOrder")+"|FF0000|000000";this.marker=new google.maps.Marker({position:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")),map:this.map(),icon:icon});this.infowindow=new google.maps.InfoWindow;google.maps.event.addListener(this.marker,
"click",function(marker,i){if(!self.tripCP().lock){self.infowindow.setContent("<div><strong>"+self.model.get("cpOrder")+". "+_.escape(self.model.get("name"))+"</strong></div>");self.infowindow.open(self.map(),this)}})},removeMarker:function(){if(this.marker){this.marker.setMap(null);this.marker=null}},resetTaskItems:function(){$(".task-simple",this.el).empty();if(this.collection.length==0)$(".task-simple",this.el).append("<div class='line'>-</div>");else{var self=this;_(this.collection.models).each(function(item,
index){var taskNum=taskNumber(item.get("taskOrder"));$(".task-simple",self.el).append($("<div class='line' />").text(item.get("question")).prepend(taskNum))},this)}this.model.taskItems=$(".task-simple",this.el).html()},showDetail:function(){appRouter.content.subviews["cps"].showCPDetail(this.model,this.collection)}},window.TheTripInterface));window.TheTripView_CPDetail=window.MapPageView_SubView.extend(_.extend({viewEl:".left .subpage[subpage=cp] .checkpoint-detail",el:".left .subpage[subpage=cp] .checkpoint-detail",
initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},removeBoundFunc:function(){this.closeSlider()},initialRender:true,loadSubviews:function(){this.subviews["tasks"]=new TheTripView_Tasks({model:this.model,collection:this.collection})},modelEvents:{"change":"updateLayout"},events:{"click .btnComplete":"complete","click .btnCPDetail":"closeSlider"},render:function(){var obj=this.render2({cpObj:this.model.toJSON(),cpAttr:_.extend(this.tripCP(),{tasks:this.collection.length})});return obj},
tripCP:function(){try{var trip=this.trip();if(trip!=null)if(trip.cps==null||_.isEmpty(trip.cps));else return trip.cps[this.model.id]}catch(err){}return null},updateLayout:function(){this.render3(".checkpoint-main",{cpObj:this.model.toJSON(),cpAttr:_.extend(this.tripCP(),{})});return this},closeSlider:function(){var tripCP=this.tripCP();tripCP.ans=this.subviews["tasks"].getAnswers();this.trip().saveCPs()},complete:function(){var tripCP=this.tripCP();tripCP.ans=this.subviews["tasks"].getAnswers();tripCP.completed=
true;this.trip().saveCPs();this.model.trigger("completed");$(".checkpoint-main").addClass("completed");switch(this.options.param.rule){case 2:try{if(this.model.view.nextCPView!=null){var nextCPView=this.model.view.nextCPView;if(nextCPView.tripCP().lock){nextCPView.tripCP().lock=false;nextCPView.tripCP().lockTasks=false;nextCPView.trip().saveCPs();nextCPView.model.trigger("unlock")}}}catch(err){}break}$(".btnCPDetail",this.el).click()}},window.TheTripInterface))})(jQuery);(function($){window.TheTripView_Tasks=window.MapPageView_SubView.extend(_.extend({viewEl:".left .subpage[subpage=cp] .checkpoint-tasks",el:".left .subpage[subpage=cp] .checkpoint-tasks",initialRender:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){},collectionEvents:{"reset":"resetItems"},load:function(){this.updateLayout()},updateLayout:function(){this.resetItems()},resetItems:function(){$(".tasks",this.el).empty();this.appendItems();try{var tripCP=this.tripCP();if(tripCP.ans!=
null)this.loadAnswers(tripCP.ans)}catch(err){}},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new TheTripView_Task({model:item});item.view=itemView;this.subviews[itemView.cid]=itemView;$(".tasks",this.el).append(itemView.$el)},getAnswers:function(){var ans={};var self=this;_(this.collection.models).each(function(item,index){ans[item.id]=item.view.getAnswer()},this);return ans},
loadAnswers:function(ans){_(this.collection.models).each(function(item,index){item.view.loadAnswer(ans[item.id])},this)},tripCP:function(){try{var trip=this.trip();if(trip!=null)if(trip.cps==null||_.isEmpty(trip.cps));else return trip.cps[this.model.id]}catch(err){}return null}},window.TheTripInterface));window.TheTripView_Task=window.MapPageView_SubView.extend(_.extend({viewEl:".task",el:null,tagName:"div",className:"task subsection",initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},
initialRender:true,modelEvents:{"change":"updateLayout","remove":"unrender"},events:{"click input[type=button]":"clickToCompleted"},render:function(){return this.updateLayout()},unrender:function(){this.remove();$(this.$el).remove()},updateLayout:function(){var obj=this.render2({taskObj:this.model.toJSON()});return obj},clickToCompleted:function(){switch(this.model.get("answerType")){case 0:var date=new Date;$("input[type=hidden]",this.el).val(date.getTime());$(".completedText",this.el).text("Completed at: "+
date);break;case 5:if(siteInfo.geolocation==null)if(siteInfo.geolocation2==null)appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("GPS is not available.")});else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("GPS is yet accurate. Please try again later.")});else{var obj={lat:siteInfo.geolocation.lat,lng:siteInfo.geolocation.lng};ans=Convert.JsonToString(obj);$("input[type=hidden]",this.el).val(ans);$(".completedText",this.el).text("Completed - Geolocation: ("+obj.lat+", "+
obj.lng+")")}break}},getAnswer:function(){var ans={};switch(this.model.get("answerType")){case 0:case 5:ans=$("input[type=hidden]",this.el).val();break;case 1:ans=$("textarea",this.el).val();break;case 2:ans=$("select",this.el).val();break;case 3:$("input",this.el).each(function(key,value){ans[$(this).val()]=$(this).check()});break;case 4:ans=$("input",this.el).selectedValue();break;case 6:ans=$(".selectImage-preview",this.el).imageURL();break;case 7:ans=$("input",this.el).val();break}return ans},
loadAnswer:function(ans){try{switch(this.model.get("answerType")){case 0:if(ans!=null&&ans!=""){$("input[type=hidden]",this.el).val(ans);$(".completedText",this.el).text("Completed at: "+new Date(Convert.ToInt(ans)))}break;case 1:$("textarea",this.el).val(ans);break;case 2:$("select",this.el).val(ans);break;case 3:var opts=$.parseJSON(this.model.get("answerOptions"));$("input",this.el).each(function(key,value){$(this).check(ans[$(this).val()])});break;case 4:$("input",this.el).selectedValue(ans);
break;case 5:if(ans!=null&&ans!=""){var obj=Convert.StringToJson(ans);$("input[type=hidden]",this.el).val(ans);$(".completedText",this.el).text("Completed - Geolocation: ("+obj.lat+", "+obj.lng+")")}break;case 6:if(ans!=null&&ans!=""){var imgObj=$("<img />").attr({src:ans});$(".selectImage-preview",this.el).empty().append(imgObj)}break;case 7:$("input",this.el).val(ans);break}}catch(err){}}},window.TheTripInterface))})(jQuery);(function($){window.AfterTripInterface={trip:function(){if(appRouter.content&&appRouter.content instanceof window.AfterTripView)return appRouter.content.timer;if(appRouter._content&&appRouter._content instanceof window.AfterTripView)return appRouter._content.timer;return null},setTrip:function(theTrip){theTrip.loadCPs();if(appRouter.content&&appRouter.content instanceof window.AfterTripView){appRouter.content.timer=theTrip;appRouter.content.subviews["cps"].reloadCPDetail();location.href="#mode/after/"+
appRouter.content.model.id+"/cp"}if(appRouter._content&&appRouter._content instanceof window.AfterTripView)appRouter._content.timer=theTrip;appRouter.header.showTrip()},unsetTrip:function(){if(appRouter.content&&appRouter.content instanceof window.AfterTripView){appRouter.content.timer=null;location.href="#mode/after/"+appRouter.content.model.id+"/basic"}if(appRouter._content&&appRouter._content instanceof window.AfterTripView)appRouter._content.timer=null;appRouter.header.hideTrip()}};window.AfterTripView=
window.MapPageView.extend(_.extend({intervalVal:null,initializeBoundFunc:function(){_.bindAll(this,"mapCanvas_getCentre","goMyPosition_setLoc");user.addMap(this.model.id)},init:function(){},loadSubviews:function(){this.subviews["plot"]=new AfterTripView_Plot({model:this.model});this.subviews["mytrip"]=new AfterTripView_MyTrip({model:this.model});this.subviews["allsubmissions"]=new AfterTripView_AllSubmissions({model:this.model});this.subviews["cps"]=new AfterTripView_CPs({model:this.model});if(!(this.model.isCreator()||
this.model.isCollaborator())){$(this.subviews["allsubmissions"].el).hide();$("#btnAllSubmissions",this.el).hide()}else this.showAllSubmissions()},events:{"change [subpage=basic] .checkbox input[type=checkbox]":"changeAdvance","click .selectmode a":"clickMode","subpageChanged":"changedSubPage","click #btnReturnCentre":"returnCentre","click #btnMyPosition":"goMyPosition","click #btnAllSubmissions":"showAllSubmissions","click #btnMyTrip":"showMyTrip","click #btnSubmissionReport":"sendSubmissionReport",
"click #btnViewReport":"viewSubmissionReport","click #btnDownloadReport":"downloadSubmissionReport"},loadMap_events:function(){},changedSubPage:function(e,pageObj){},viewSubmissionReport:function(){var reportObj=new ReportModel_Submission({mapKey:this.model.id,mode:"view"});var self=this;reportObj.save({},{success:function(model,response,options){appRouter.siteFooter.show({action:"error"})},error:function(model,xhr,options){var extraPage=$('<div  class="extrapage" />').html(xhr.responseText).append($('<div class="extrapageFooter" />').text(dict("Click Back to return.")));
extraPage.wrapInner('<div class="extrapageInner" />');$("#content").append(extraPage);location.href="#mode/after/"+self.model.id+"/"+self.subpage+"/extrapage";appRouter.siteFooter.show({action:"msg",alert:false,msg:dict("Click Back to return.")})}})},downloadSubmissionReport:function(){$("#btnDownloadReport",this.el).nextAll("span.download").empty();var spanDownload=$("#btnDownloadReport",this.el).nextAll("span.download");if(spanDownload.length>0)spanDownload.empty();else var spanDownload=$("<span class='download' />").insertAfter($("#btnDownloadReport",
this.el));var aTag=$("<a href='javascript:void(0)' />").text(dict("Loading")+"...");aTag.appendTo(spanDownload);var reportObj=new ReportModel_Submission({mapKey:this.model.id,mode:"view"});var self=this;reportObj.save({},{success:function(model,response,options){appRouter.siteFooter.show({action:"error"})},error:function(model,xhr,options){var fileTypes={doc:"application/vnd.ms-word",html:"text/html"};var useType="doc";if(!(appFunc.get("browser")=="Firefox"||appFunc.get("browser")=="Chrome"))useType=
"html";else if(appFunc.get("browser")=="Chrome"&&appFunc.get("device")=="iOS")useType="html";aTag.text(dict("Click Here to Download")+" ("+dict("save as")+" xxxx."+useType+")").attr({download:"checkpointlist."+useType,target:"_blank",href:"data:"+fileTypes[useType]+";charset=utf-8,"+encodeURIComponent(xhr.responseText)}).addClass("show").delay(2E4,function(){$(this).remove()})}})},sendSubmissionReport:function(){if($("input#email",this.el).disable())return;var emailValidity=$("input#email",this.el).checkValidity();
if(emailValidity.valid){appRouter.siteFooter.show({action:"pleaseWait"});$("input#email",this.el).disable(true);var reportObj=new ReportModel_Submission({mapKey:this.model.id,email:$("input#email",this.el).val()});var self=this;reportObj.save({},{success:function(model,response,options){if(reportObj.get("success")==true){appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Sent!")});$("input#email",self.el).parents(".flipper").removeClass("open")}else appRouter.siteFooter.show({action:"msg",
"alert":true,msg:dict("Error")});$("input#email",self.el).val("").disable(false)},error:function(model,xhr,options){if(reportObj.get("success")==true){appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Sent!")});$("input#email",self.el).parents(".flipper").removeClass("open")}else appRouter.siteFooter.show({action:"error",xhr:xhr});$("input#email",self.el).val("").disable(false)}})}else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Please enter valid email.")})},showAllSubmissions:function(){$("#aftertripMyTrip",
this.el).hide();$("#aftertripAllSubmissions",this.el).show()},showMyTrip:function(){$("#aftertripAllSubmissions",this.el).hide();$("#aftertripMyTrip",this.el).show()},goMyPosition:function(){this.gps_getLocation(this.goMyPosition_setLoc)},goMyPosition_setLoc:function(position){var pos=$.extend(this.mapCanvas_getCentre(),{"mapCentre_lat":position.lat,"mapCentre_lng":position.lng});this.mapCanvas_setCentre(pos)},returnCentre:function(){var pos=this.mapModel_getCentre();this.mapCanvas_setCentre(pos)},
changeAdvance:function(e){if(this.model.isCreator()||this.model.isCollaborator()){var val=null;var id=$(e.currentTarget).attr("id");var obj={};switch(id){case "submission":val=$(e.currentTarget).check();break;default:return}obj[id]=val;this.model.set(obj,{silent:true});try{$(e.currentTarget).parents(".subsection").first().find(".note:not(.psnote)").text(dict(OPTIONS[id][val]))}catch(err){}if(this.model.hasChanged()){appRouter.siteFooter.show({action:"updating"});this.model.save({mode:"after",lastUpdateBy:user.get("userID")},
{success:function(model,response,options){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}}},saveMap:function(){},save:function(){}},window.AfterTripInterface));window.AfterTripView_AllSubmissions=window.MapPageView_SubView.extend(_.extend({viewEl:".main .section.notes#aftertripAllSubmissions",el:".main .section.notes#aftertripAllSubmissions",parent:null,initialRender:true,
init:function(){this.collection=new SubmissionCollection;this.collection.fetchParams.mapKey=this.model.id;if(user.isLogined())this.collection.fetchParams.userID=user.get("userID");else this.collection.fetchParams.userID=-1},events:{"click .btnNoteClear":"removeTrips"},render:function(){$(".aftertripNoteItem",this.el).remove();return this},collectionEvents:{"reset":"resetItems","add":"appendItem"},load:function(){this.updateLayout()},updateLayout:function(){if(user.isLogined())if(this.model.isCreator()||
this.model.isCollaborator())this.collection.fetch()},removeTrips:function(){var self=this;var noteModels=this.collection.models;for(var i=noteModels.length-1;i>=0;i--)noteModels[i].destroy();this.unloadSubviews();$(".aftertripNoteItem",this.el).remove();this.updateLayout()},resetItems:function(){this.unloadSubviews();$(".aftertripNoteItem",this.el).remove();this.appendItems()},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},
appendItem:function(item,index){var itemView=new AfterTripView_NoteItem({model:item});this.subviews[itemView.cid]=itemView;$("#aftertripSubmissionList",this.el).append(itemView.$el)}},window.AfterTripInterface));window.AfterTripView_MyTrip=window.MapPageView_SubView.extend(_.extend({viewEl:".main .section.notes#aftertripMyTrip",el:".main .section.notes#aftertripMyTrip",parent:null,initialRender:true,init:function(){this.collection=new TripCollection},events:{"click #btnTripPwd":"searchTrips"},render:function(){$(".aftertripNoteItem",
this.el).remove();return this},collectionEvents:{"reset":"resetItems","add":"appendItem"},load:function(){this.updateLayout()},searchTrips:function(){this.updateLayout()},updateLayout:function(){var tripPwd=$("#tripPwd",this.el).val();this.collection.reset(tripCollection.getTrips({mapKey:this.model.id,mode:"trip",submitted:true,pwd:tripPwd}))},removeTrips:function(){var self=this;var noteModels=this.collection.models;for(var i=noteModels.length-1;i>=0;i--)noteModels[i].destroy();this.unloadSubviews();
$(".aftertripNoteItem",this.el).remove();this.updateLayout()},resetItems:function(){this.unloadSubviews();$(".aftertripNoteItem",this.el).remove();this.appendItems()},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new AfterTripView_NoteItem({model:item});this.subviews[itemView.cid]=itemView;$("#aftertripNoteList",this.el).append(itemView.$el)}},window.AfterTripInterface));window.AfterTripView_NoteItem=
window.MapPageView_SubView.extend(_.extend({viewEl:".aftertripNoteItem",el:null,tagName:"div",className:"aftertripNoteItem",initialRender:true,events:{"click .fldname, .btnShow":"showTrip","click .btnDelete":"deleteTrip"},render:function(){var obj=this.render2();var noteEl=this.$el;var createDate=Convert.ToDateTime(this.model.get("startTime"));var endTime=Convert.ToDateTime(this.model.get("endTime"));var createDateStr=moment(createDate).format("YYYY/M/D")+"<br />"+moment(createDate).format("HH:mm:ss");
if(this.model instanceof TripModel){noteEl.children(":eq(1)").html(_.escape(this.model.get("name")));noteEl.children(":eq(0)").html("<em>"+_.escape(this.model.get("infoClass"))+" (#"+_.escape(this.model.get("infoClassno"))+")</em>")}else{noteEl.children(":eq(1)").html(_.escape(this.model.get("creatorName")));noteEl.children(":eq(0)").html("<em>"+_.escape(this.model.get("creatorClass"))+" (#"+_.escape(this.model.get("creatorClassno"))+")</em>")}noteEl.children(":eq(2)").html(createDateStr)},showTrip:function(){$("#page-aftertrip.mapcontent .main .section.notes .aftertripNoteList .aftertripNoteItem.selected").removeClass("selected");
$(this.el).addClass("selected");this.setTrip(this.model)},deleteTrip:function(){if(confirm(dict("Are you sure to delete this submission?"))){if(this.model==this.trip())this.unsetTrip();this.model.destroy();if(this.model instanceof TripModel)tripCollection.fetch();this.remove();$(this.el).remove()}}},window.AfterTripInterface));window.AfterTripView_Plot=window.MapPageView_SubView.extend(_.extend({viewEl:".main .subpage[subpage=basic] .track",el:".main .subpage[subpage=basic] .track",trackLatLngs:null,
boundaryLatLngs:null,trackColor:"blue",boundaryColor:"red",trackPolyline:null,boundaryPolyline:null,initialRender:true,initializeBoundFunc:function(){_.bindAll(this,"createPolyline");this.trackLatLngs=[];this.boundaryLatLngs=[]},render:function(){this.loadModel();return this},getPolylinePathByLatLngs:function(latlngs,isClosedPath){var path=[];for(var i=0;i<latlngs.length;i++)path.push(latlngs[i]);if(isClosedPath&&path.length>=3)path.push(latlngs[0]);return path},createPolyline:function(latlngs,color,
isPolygon){var path=this.getPolylinePathByLatLngs(latlngs,isPolygon);var opt={path:path,strokeColor:color,strokeWeight:1.5,strokeOpacity:0.75,fillOpacity:0,editable:false,map:this.map(),zIndex:1};var polyline=new google.maps.Polyline(opt);return polyline},loadModel:function(){var self=this;if(!_.isNull(this.model.get("plotBoundary"))){var arr=$.parseJSON(this.model.get("plotBoundary"));if(_.isArray(arr))for(var i=0;i<arr.length;i++){var latlng=new google.maps.LatLng(arr[i].lat,arr[i].lng);self.boundaryLatLngs.push(latlng)}}if(self.boundaryPolyline)self.boundaryPolyline.setMap(null);
if(self.boundaryLatLngs.length>0){self.boundaryPolyline=self.createPolyline(self.boundaryLatLngs,self.boundaryColor,true);$(".lblSuggestedBoundary",this.el).css("color",self.boundaryColor)}else $(".lblSuggestedBoundary",this.el).hide();if(!_.isNull(this.model.get("plotTrack"))){var arr=$.parseJSON(this.model.get("plotTrack"));if(_.isArray(arr))for(var i=0;i<arr.length;i++){var latlng=new google.maps.LatLng(arr[i].lat,arr[i].lng);self.trackLatLngs.push(latlng)}}if(self.trackPolyline)self.trackPolyline.setMap(null);
if(self.trackLatLngs.length>0){self.trackPolyline=self.createPolyline(self.trackLatLngs,self.trackColor,false);$(".lblSuggestedTrack",this.el).css("color",self.trackColor)}else $(".lblSuggestedTrack",this.el).hide();if(!(self.trackLatLngs.length>0||self.boundaryLatLngs.length>0))$(this.el).hide()}},window.AfterTripInterface));window.AfterTripHeaderView=window.MapHeaderView.extend(_.extend({showTrip:function(){$(".btnCP, #tripName",this.el).show();var createDate=new Date(Convert.ToInt(this.trip().get("startTime")));
var createDateStr=moment(createDate).format("YYYY/M/D HH:mm:ss");var stuInfo=$("<span />");var stuName=$("<strong />");if(this.trip()instanceof TripModel)stuName.text(dict("My Trip"));else if(this.trip()instanceof SubmissionModel){stuName.text(this.trip().get("creatorName"));if(stuName.text()=="")stuName.text("("+dict("No Names")+")");if(this.trip().get("creatorClass")!="")stuInfo.append(" <em>"+_.escape(this.trip().get("creatorClass"))+" (#"+_.escape(this.trip().get("creatorClassno"))+")</em>")}stuInfo.prepend(stuName);
var stuDate=$("<span />").text(createDateStr).css("font-size","smaller");$("#tripName",this.el).html("");$("#tripName",this.el).append(stuInfo).append("<br/>").append(stuDate)},hideTrip:function(){this.render()}},window.AfterTripInterface))})(jQuery);(function($){window.AfterTripView_CPs=window.MapPageView_SubView.extend(_.extend({viewEl:".left .subpage[subpage=cp]",el:".left .subpage[subpage=cp]",parentView:"AfterTripView",initialRender:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){this.collection=new CheckpointCollection;this.collection.comparator=function(cp){return cp.get("cpOrder")};this.collection.fetchParams.mapKey=this.model.id},events:{"click #btnTripReport":"sendTripReport"},collectionEvents:{"reset":"resetItems"},
load:function(){this.updateLayout()},updateLayout:function(){this.collection.fetch()},resetItems:function(){$(".checkpoints",this.el).empty();this.appendItems()},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new AfterTripView_CP({model:item,param:{rule:this.model.get("rule"),mapCentre:this.mapModel_getCentre()}});item.view=itemView;this.subviews[itemView.cid]=itemView;$(".checkpoints",
this.el).append(itemView.$el)},sendTripReport:function(){if($("input#emailthis",this.el).disable())return;var emailValidity=$("input#emailthis",this.el).checkValidity();if(emailValidity.valid){appRouter.siteFooter.show({action:"pleaseWait"});$("input#emailthis",this.el).disable(true);var reportObj=null;if(this.trip()instanceof TripModel)reportObj=new ReportModel_Trip({mapKey:this.model.id,email:$("input#emailthis",this.el).val(),trip:this.trip().toJSON()});else{reportObj=new ReportModel_Submission({mapKey:this.model.id,
email:$("input#emailthis",this.el).val()});reportObj.setSubmissions(this.trip().id)}var self=this;reportObj.save({},{success:function(model,response,options){if(reportObj.get("success")==true){appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Sent!")});$("input#emailthis",self.el).parents(".flipper").removeClass("open")}else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Error")});$("input#emailthis",self.el).val("").disable(false)},error:function(model,xhr,options){if(reportObj.get("success")==
true){appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Sent!")});$("input#emailthis",self.el).parents(".flipper").removeClass("open")}else appRouter.siteFooter.show({action:"error",xhr:xhr});$("input#emailthis",self.el).val("").disable(false)}})}else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Please enter valid email.")})},showCPDetail:function(cpModel,cpCollection){if(this.subviews["cpdetail"])this.subviews["cpdetail"].remove();if(cpModel){this.subviews["cpdetail"]=
new AfterTripView_CPDetail({model:cpModel,collection:cpCollection});$("#page").trigger({type:"goTop",slide:true})}},reloadCPDetail:function(){var createDate=null;var endTime=null;var elapsed=null;if(this.trip()instanceof TripModel){$("#submission-name",this.el).text(this.trip().get("name"));$("#submission-class",this.el).text(this.trip().get("infoClass"));$("#submission-classno",this.el).text(this.trip().get("infoClassno"));createDate=new Date(this.trip().get("startTime"));endTime=new Date(this.trip().get("endTime"));
elapsed=this.trip().get("priorElapsed")}else if(this.trip()instanceof SubmissionModel){$("#submission-name",this.el).text(this.trip().get("creatorName"));$("#submission-class",this.el).text(this.trip().get("creatorClass"));$("#submission-classno",this.el).text(this.trip().get("creatorClassno"));createDate=new Date(this.trip().get("startTime"));endTime=new Date(this.trip().get("endTime"));elapsed=endTime.getTime()-createDate.getTime()}var createDateStr=moment(createDate).format("YYYY/M/D HH:mm:ss");
$("#submission-starttime",this.el).text(createDateStr);var endTimeStr=moment(endTime).format("YYYY/M/D HH:mm:ss");$("#submission-endtime",this.el).text(endTimeStr);var elapsedObj=Convert.ToHhmmss(elapsed);if(elapsedObj.d>0)$("#submission-elapsed",this.el).text(elapsedObj.d+" "+(elapsedObj.d>1?"days":"day"));else $("#submission-elapsed",this.el).text(elapsedObj.hh+":"+elapsedObj.mm+":"+elapsedObj.ss);if(this.subviews["cpdetail"])this.showCPDetail(this.subviews["cpdetail"].model,this.subviews["cpdetail"].collection)}},
window.AfterTripInterface));window.AfterTripView_CP=window.MapPageView_SubView.extend(_.extend({marker:null,infowindow:null,viewEl:".checkpoint",el:null,tagName:"div",className:"checkpoint section",init:function(){this.model.taskItems=null;this.collection=new TaskCollection;this.collection.comparator=function(task){return task.get("taskOrder")};this.collection.fetchParams.cpID=this.model.id},tripCP:function(){try{var trip=this.trip();if(trip!=null)if(trip.cps==null||_.isEmpty(trip.cps));else return trip.cps[this.model.id]}catch(err){}},
load:function(){this.collection.fetch()},initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},initialRender:true,events:{"click .btnCPDetail":"showDetail"},modelEvents:{"change":"updateLayout"},collectionEvents:{"reset":"resetTaskItems"},render:function(){this.updateLayout();this.createMarker();return this},updateLayout:function(){var isOpen=$(".flipper.open",this.el).length>0;var obj=this.render2({cpObj:this.model.toJSON(),tasks:this.model.taskItems});$(".flipper",this.el).toggleClass("open",
isOpen);if(this.marker)this.marker.setPosition(new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")));return obj},createMarker:function(){var self=this;var icon="http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+this.model.get("cpOrder")+"|FF0000|000000";this.marker=new google.maps.Marker({position:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")),map:this.map(),icon:icon,title:this.model.get("name")});this.infowindow=new google.maps.InfoWindow;google.maps.event.addListener(this.marker,
"click",function(marker,i){self.infowindow.setContent("<div><strong>"+self.model.get("cpOrder")+". "+_.escape(self.model.get("name"))+"</strong></div>");self.infowindow.open(self.map(),this)})},removeMarker:function(){if(this.marker){this.marker.setMap(null);this.marker=null}},resetTaskItems:function(){$(".task-simple",this.el).empty();if(this.collection.length==0)$(".task-simple",this.el).append("<div class='line'>-</div>");else{var self=this;_(this.collection.models).each(function(item,index){var taskNum=
taskNumber(item.get("taskOrder"));$(".task-simple",self.el).append($("<div class='line' />").text(item.get("question")).prepend(taskNum))},this)}this.model.taskItems=$(".task-simple",this.el).html()},showDetail:function(){appRouter.content.subviews["cps"].showCPDetail(this.model,this.collection)}},window.AfterTripInterface));window.AfterTripView_CPDetail=window.MapPageView_SubView.extend(_.extend({viewEl:".left .subpage[subpage=cp] .checkpoint-detail",el:".left .subpage[subpage=cp] .checkpoint-detail",
initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},removeBoundFunc:function(){},initialRender:true,loadSubviews:function(){this.subviews["tasks"]=new AfterTripView_Tasks({model:this.model,collection:this.collection})},modelEvents:{"change":"updateLayout"},render:function(){var obj=this.render2({cpObj:this.model.toJSON()});return obj},tripCP:function(){try{var trip=this.trip();if(trip!=null)if(trip.cps==null||_.isEmpty(trip.cps));else return trip.cps[this.model.id]}catch(err){}return null},
updateLayout:function(){this.render3(".checkpoint-main",{cpObj:this.model.toJSON()});return this}},window.AfterTripInterface))})(jQuery);(function($){window.AfterTripView_Tasks=window.MapPageView_SubView.extend(_.extend({viewEl:".left .subpage[subpage=cp] .checkpoint-tasks",el:".left .subpage[subpage=cp] .checkpoint-tasks",initialRender:false,initializeBoundFunc:function(){_.bindAll(this,"render")},init:function(){},collectionEvents:{"reset":"resetItems"},load:function(){this.updateLayout()},updateLayout:function(){this.resetItems()},resetItems:function(){$(".tasks",this.el).empty();this.appendItems();try{var tripCP=this.tripCP();
if(tripCP.ans!=null)this.loadAnswers(tripCP.ans)}catch(err){}},appendItems:function(){var self=this;_(this.collection.models).each(function(item,index){self.appendItem(item,index)},this)},appendItem:function(item,index){var itemView=new AfterTripView_Task({model:item});item.view=itemView;this.subviews[itemView.cid]=itemView;$(".tasks",this.el).append(itemView.$el)},loadAnswers:function(ans){_(this.collection.models).each(function(item,index){item.view.loadAnswer(ans[item.id])},this)},tripCP:function(){try{var trip=
this.trip();if(trip!=null)if(trip.cps==null||_.isEmpty(trip.cps));else return trip.cps[this.model.id]}catch(err){}return null}},window.AfterTripInterface));window.AfterTripView_Task=window.MapPageView_SubView.extend(_.extend({viewEl:".task",el:null,tagName:"div",className:"task subsection",initializeBoundFunc:function(){_.bindAll(this,"render","updateLayout")},initialRender:true,modelEvents:{"change":"updateLayout","remove":"unrender"},render:function(){return this.updateLayout()},unrender:function(){this.remove();
$(this.$el).remove()},updateLayout:function(){var obj=this.render2({taskObj:this.model.toJSON()});return obj},loadAnswer:function(ans){try{switch(this.model.get("answerType")){case 0:if(ans!=null&&ans!=""){$("input[type=hidden]",this.el).val(ans);$(".completedText",this.el).text("Completed at: "+new Date(Convert.ToInt(ans)))}break;case 1:$("textarea",this.el).val(ans);break;case 2:$("select option").disable(false);$("select",this.el).val(ans);$("select option:not(:selected)").disable(true);break;
case 3:var opts=$.parseJSON(this.model.get("answerOptions"));$("input",this.el).each(function(key,value){$(this).check(ans[$(this).val()])});break;case 4:$("input",this.el).selectedValue(ans);break;case 5:if(ans!=null&&ans!=""){var obj=Convert.StringToJson(ans);$("input[type=hidden]",this.el).val(ans);$(".completedText",this.el).text("Completed - Geolocation: ("+obj.lat+", "+obj.lng+")")}break;case 6:if(ans!=null&&ans!=""){var re=/^\/img\//;if(re.test(ans))ans=baseURL+ans;var imgObj=$("<img />").attr({src:ans});
$(".selectImage-preview",this.el).empty().append(imgObj)}break;case 7:$("a.newTask-url",this.el).attr({"href":"javascript:void(0)",target:""}).css({"text-decoration":"line-through"});$("input",this.el).val(ans);if($("input",this.el).val()!=""){var urlValidity=$("input",this.el).checkValidity();if(urlValidity.valid)$("a.newTask-url",this.el).attr({"href":ans,target:"_blank"}).css({"text-decoration":""})}break}}catch(err){}}},window.AfterTripInterface))})(jQuery);(function($){window.MapListView=window.PageView.extend({events:{"click #btnSearch":"searchMaps","keypress #search":"searchMaps_enter","click .tabs .tab":"clickTab","click .tabbuttons a":"clickTab","click .searchTag":"clickTag"},init:function(){this.param=$.extend({},this.options.param,{tab:"SearchMap",subtab:""});if(this.param.mode=="trip"){this.param.tab="CurrentTrip";if(tripCollection.currentTrips().length==0)this.param.tab="SearchMap"}if(this.param.mode=="plan"||this.param.mode=="pre")this.param.subtab=
"allMyMap";else{this.param.subtab="allMap";if(appFunc.isApp()&&this.param.mode=="trip")try{var networkState=navigator.network.connection.type;if(networkState==Connection.NONE)this.param.subtab="offlineMap"}catch(err){}}if(this.param.mapKey!=null){this.param.tab="GetAMap";this.param.subtab=""}},load:function(){if(this.param.mapKey!=null)$("#search",this.el).val(this.param.mapKey)},initializeBoundFunc:function(){_.bindAll(this,"searchMaps","updateLayout")},render:function(){var obj=this.render2({param:this.param});
return obj},updateLayout:function(){this.render3(".tabs",{param:this.param});this.render3(".searchCriteria",{param:this.param});this.subviews["searchMaps"].options.param.tab=this.param.tab;return this},clickTab:function(e){if($(e.currentTarget).is(".tab.linkTab")){appRouter.loadPage();return}if($(e.currentTarget).is(".tab.currentTrip")){if(this.param.tab!="SearchMap"&&this.param.tab!="FavMap"&&this.param.tab!="RecentMap"&&this.param.tab!="CurrentTrip")this.param.subtab="allMap";this.param.tab="CurrentTrip"}else if($(e.currentTarget).is(".tab.recentMap")){if(this.param.tab!=
"SearchMap"&&this.param.tab!="FavMap"&&this.param.tab!="RecentMap"&&this.param.tab!="CurrentTrip")if(this.param.mode=="plan"||this.param.mode=="pre")this.param.subtab="allMyMap";else this.param.subtab="allMap";this.param.tab="RecentMap"}else if($(e.currentTarget).is(".tab.searchMap")){if(this.param.tab!="SearchMap"&&this.param.tab!="FavMap"&&this.param.tab!="RecentMap"&&this.param.tab!="CurrentTrip")if(this.param.mode=="plan"||this.param.mode=="pre")this.param.subtab="allMyMap";else this.param.subtab=
"allMap";this.param.tab="SearchMap"}else if($(e.currentTarget).is(".tab.getAMap")){this.param.tab="GetAMap";this.param.subtab=""}else if($(e.currentTarget).is(".tab.favMap")){if(this.param.tab!="SearchMap"&&this.param.tab!="FavMap"&&this.param.tab!="RecentMap")if(this.param.mode=="plan"||this.param.mode=="pre")this.param.subtab="allMyMap";else this.param.subtab="allMap";this.param.tab="FavMap"}else if($(e.currentTarget).is(".tabbuttons a.onlyCreatedByMe"))this.param.subtab="onlyCreatedByMe";else if($(e.currentTarget).is(".tabbuttons a.onlyCollaborating"))this.param.subtab=
"onlyCollaborating";else if($(e.currentTarget).is(".tabbuttons a.allMyMap"))this.param.subtab="allMyMap";else if($(e.currentTarget).is(".tabbuttons a.allMap"))this.param.subtab="allMap";else if($(e.currentTarget).is(".tabbuttons a.offlineMap"))if(appFunc.isApp())this.param.subtab="offlineMap";this.updateLayout();this.searchMaps()},clickTag:function(e){if(!$(e.currentTarget).is(".tab.searchMap")){this.param.tab="SearchMap";this.updateLayout()}$("#search",this.el).val($(e.currentTarget).text());this.searchMaps()},
searchMaps_enter:function(e){var code=e.keyCode?e.keyCode:e.which;if(code==13)this.searchMaps()},searchMaps:function(){var opts={};switch(this.param.mode){case "plan":case "pre":opts["userID"]=user.get("userID");break;case "trip":opts["onlyEnable"]=true;break;case "after":opts["withSubmission"]=true;tripCollection.clearTrips({mode:"trip"});var submittedTrip=new TripCollection(tripCollection.where({submitted:true}));opts["submitKeys"]=submittedTrip.pluck("mapKey");if(user.isLogined())opts["userID"]=
user.get("userID");break;case "duplicate":break}switch(this.param.tab){case "GetAMap":if($("#search",this.el).val()=="")opts["reset"]=true;else opts["keys"]=[$("#search",this.el).val()];break;case "RecentMap":case "CurrentTrip":if(this.param.tab=="CurrentTrip")opts["keys"]=tripCollection.currentTrips();else opts["keys"]=user.mapHistory();if(opts["keys"].length==0)opts["keys"]=["0"];default:if(this.param.mode=="trip")if(this.param.tab!="RecentMap"&&this.param.tab!="CurrentTrip")if(this.param.subtab==
"allMap")opts["onlyPublic"]=true;opts["searchText"]=$("#search",this.el).val();break}switch(this.param.subtab){case "allMap":break;case "allMyMap":opts["userID"]=user.get("userID");break;case "onlyCollaborating":opts["userID"]=user.get("userID");opts["onlyCollaborating"]=true;break;case "onlyCreatedByMe":opts["userID"]=user.get("userID");opts["onlyCreatedByMe"]=true;break}this.subviews["searchMaps"].searchMaps(opts);return false},loadSubviews:function(){this.subviews["searchMaps"]=new MapListView_SearchResults({param:this.options.param});
var opts={};switch(this.param.mode){case "plan":case "pre":opts["userID"]=user.get("userID");break}this.searchMaps()}});window.MapListView_SearchResults=window.PageView_SubView.extend({viewEl:"#searchresults",el:"#searchresults",parentView:"MapListView",events:{"click #btnShowMore":"fetchMoreMaps"},collectionEvents:{"reset":"resetItems","error":"fetchError"},loading:null,showMore:null,noResult:null,initializeBoundFunc:function(){_.bindAll(this,"render","fetchMaps","fetchMoreMaps","appendItems","appendItem",
"searchMaps")},init:function(){this.loading=$(".loading",this.el).clone();this.showMore=$(".showmore",this.el).clone();this.noResult=$(".noresult",this.el).clone();this.collection=new MapCollection;this.collection.fetchParams.maxItems=20},initialRender:false,render:function(){$(this.el).empty()},load:function(){},fetchError:function(collection,xhr,options){appRouter.siteFooter.show({action:"error",xhr:xhr,alert:false});$(this.el).empty().append(this.noResult)},searchMaps:function(_opts){var opts=
{searchText:null,keys:null,submitKeys:null,reset:null,userID:null,onlyCreatedByMe:null,onlyCollaborating:null,onlyPublic:null,onlyEnable:null,withSubmission:null};opts=$.extend(opts,_opts);this.collection.resetParams();this.collection.fetchParams.maxItems=20;if(opts.reset==true)$(this.el).empty();else{if(opts.userID!=null)this.collection.fetchParams.userID=opts.userID;if(opts.keys!=null)this.collection.fetchParams.keys=opts.keys;if(opts.submitKeys!=null)this.collection.fetchParams.submitKeys=opts.submitKeys;
if(opts.searchText!=null&&opts.searchText!="")this.collection.fetchParams.searchText=opts.searchText;var permitArr=[];if(opts.onlyPublic==true)permitArr.push("onlyPublic");if(opts.onlyEnable==true)permitArr.push("onlyEnable");if(opts.withSubmission==true)permitArr.push("withSubmission");if(opts.onlyCreatedByMe==true||opts.onlyCollaborating==true){if(opts.onlyCreatedByMe==true)permitArr.push("onlyCreatedByMe");else if(opts.onlyCollaborating==true)permitArr.push("onlyCollaborating");if(this.collection.fetchParams.userID!=
null)this.collection.fetchParams.userID=user.get("userID")}if(permitArr.length>0)this.collection.fetchParams.permit=permitArr.join("|");this.fetchMaps()}},fetchMaps:function(){var self=this;$(this.el).empty().append(this.loading);var isShowCurrTrip=false;var isShowOfflineTrip=false;try{if(this.options.param.mode=="trip"){try{var tab=appRouter._content.param.tab;var subtab=appRouter._content.param.subtab;if(tab=="CurrentTrip")isShowCurrTrip=true;else if(tab=="SearchMap"&&subtab=="offlineMap")isShowOfflineTrip=
true}catch(err3a){}try{var tab=appRouter.content.param.tab;var subtab=appRouter.content.param.subtab;if(tab=="CurrentTrip")isShowCurrTrip=true;else if(tab=="SearchMap"&&subtab=="offlineMap")isShowOfflineTrip=true}catch(err3b){}}}catch(err2){}if((isShowCurrTrip||isShowOfflineTrip)&&appFunc.isApp()){if(!appFunc.isOfflineReady()){self.collection.reset([]);return}var currentKeys=this.collection.fetchParams.keys;var searchText="";try{searchText=this.collection.fetchParams.searchText}catch(err){searchText=
""}function errorCB(err){}function querySuccess(tx,results){var _mapModels=[];if(results.rows.length>0)for(var i=0;i<results.rows.length;i++){var _mapModel=new MapModel({mapKey:results.rows.item(i).mapKey});var logDate=new Date;try{logDate=new Date(results.rows.item(i).logDate2)}catch(err){}_mapModel.fetchOffline({success:function(){alert(_mapModel.get("mapKey")+" "+_mapModel.get("name"));_mapModel.set({offline:true,logDate:logDate});_mapModels.push(_mapModel);if(results.rows.length==_mapModels.length){alert(results.rows.length+
" "+_mapModels.length);self.collection.reset(_mapModels)}}})}else self.collection.reset(_mapModels)}function populateDB(tx){if(isShowCurrTrip)if(currentKeys.length==0)tx.executeSql("SELECT * FROM MAP WHERE FALSE",[],querySuccess,errorCB);else if(currentKeys.length==1)tx.executeSql("SELECT MAP.*, CPS.logDate AS logDate2 FROM MAP, CPS WHERE MAP.mapKey = CPS.mapKey AND MAP.mapKey=?",[currentKeys[0]],querySuccess,errorCB);else tx.executeSql("SELECT MAP.*, CPS.logDate AS logDate2 FROM MAP, CPS WHERE MAP.mapKey = CPS.mapKey AND MAP.mapKey in ('"+
currentKeys.join("','")+"')",[],querySuccess,errorCB);else if(isShowOfflineTrip)if(searchText!=null&&searchText!=""){var searchText2="%"+searchText+"%";tx.executeSql("SELECT MAP.*, CPS.logDate AS logDate2 FROM MAP, CPS WHERE MAP.mapKey = CPS.mapKey AND ((MAP.mapKey LIKE ?) OR (MAP.name LIKE ?) OR (MAP.description LIKE ?)) ORDER BY CPS.logDate DESC LIMIT 20",[searchText2,searchText2,searchText2],querySuccess,errorCB)}else tx.executeSql("SELECT MAP.*, CPS.logDate AS logDate2 FROM MAP, CPS WHERE MAP.mapKey = CPS.mapKey ORDER BY CPS.logDate DESC LIMIT 20",
[],querySuccess,errorCB)}appFunc.db.transaction(populateDB,errorCB)}else this.collection.fetch({data:{mode:this.options.param.mode}})},fetchMoreMaps:function(){if(this.collection.fetchParams.start!=null)this.collection.fetchParams.start+=this.collection.fetchParams.maxItems;else this.collection.fetchParams.start=this.collection.fetchParams.maxItems;this.collection.fetch({data:{mode:this.options.param.mode},add:true,success:this.appendItems})},resetItems:function(models,opts){if(opts["add"]==null){this.unloadSubviews();
$(this.el).empty();this.appendItems()}},appendItems:function(models){var self=this;$(this.showMore).remove();_(this.collection.models).each(function(item,index){if(self.collection.fetchParams.start!=null);self.appendItem(item)},this);if(this.collection.hasMore())$(this.el).append(this.showMore);else if(this.collection.length==0)if(this.collection.fetchParams.start==null)$(this.el).append(this.noResult)},appendItem:function(item){var itemView=new MapListView_SearchResult({model:item,param:this.options.param});
this.subviews[itemView.cid]=itemView;$(this.el).append(itemView.$el)}});window.MapListView_SearchResult=window.PageView_SubView.extend({viewEl:".searchresult",el:null,tagName:"div",className:"searchresult",events:{"click .btnOfflineRemove":"clickOfflineRemove"},initializeBoundFunc:function(){_.bindAll(this,"render")},initialRender:true,render:function(){return this.render2({mapObj:this.model.toJSON(),mapAttr:this.model.mapAttributes(),param:this.options.param,thumbnail:this.model.gsmap()})},clickOfflineRemove:function(){var self=
this;if(!appFunc.isApp())return;if(!this.model.get("offline"))return;var currTrips=tripCollection.currentTrips();if($.inArray(this.model.id,currTrips)>-1){appFunc.alert(dict("Current Trip"));return}appRouter.siteFooter.show({action:"updating"});$(this.el).hide();this.model.destroyOffline({wait:true,success:function(model,response,options){var el=self.el;self.remove();$(el).remove();appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Deleted")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"error",
xhr:xhr});$(self.el).show()}})}})})(jQuery);(function($){window.NewMapView=window.MapPageView.extend({initializeBoundFunc:function(){_.bindAll(this,"updateByMap","mapCanvas_getCentre","updateByCurrLoc_setLoc","mapModel_getCentre","searchBox_placeChanged","searchBox_clearSearch")},events:{"click #btnUpdateByInput":"updateByInput","click #btnMyPosition":"goMyPosition","click #btnChangeLang":"changeLanguage"},loadMap_events:function(){google.maps.event.addListener(this.map(),"center_changed",this.updateByMap);google.maps.event.addListener(this.map(),
"zoom_changed",this.updateByMap);google.maps.event.addListener(this.searchBox(),"places_changed",this.searchBox_placeChanged)},goMyPosition:function(){this.gps_getLocation(this.updateByCurrLoc_setLoc)},updateByCurrLoc_setLoc:function(position){var pos=$.extend(this.mapModel_getCentre(),{"mapCentre_lat":position.lat,"mapCentre_lng":position.lng});this.mapModel_setCentre(pos).mapCanvas_setCentre(pos).mapInput_setCentre(pos)},updateByInput:function(){if($("#lat, #lng, #zoom").checkValidityAll()){var pos=
this.mapInput_getCentre();this.mapModel_setCentre(pos).mapCanvas_setCentre(pos)}else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter valid "latitude", "longitude" and "zoom".')})},updateByMap:function(){var pos=this.mapCanvas_getCentre();this.mapModel_setCentre(pos).mapInput_setCentre(pos)},changeLanguage:function(){var maplang=locale($("#language",this.el).val());if(user.lang()!=maplang){this.model.set({ownerID:user.get("userID"),name:$("#name",this.el).val(),description:$("#description",
this.el).val(),language:$("#language",this.el).val(),creatorName:$("#creatorName",this.el).val()});var mapModel=this.model;user.lang(maplang);appRouter.header.remove();appRouter.content.remove();appRouter.header=new NewMapHeaderView({model:mapModel});appRouter.content=new NewMapView({model:mapModel})}},saveMap:function(){if($("#name, #creatorName",this.el).checkValidityAll()){appRouter.siteFooter.show({action:"updating"});this.model.save({ownerID:user.get("userID"),name:$("#name",this.el).val(),description:$("#description",
this.el).val(),language:$("#language",this.el).val(),creatorName:$("#creatorName",this.el).val()},{success:function(model,response){appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")});location.href="#mode/plan/"+model.id},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",xhr:xhr})}})}else if($("#name",this.el).val()=="")appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter "map name"!')});else if($("#creatorName",this.el).val()==
"")appRouter.siteFooter.show({action:"msg","alert":true,msg:dict('Please enter "Creator"!')})}});window.NewMapHeaderView=window.MapHeaderView.extend({})})(jQuery);(function($){window.PreviewView=window.MapPageView.extend({initializeBoundFunc:function(){_.bindAll(this,"goMyPosition_setLoc")},events:{"click .selectmode a":"clickMode","click #btnReturnCentre":"returnCentre","click #btnMyPosition":"goMyPosition","click #btnDuplicateMap":"duplicateMap"},init:function(){},load:function(){try{var self=this;var cps=this.model.get("cps");var cpMarkers=[];$.each(cps,function(index,cp){try{var icon="http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+cp.cpOrder+
"|FF0000|000000";this.marker=new google.maps.Marker({position:new google.maps.LatLng(cp.lat,cp.lng),map:self.map(),draggable:false,icon:icon})}catch(err){}})}catch(err2){}},loadSubviews:function(){this.subviews["plot"]=new PreviewView_Plot({model:this.model})},returnCentre:function(){var pos=this.mapModel_getCentre();this.mapCanvas_setCentre(pos)},goMyPosition:function(){this.gps_getLocation(this.goMyPosition_setLoc)},goMyPosition_setLoc:function(position){var pos=$.extend(this.mapCanvas_getCentre(),
{"mapCentre_lat":position.lat,"mapCentre_lng":position.lng});this.mapCanvas_setCentre(pos)},duplicateMap:function(){if(confirm(dict("Are you sure?"))){appRouter.siteFooter.show({action:"pleaseWait"});var newmap=new MapModel({fromMapKey:this.model.id});newmap.save({},{success:function(model,response,options){location.href="#mode/plan/"+model.id;appRouter.siteFooter.show({action:"save",lastUpdate:model.get("lastUpdateTS")})},error:function(model,xhr,options){appRouter.siteFooter.show({action:"saveError",
xhr:xhr})}})}}});window.PreviewView_Plot=window.MapPageView_SubView.extend({viewEl:".main .track",el:".main .track",trackLatLngs:null,boundaryLatLngs:null,trackColor:"blue",boundaryColor:"red",trackPolyline:null,boundaryPolyline:null,initialRender:true,initializeBoundFunc:function(){_.bindAll(this,"createPolyline");this.trackLatLngs=[];this.boundaryLatLngs=[]},render:function(){this.loadModel();return this},getPolylinePathByLatLngs:function(latlngs,isClosedPath){var path=[];for(var i=0;i<latlngs.length;i++)path.push(latlngs[i]);
if(isClosedPath&&path.length>=3)path.push(latlngs[0]);return path},createPolyline:function(latlngs,color,isPolygon){var path=this.getPolylinePathByLatLngs(latlngs,isPolygon);var opt={path:path,strokeColor:color,strokeWeight:1.5,strokeOpacity:0.75,fillOpacity:0,editable:false,map:this.map(),zIndex:1};var polyline=new google.maps.Polyline(opt);return polyline},loadModel:function(){var self=this;if(!_.isNull(this.model.get("plotBoundary"))){var arr=$.parseJSON(this.model.get("plotBoundary"));if(_.isArray(arr))for(var i=
0;i<arr.length;i++){var latlng=new google.maps.LatLng(arr[i].lat,arr[i].lng);self.boundaryLatLngs.push(latlng)}}if(self.boundaryPolyline)self.boundaryPolyline.setMap(null);if(self.boundaryLatLngs.length>0){self.boundaryPolyline=self.createPolyline(self.boundaryLatLngs,self.boundaryColor,true);$(".lblSuggestedBoundary",this.el).css("color",self.boundaryColor)}else $(".lblSuggestedBoundary",this.el).hide();if(!_.isNull(this.model.get("plotTrack"))){var arr=$.parseJSON(this.model.get("plotTrack"));if(_.isArray(arr))for(var i=
0;i<arr.length;i++){var latlng=new google.maps.LatLng(arr[i].lat,arr[i].lng);self.trackLatLngs.push(latlng)}}if(self.trackPolyline)self.trackPolyline.setMap(null);if(self.trackLatLngs.length>0){self.trackPolyline=self.createPolyline(self.trackLatLngs,self.trackColor,false);$(".lblSuggestedTrack",this.el).css("color",self.trackColor)}else $(".lblSuggestedTrack",this.el).hide();if(!(self.trackLatLngs.length>0||self.boundaryLatLngs.length>0))$(this.el).hide()}});window.PreviewHeaderView=window.MapHeaderView.extend({viewEl:"#header",
el:$("#header")})})(jQuery);(function($){window.NotSupportView=window.PageView.extend({render:function(){var obj=this.render2();$("#footer").hide();return obj}})})(jQuery);(function($){window.DirectLoginView=window.PageView.extend({subpage:null,showSubPage:function(subpage){try{if(subpage==null)subpage=$(".subpage[subpage]",this.el).attr("subpage");if(this.subpage!=subpage){$(".subpage[subpage!='"+subpage+"']",this.el).hide();$("input[type=text], input[type=email], input[type=password]",this.el).val("").disable(false);$(".validresult",this.el).removeClass("error ok").text("");$(".subpage[subpage='"+subpage+"']",this.el).show();$(this.el).trigger("subpageChanged",{from:this.subpage,
to:subpage});this.subpage=subpage}}catch(err){}},events:{"subpageChanged":"changedSubPage"},changedSubPage:function(e,pageObj){switch(pageObj.to){case "changepwd":if(user.isLogined())$("#page-directlogin-changepwd #name",this.el).val(user.get("account"));else appRouter.showHome();break}},init:function(){},loadSubviews:function(){this.subviews["login"]=new DirectLoginView_Login;this.subviews["signup"]=new DirectLoginView_Signup;this.subviews["forget"]=new DirectLoginView_Forget;this.subviews["recovery"]=
new DirectLoginView_Recovery;this.subviews["activate"]=new DirectLoginView_Activate;this.subviews["changepwd"]=new DirectLoginView_ChangePwd}});window.DirectLoginView_Login=window.PageView_SubView.extend({viewEl:"#page-directlogin-login",el:"#page-directlogin-login",initialRender:false,accountObj:null,events:{"click #btnOK":"clickOK"},clickOK:function(){var username=$("input#name",this.el).val();var password=$("input#password",this.el).val();if($("input#name,  input#password",this.el).checkValidityAll()==
false){this.getAccount_fail();return}this.accountObj=new AccountModel_Login2({account:username,service:"Direct",passKey:password});$("input",this.el).disable(true);this.accountObj.save({},{success:_.bind(this.getAccount_success,this),error:_.bind(this.getAccount_fail,this)})},getAccount_success:function(model,response,options){try{if(this.accountObj.id!=null){user.save({"userID":this.accountObj.id,"oauth_service":this.accountObj.get("service"),"account":this.accountObj.get("account"),"account_id":"NAN",
"loginDate":new Date});this.accountObj=null;if(user.isLogined())appRouter.showHome()}else this.getAccount_fail()}catch(err){}},getAccount_fail:function(collection,xhr,options){this.accountObj=null;var yetActive=false;try{if(xhr.status==403)yetActive=true}catch(err){}if(yetActive)appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Login Fail")+dict(": ")+dict("Please activate your account.")});else appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Login Fail")});$("input",this.el).disable(false)}});
window.DirectLoginView_Signup=window.PageView_SubView.extend({viewEl:"#page-directlogin-signup",el:"#page-directlogin-signup",initialRender:false,accountObj:null,validateObj:null,events:{"click #btnOK":"clickOK","change input#name, input#email":"validate","change input#password, input#confirmpassword":"validate2"},validate:function(){var username=$.trim($("input#name",this.el).val());var email=$.trim($("input#email",this.el).val());var nameValidity=$("input#name",this.el).checkValidity();var emailValidity=
$("input#email",this.el).checkValidity();if(nameValidity.valid||emailValidity.valid){username=!nameValidity.valid?"null":username;email=!emailValidity.valid?"null":email;this.validateObj=new AccountModel_Validate({account:username,service:"Direct",email:email});this.validateObj.fetch({success:_.bind(this.validate_success,this),error:_.bind(this.validate_success,this)});if(!nameValidity.valid)this.validate_username(null,null,nameValidity);if(!emailValidity.valid)this.validate_email(null,null,emailValidity)}else{this.validate_username(null,
null,nameValidity);this.validate_email(null,null,emailValidity)}},validate2:function(){this.validate_password();this.validate_confirmpassword()},validate_success:function(model,response,options){var error=this.validateObj.get("error");var success=this.validateObj.get("success");this.validate_username(success,error);this.validate_email(success,error)},validate_username:function(success,error,validity){$("#name",this.el).nextAll(".validresult").removeClass("error ok");if(validity==null)validity=$("#name",
this.el).checkValidity();var $feedback=$("#name",this.el).nextAll(".validresult");if(!validity.valid)$feedback.addClass("error").text(dict("Required"));else try{if(success==true)$feedback.addClass("ok").text("OK");else if(error["repeatName"]==true)$feedback.addClass("error").text(dict("Username has been used")+dict("."));else if(error["repeatName"]==false)$feedback.addClass("ok").text("OK")}catch(err){}},validate_email:function(success,error,validity){var re=/^\S+@\S+$/;$("#email",this.el).nextAll(".validresult").removeClass("error ok");
if(validity==null)validity=$("input#email",this.el).checkValidity();var $feedback=$("#email",this.el).nextAll(".validresult");if(!validity.valid)if(validity.valueMissing)$feedback.addClass("error").text(dict("Required"));else $feedback.addClass("error").text(dict("Invalid Format")+dict("."));else try{if(success==true)$feedback.addClass("ok").text("OK");else if(error["failEmail"]==true)$feedback.addClass("error").text(dict("Please enter a school email")+dict("."));else if(error["repeatEmail"]==true)$feedback.addClass("error").text(dict("Email has been used")+
dict("."));else if(error["repeatEmail"]==false)$feedback.addClass("ok").text("OK")}catch(err){}},validate_password:function(){$("#password",this.el).nextAll(".validresult").removeClass("error ok");var validity=$("input#password",this.el).checkValidity();var $feedback=$("#password",this.el).nextAll(".validresult");if(!validity.valid)if(validity.valueMissing)$feedback.addClass("error").text(dict("Required"));else $feedback.addClass("error").text(dict("Invalid Format.")+" / "+dict("Please enter at least 4 characters")+
dict("."));else $feedback.addClass("ok").text("OK")},validate_confirmpassword:function(){$("#confirmpassword",this.el).nextAll(".validresult").removeClass("error ok");var passValidity=$("input#password",this.el).checkValidity();var validity=$("input#confirmpassword",this.el).checkValidity();var cpassword=$("input#confirmpassword",this.el).val();var password=$("input#password",this.el).val();var $feedback=$("#confirmpassword",this.el).nextAll(".validresult");if(!validity.valid||!passValidity.valid)if(validity.valueMissing)$feedback.addClass("error").text(dict("Required"));
else if(passValidity.valueMissing)$feedback.addClass("error").text(dict("Please enter password")+dict("."));else $feedback.addClass("error").text(dict("Invalid Format.")+" / "+dict("Please enter at least 4 characters")+dict("."));else if(cpassword!=password)$feedback.addClass("error").text(dict("Confirm password does not match the password")+dict("."));else $feedback.addClass("ok").text("OK")},clickOK:function(){var username=$("input#name",this.el).val();var email=$("input#email",this.el).val();var password=
$("input#password",this.el).val();var confirmpassword=$("input#confirmpassword",this.el).val();if($("input#name, input#email, input#password, input#confirmpassword",this.el).checkValidityAll()==false);else if(password!=confirmpassword);else if($(".validresult.ok",this.el).length==4){appRouter.siteFooter.show({action:"pleaseWait"});this.accountObj=new AccountModel_Reg({account:username,service:"Direct",passKey:password,email:email});$("input",this.el).disable(true);this.accountObj.save({},{wait:true,
success:_.bind(this.signup_success,this),error:_.bind(this.signup_fail,this)})}},signup_success:function(model,response,options){try{if(this.accountObj.get("success")==true){this.accountObj=null;location.href="#page/login/signup2";appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Sent!")});$("input",this.el).disable(false)}else this.signup_fail()}catch(err){}},signup_fail:function(model,xhr,options){try{if(xhr!=null){var repObj=Convert.StringToJson(xhr.responseText);var error=repObj.error;
if(error.repeatEmail)$("#email",this.el).nextAll(".validresult").text("* "+dict("Email has been used")+dict("."));if(error.failEmail)$("#email",this.el).nextAll(".validresult").text("* "+dict("Please enter a school email")+dict("."));if(error.repeatName)$("#name",this.el).nextAll(".validresult").text("* "+dict("Username has been used")+dict("."))}}catch(err){}this.accountObj=null;appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Sign Up Failed")});$("input",this.el).disable(false)}});
window.DirectLoginView_Forget=window.PageView_SubView.extend({viewEl:"#page-directlogin-forget",el:"#page-directlogin-forget",initialRender:false,accountObj:null,events:{"click #btnOK":"clickOK"},clickOK:function(){var username=$("input#name",this.el).val();if($("input#name",this.el).checkValidityAll()==false)return;else{appRouter.siteFooter.show({action:"pleaseWait"});this.accountObj=new AccountModel_Forget({account:username});$("input",this.el).disable(true);this.accountObj.save({},{wait:true,success:_.bind(this.forget_success,
this),error:_.bind(this.forget_fail,this)})}},forget_success:function(model,response,options){try{if(this.accountObj.get("success")==true){this.accountObj=null;location.href="#page/login/forget2";appRouter.siteFooter.show({action:"msg","alert":false,msg:dict("Sent!")})}else this.forget_fail()}catch(err){}$("input",this.el).disable(false)},forget_fail:function(model,xhr,options){this.accountObj=null;appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Reset Failed")});$("input",this.el).disable(false)}});
window.DirectLoginView_Recovery=window.PageView_SubView.extend({viewEl:"#page-directlogin-recovery",el:"#page-directlogin-recovery",initialRender:false,accountObj:null,events:{"click #btnOK":"clickOK","change input#email, input#recoverycode":"validate","change input#password, input#confirmpassword":"validate2"},validate:function(){this.validate_email();this.validate_recoverycode()},validate2:function(){this.validate_password();this.validate_confirmpassword()},validate_email:function(){$("#email",
this.el).nextAll(".validresult").removeClass("error ok");var validity=$("#email",this.el).checkValidity();var $feedback=$("#email",this.el).nextAll(".validresult");if(!validity.valid)if(validity.valueMissing)$feedback.addClass("error").text(dict("Required"));else $feedback.addClass("error").text(dict("Invalid Format")+dict("."));else $feedback.addClass("ok").text("OK")},validate_recoverycode:function(){$("input#recoverycode",this.el).nextAll(".validresult").removeClass("error ok");var validity=$("input#recoverycode",
this.el).checkValidity();var $feedback=$("input#recoverycode",this.el).nextAll(".validresult");if(!validity.valid)$feedback.addClass("error").text(dict("Required"));else $feedback.addClass("ok").text("OK")},validate_password:function(){$("#password",this.el).nextAll(".validresult").removeClass("error ok");var validity=$("input#password",this.el).checkValidity();var $feedback=$("#password",this.el).nextAll(".validresult");if(!validity.valid)if(validity.valueMissing)$feedback.addClass("error").text(dict("Required"));
else $feedback.addClass("error").text(dict("Invalid Format.")+" / "+dict("Please enter at least 4 characters")+dict("."));else $feedback.addClass("ok").text("OK")},validate_confirmpassword:function(){$("#confirmpassword",this.el).nextAll(".validresult").removeClass("error ok");passValidity=$("input#password",this.el).checkValidity();var validity=$("input#confirmpassword",this.el).checkValidity();var cpassword=$("input#confirmpassword",this.el).val();var password=$("input#password",this.el).val();
var $feedback=$("#confirmpassword",this.el).nextAll(".validresult");if(!validity.valid||!passValidity.valid)if(validity.valueMissing)$feedback.addClass("error").text(dict("Required"));else if(passValidity.valueMissing)$feedback.addClass("error").text(dict("Please enter password")+dict("."));else $feedback.addClass("error").text(dict("Invalid Format.")+" / "+dict("Please enter at least 4 characters")+dict("."));else if(cpassword!=password)$feedback.addClass("error").text(dict("Confirm password does not match the password")+
dict("."));else $feedback.addClass("ok").text("OK")},clickOK:function(){this.validate();var recoverycode=$("input#recoverycode",this.el).val();var email=$("input#email",this.el).val();var password=$("input#password",this.el).val();var confirmpassword=$("input#confirmpassword",this.el).val();if($("input#email, input#recoverycode, input#password, input#confirmpassword",this.el).checkValidityAll()==false);else if(password!=confirmpassword);else if($(".validresult.ok",this.el).length==4){this.accountObj=
new AccountModel_Reset({service:"Direct",recoveryPass:recoverycode,passKey:password,email:email});$("input",this.el).disable(true);this.accountObj.save({},{wait:true,success:_.bind(this.reset_success,this),error:_.bind(this.reset_fail,this)})}},reset_success:function(model,response,options){try{if(this.accountObj.get("success")==true){this.accountObj=null;location.href="#page/login/login";appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Password reset succeed!")})}else this.reset_fail()}catch(err){}$("input",
this.el).disable(false)},reset_fail:function(model,xhr,options){this.accountObj=null;appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Reset Failed")});$("input",this.el).disable(false)}});window.DirectLoginView_Activate=window.PageView_SubView.extend({viewEl:"#page-directlogin-activate",el:"#page-directlogin-activate",initialRender:false,accountObj:null,events:{"click #btnOK":"clickOK","change input#name, input#activatecode":"validate"},validate:function(){this.validate_name();this.validate_activatecode()},
validate_name:function(){$("#name",this.el).nextAll(".validresult").removeClass("error ok");var validity=$("#name",this.el).checkValidity();var $feedback=$("#name",this.el).nextAll(".validresult");if(!validity.valid)$feedback.addClass("error").text(dict("Required"));else $feedback.addClass("ok").text("OK")},validate_activatecode:function(){$("input#activatecode",this.el).nextAll(".validresult").removeClass("error ok");var validity=$("input#activatecode",this.el).checkValidity();var $feedback=$("input#activatecode",
this.el).nextAll(".validresult");if(!validity.valid)$feedback.addClass("error").text(dict("Required"));else $feedback.addClass("ok").text("OK")},clickOK:function(){this.validate();var activatecode=$("input#activatecode",this.el).val();var username=$("input#name",this.el).val();if($("input#name, input#activatecode",this.el).checkValidityAll()==false);else if($(".validresult.ok",this.el).length==2){this.accountObj=new AccountModel_Activate({service:"Direct",account:username,activePass:activatecode});
$("input",this.el).disable(true);this.accountObj.save({},{wait:true,success:_.bind(this.activate_success,this),error:_.bind(this.activate_fail,this)})}},activate_success:function(model,response,options){try{if(this.accountObj.get("success")==true){this.accountObj=null;location.href="#page/login/login";appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Account Activated!")+"\n"+dict("You can now login.")})}else if(this.accountObj.get("success")==false&&this.accountObj.get("hasActivated")==
true){this.accountObj=null;location.href="#page/login/login";appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Activate Failed")+dict(": ")+"\n"+dict("This account has already been activated before.")+"\n"+dict("You can now login.")})}else this.activate_fail()}catch(err){}$("input",this.el).disable(false)},activate_fail:function(model,xhr,options){this.accountObj=null;appRouter.siteFooter.show({action:"msg","alert":true,msg:dict("Activate Failed")});$("input",this.el).disable(false)}});
window.DirectLoginView_ChangePwd=window.PageView_SubView.extend({viewEl:"#page-directlogin-changepwd",el:"#page-directlogin-changepwd",initialRender:false,accountObj:null,events:{"click #btnOK":"clickOK","change input#password, input#confirmpassword, input#oldpassword":"validate2"},validate2:function(){this.validate_oldpassword();this.validate_password();this.validate_confirmpassword()},validate_oldpassword:function(){$("#oldpassword",this.el).nextAll(".validresult").removeClass("error ok");var validity=
$("input#oldpassword",this.el).checkValidity();var $feedback=$("#oldpassword",this.el).nextAll(".validresult");if(!validity.valid){if(validity.valueMissing)$feedback.addClass("error").text(dict("Required")).show()}else $feedback.addClass("ok").hide()},validate_password:function(){$("#password",this.el).nextAll(".validresult").removeClass("error ok");var validity=$("input#password",this.el).checkValidity();var $feedback=$("#password",this.el).nextAll(".validresult");if(!validity.valid)if(validity.valueMissing)$feedback.addClass("error").text(dict("Required"));
else $feedback.addClass("error").text(dict("Invalid Format.")+" / "+dict("Please enter at least 4 characters")+dict("."));else $feedback.addClass("ok").text("OK")},validate_confirmpassword:function(){$("#confirmpassword",this.el).nextAll(".validresult").removeClass("error ok");passValidity=$("input#password",this.el).checkValidity();var validity=$("input#confirmpassword",this.el).checkValidity();var cpassword=$("input#confirmpassword",this.el).val();var password=$("input#password",this.el).val();
var $feedback=$("#confirmpassword",this.el).nextAll(".validresult");if(!validity.valid||!passValidity.valid)if(validity.valueMissing)$feedback.addClass("error").text(dict("Required"));else if(passValidity.valueMissing)$feedback.addClass("error").text(dict("Please enter password")+dict("."));else $feedback.addClass("error").text(dict("Invalid Format.")+" / "+dict("Please enter at least 4 characters")+dict("."));else if(cpassword!=password)$feedback.addClass("error").text(dict("Confirm password does not match the password")+
dict("."));else $feedback.addClass("ok").text("OK")},clickOK:function(){this.validate2();var oldpassword=$("input#oldpassword",this.el).val();var password=$("input#password",this.el).val();var confirmpassword=$("input#confirmpassword",this.el).val();if($("input#oldpassword, input#password, input#confirmpassword",this.el).checkValidityAll()==false);else if(password!=confirmpassword);else if($(".validresult.ok",this.el).length==3){this.accountObj=new AccountModel_ChangePwd({service:"Direct",oldPassKey:oldpassword,
passKey:password,id:user.get("userID")});$("input",this.el).disable(true);appRouter.siteFooter.show({action:"updating"});this.accountObj.save({},{wait:true,success:_.bind(this.reset_success,this),error:_.bind(this.reset_fail,this)})}},reset_success:function(model,response,options){try{if(this.accountObj.get("success")==true){this.accountObj=null;appRouter.siteFooter.show({action:"msg",msg:dict("Password Change succeed!"),"alert":true});$("input#oldpassword, input#password, input#confirmpassword",
this.el).val("");$(".validresult",this.el).removeClass("error ok").text("")}else this.reset_fail()}catch(err){}$("input",this.el).disable(false)},reset_fail:function(model,xhr,options){this.accountObj=null;appRouter.siteFooter.show({action:"msg",msg:dict("Password Change Failed"),"alert":true});$("input",this.el).disable(false)}})})(jQuery);(function($){window.ErrorView=window.PageView.extend({})})(jQuery);(function($){window.NotFoundView=window.PageView.extend({})})(jQuery);(function($){window.SettingView=window.PageView.extend({events:{"click .btnChangeLanguage":"changeLangauge"},subpage:null,showSubPage:function(subpage){try{if(subpage==null)subpage=$(".subpage[subpage]",this.el).attr("subpage");if(this.subpage!=subpage){$(".subpage[subpage!='"+subpage+"']",this.el).hide();$(".subpage[subpage='"+subpage+"']",this.el).show();this.subpage=subpage}$(".menu a",this.el).each(function(){if($(this).attr("href")=="#"+Backbone.history.fragment)$(this).addClass("current");else $(this).removeClass("current")})}catch(err){}},
loadSubviews:function(){this.subviews["systemconfig"]=new SettingView_SystemConfig_gps;this.subviews["settings"]=new SettingView_Settings},changeLangauge:function(e){var newLangID=$(e.currentTarget).attr("langID");newLangID=Convert.ToInt(newLangID);if(DICT[newLangID]!=null){user.lang(newLangID);appRouter.siteHeader.render();appRouter.reloadPage()}}});window.SettingView_Settings=window.PageView_SubView.extend({viewEl:"#page-setting-settings",el:"#page-setting-settings",parentView:"SettingView",initialRender:false,
events:{"click #btnSystemReset":"clickSystemReset"},clickSystemReset:function(){if(confirm(dict("You will lose all your data, including logins, submission, etc...")+"\n"+dict("Are you sure?"))){localStorage.clear();if(siteInfo.isApp())location.href="index.html";else location.href=baseURL}}});window.SettingView_SystemConfig_gps=window.PageView_SubView.extend({viewEl:"#page-setting-systemconfig",el:"#page-setting-systemconfig",parentView:"SettingView",initialRender:false,isOK:false,events:{"click #btnGetGeo":"getGeo"},
initializeBoundFunc:function(){_.bindAll(this,"render","updateGPS");this.intervalVal=setInterval(_.bind(this.updateGPS,this),1E3)},getGeo:function(){if(!appFunc.isApp())if(appFunc.get("android")&&appFunc.get("browser")=="Chrome");else appFunc.listenToGeolocation()},updateGPS:function(){this.render3("#page-setting-gpscompass")},removeBoundFunc:function(){clearInterval(this.intervalVal);this.intervalVal=null}})})(jQuery);(function($){window.InfoView=window.PageView.extend({subpage:null,showSubPage:function(subpage){try{if(subpage==null)subpage=$(".subpage[subpage]",this.el).attr("subpage");if(this.subpage!=subpage){$(".subpage[subpage!='"+subpage+"']",this.el).hide();$(".subpage[subpage='"+subpage+"']",this.el).show();this.subpage=subpage}$(".menu a",this.el).each(function(){if($(this).attr("href")=="#"+Backbone.history.fragment)$(this).addClass("current");else $(this).removeClass("current")})}catch(err){}}})})(jQuery);(function($){window.HomeView=window.PageView.extend({events:{"click .detail":"showDetail","click #btnSearch":"getAMap","click .btnLoadGMap":"loadGMap"},showDetail:function(){$(".detail-layer",this.el).toggle()},getAMap:function(){appRouter.showTrip($("input#search",this.el).val())},loadGMap:function(){$(".btnLoadGMap").attr("disabled","");if(!appFunc.isApp()){$(".btnLoadGMap").removeAttr("disabled");return}try{var networkState=navigator.network.connection.type;if(networkState==Connection.NONE){appFunc.alert(dict("No Internet.")+
"\n"+dict("Please connect to internet."));$(".btnLoadGMap").removeAttr("disabled");return}}catch(err){}appFunc.loadGMap()},loadSubviews:function(){this.subviews["recentMaps"]=new HomeView_RecentMaps}});window.HomeView_RecentMaps=window.PageView_SubView.extend({el:"#recentmaps",collectionEvents:{"reset":"resetItems"},initializeBoundFunc:function(){_.bindAll(this,"render","appendItem")},init:function(){this.collection=new MapCollection;this.collection.fetchParams.keys=tripCollection.currentTrips();
if(this.collection.fetchParams.keys.length==0)this.collection.fetchParams.keys=["0"];var permitArr=[];permitArr.push("onlyEnable");if(permitArr.length>0)this.collection.fetchParams.permit=permitArr.join("|")},initialRender:true,render:function(){$(this.el).empty().append("<ul></ul>")},load:function(){if(appFunc.isApp()){if(!appFunc.isOfflineReady())return;var self=this;var currentKeys=this.collection.fetchParams.keys;function errorCB(err){}function querySuccess(tx,results){var _mapModels=[];if(results.rows.length>
0)for(var i=0;i<results.rows.length;i++){var _mapModel=new MapModel({id:results.rows.item(i).id,mapKey:results.rows.item(i).mapKey,name:results.rows.item(i).name,offline:true});_mapModels.push(_mapModel)}else;self.collection.reset(_mapModels)}function populateDB(tx){if(currentKeys.length==0)tx.executeSql("SELECT MAP.* FROM MAP, CPS WHERE FALSE",[],querySuccess,errorCB);else if(currentKeys.length==1)tx.executeSql("SELECT MAP.* FROM MAP, CPS WHERE MAP.mapKey = CPS.mapKey AND MAP.mapKey=?",[currentKeys[0]],
querySuccess,errorCB);else tx.executeSql("SELECT MAP.* FROM MAP, CPS WHERE MAP.mapKey = CPS.mapKey AND MAP.mapKey in ('"+currentKeys.join("','")+"')",[],querySuccess,errorCB)}appFunc.db.transaction(populateDB,errorCB)}else this.collection.fetch({data:{mode:"recent"}})},resetItems:function(){this.unloadSubviews();$(".home-modebuttons .thetrip").toggleClass("noCurrent",this.collection.length==0);var self=this;$("ul",this.el).empty();_(this.collection.models).each(function(item){self.appendItem(item)},
this)},appendItem:function(item){var itemView=new RecentMapView({model:item});this.subviews[itemView.cid]=itemView;$("ul",this.el).append(itemView.render().el)}});window.RecentMapView=Backbone.View.extend({tagName:"li",initialize:function(){_.bindAll(this)},render:function(){var offline=false;if(this.model.has("offline"))offline=this.model.get("offline");$(this.el).html('<a href="#mode/trip/'+this.model.id+"/cp"+(offline?"/offline":"")+'">'+this.model.get("name")+"</a>");return this}})})(jQuery);(function($){window.HeaderView=window.PageView.extend({viewEl:"#header",el:$("#header")});window.NoHeaderView=window.PageView.extend({viewEl:"#header",el:$("#header")})})(jQuery);(function($){window.SiteHeaderView=window.PageView.extend({viewEl:"#siteheader",el:$("#siteheader"),events:{"click #btnLogin":"clickLogin","click #btnLogout":"clickLogout"},initializeBoundFunc:function(){_.bindAll(this);user.bind("change:userID",_.bind(this.userChanged,this));user.bind("change:lang",_.bind(this.render,this))},removeBoundFunc:function(){user.unbind("change:userID",_.bind(this.userChanged,this));user.unbind("change:lang",_.bind(this.render,this))},clickLogin:function(){appRouter.showLogin()},
clickLogout:function(){user.oauth_logout();appRouter.showHome();location.href="#page/home"},userChanged:function(){this.render3(".divLogin")}})})(jQuery);(function($){window.SiteFooterView=window.PageView.extend({viewEl:"#sitefooter",el:$("#sitefooter"),render:function(){return this},events:{"show":"showFooter","hide":"hideFooter"},show:function(showObj){var self=this;$(this.el).trigger("show",showObj)},hide:function(showObj){var self=this;$(this.el).trigger("hide")},showFooter:function(e,showObj){var self=this;var hideAfter=false;try{switch(showObj.action){case "message":case "msg":case "cpAlert":hideAfter=true;var msg=showObj.msg;$(this.el).html(msg);
try{if(appFunc.isApp()&&showObj.action=="cpAlert"&&showObj["alert"]==true){navigator.notification.beep(1);navigator.notification.vibrate(500)}}catch(err2){}try{if(showObj["alert"])appFunc.alert(msg)}catch(err2){}break;case "save":hideAfter=true;var lastUpdate=showObj.lastUpdate;$(this.el).html(dict("Last Update")+dict(": ")+moment(lastUpdate).format("YYYY-MM-DD HH:mm:ss"));break;case "submit":hideAfter=true;var lastUpdate=showObj.lastUpdate;$(this.el).html(dict("Submit")+dict(": ")+moment(lastUpdate).format("YYYY-MM-DD HH:mm:ss"));
break;case "updating":$(this.el).html(dict("Updating"));break;case "submitting":$(this.el).html(dict("Submitting"));break;case "pleaseWait":$(this.el).html(dict("Please wait")+"...");break;case "error":case "saveError":hideAfter=true;var errorText="";var errorCode="";try{var xhr=showObj.xhr;if(!_.isObject(xhr))errorText=xhr;else errorText=xhr.statusText;if(xhr.status==0)errorText="Connection Failed";errorCode=xhr.status;if(xhr.status==500&&xhr.responseText=="timeout"){errorCode=408;errorText="Request Timeout"}}catch(err2){}$(this.el).html(dict("Error")+
(errorText!=""?dict(": ")+dict(errorText):""));var toAlert=true;try{if(showObj["alert"]==false)toAlert=false}catch(err3){}if(toAlert)alert(dict("Error"));break;default:return;break}}catch(err){}$(this.el).addClass("show");if(hideAfter)$(this.el).delay(2E3,function(){self.hideFooter()})},hideFooter:function(e){$(this.el).removeClass("show")}})})(jQuery);(function($){window.SiteNoticeView=window.PageView.extend({viewEl:"#sitenotice",el:$("#sitenotice"),init:function(){this.collection=new SiteNoticeCollection},load:function(){this.collection.fetch()},render:function(){return this},collectionEvents:{"reset":"resetItems"},events:{"click .btnClose":"CloseNoticePrompt"},resetItems:function(){if(this.collection.length==0);else{var self=this;_(this.collection.models).each(function(item){self.OpenNoticePrompt(item);return false},this)}},OpenNoticePrompt:function(model){this.render2({noticeObj:model.toJSON()});
$(this.el).show();if(window.localStorage!=null){var info=localStorage.getItem("notice");if(info!=null){var d1=new Date(parseInt(info,10));var d3=new Date(model.get("postTime"));var d2=new Date;d2.setDate(d2.getDate()-0.04);if(d2<d1&&d3<d1)$(this.el).hide();else localStorage.removeItem("notice")}}},CloseNoticePrompt:function(){$(this.el).hide();if(window.localStorage!=null)localStorage.setItem("notice",(new Date).getTime())}})})(jQuery);$(function(){if(isDemo)$("#page").addClass("demo");if(appFunc.get("android")&&appFunc.get("browser")=="Default")$("#page").addClass("android-default");$("#page").attr("lang",dict("@locale"));user.on("change:lang",function(){$("#page").attr("lang",dict("@locale"))});$("#page").toggleClass("sided-1p",user.get("sided")=="sided-1p");if(appFunc.isApp()&&!appFunc.get("gmapReady"));});
var AppRouter=Backbone.Router.extend({routes:{"activate/:account/:pass":"activeAccount","recovery/:email/:pass":"resetPassword","page/:page":"showPage","page/:page/:subpage":"showPage","mode/:mode":"showMode","mode/:mode/:mapkey":"showMode","mode/:mode/:mapkey":"showMode","mode/:mode/:mapkey/:subpage":"showMode","mode/:mode/:mapkey/:subpage/:extrapage":"showMode","trip/:mapkey":"showTrip","map":"showMaplist","map/:mode":"showMaplist","":"showHome","*path":"showNotFound"},initialize:function(options){var self=
this;this.pages=new PageCollection([{page:"home",title:"Step Out",header:"NoHeaderView",content:"HomeView"},{page:"info",title:"Information",header:"HeaderView",content:"InfoView"},{page:"setting",title:"Setting",header:"HeaderView",content:"SettingView"},{page:"404",title:"404 Not Found",header:"HeaderView",content:"NotFoundView"},{page:"error",title:"Error",header:"HeaderView",content:"ErrorView"},{page:"login",title:"Login",header:"HeaderView",content:"DirectLoginView"},{page:"notsupport",title:"Not support",
header:"HeaderView",content:"NotSupportView"}]);this.modes=new PageCollection([{page:"preview",title:"Map Preview",header:"PreviewHeaderView",content:"PreviewView"},{page:"newmap",title:"New Map",header:"NewMapHeaderView",content:"NewMapView"},{page:"plan",title:"Plan the Trip",header:"PlanTripHeaderView",content:"PlanTripView"},{page:"pre",title:"Pre-Trip",header:"PreTripHeaderView",content:"PreTripView"},{page:"trip",title:"The Trip",header:"TheTripHeaderView",content:"TheTripView"},{page:"after",
title:"After Trip",header:"AfterTripHeaderView",content:"AfterTripView"}]);this.maplists=new PageCollection([{page:"maplist",title:"Map List",header:"NoHeaderView",content:"MapListView"}]);this.siteHeader=new SiteHeaderView;this.siteFooter=new SiteFooterView;this.siteNotice=new SiteNoticeView},showPage:function(page,subpage){if(page!="notsupport"&&siteInfo.notSupport()){this.showNotSupport();return}var page_out=this.pages.where1({"page":page});if(page_out==null){this.showNotFound();return}var headerView=
window[page_out.get("header")];var contentView=window[page_out.get("content")];if(headerView===undefined){this.showError();return}if(contentView===undefined){this.showError();return}if(!(this.header&&this.header instanceof headerView)){if(this.header!=null)this.header.remove();this.header=new headerView}if(!(this.content&&this.content instanceof contentView)){if(this.content!=null)this.content.remove();this.content=new contentView;this.trackPageView()}if(this.content.showSubPage)this.content.showSubPage(subpage);
if(subpage==null);else;this._header=this._content=null},showMode:function(mode,mapkey,subpage,extrapage){if(mapkey==null||mapkey=="")this.showMaplist(mode);else{if(extrapage!="extrapage")$(".extrapage").remove();var offline=extrapage=="offline"&&appFunc.isApp();if(offline)extrapage=null;var hasContent=this.content!=null;if(siteInfo.notSupport()){this.showNotSupport();return}if((mode=="plan"||mode=="pre"||mode=="newmap")&&user.get("userID")==null){alert(dict("Please login!")+"\n"+dict("You have to login to create and edit maps."));
if(hasContent)history.back();else this.showHome();return}var page_out=this.modes.where1({"page":mode});if(page_out==null){this.showNotFound();return}var headerView=window[page_out.get("header")];var contentView=window[page_out.get("content")];if(headerView===undefined){this.showError();return}if(contentView===undefined){this.showError();return}if(!(this.header&&this.header instanceof headerView))if(this.header!=null){this.header.remove();this.header=null}if(!(this.content&&this.content instanceof
contentView)){var self=this;if(this.content!=null){this.content.remove();this.content=null}if(mode=="newmap"){var map=new MapModel({language:dict("@locale")});if(self.header==null)self.header=new headerView({model:map});self.content=new contentView({model:map,param:{mode:mode}});self.trackPageView()}else{$("#content").html('<br /><br /><br /><div style="text-align:center"><img src="img/bg-loading.gif" width="100" height="100"></div><br /><br /><br /><br /><br />');var map=new MapModel({mapKey:mapkey});
var mapData={data:{mode:mode},success:function(model,response,options){if(!map.isNew()&&map.get("id")==null){self.showNotFound();return}else{var maplang=locale(map.get("language"));var confirmText=dict("This map is in a different language")+" ("+dict(maplang)+")"+dict(".")+"\n"+dict("Switch Language")+dict("?");switch(mode){case "plan":if(!map.canPlan()){self.showHome();return}else;break;case "pre":if(!map.canPre()){self.showHome();return}else;break;case "trip":if(!map.canTrip()){self.showHome();
return}else{var currTripsKeys=tripCollection.currentTrips();if(currTripsKeys.length>0)if($.inArray(map.id,currTripsKeys)<0)if(confirm(dict("You have started another trip. Quit that one?")+"\n"+dict("(Note: You may only start one trip concurrently.)")))tripCollection.removeCurrentTrips();else{if(hasContent)history.back();else self.showHome();return}var currLang=user.lang();if(user.lang()!=maplang)user.lang(maplang);if(map.needPrivateKey()){var result=prompt(dict("Plaese enter map password"));if(result==
null){if(user.lang()!=currLang)user.lang(currLang);if(hasContent)history.back();else self.showHome();return}else if(result!=map.get("privateKey")){alert(dict("wrong password"));if(user.lang()!=currLang)user.lang(currLang);if(hasContent)history.back();else self.showHome();return}}}break;case "after":if(!map.canAfter()){self.showHome();return}else if(user.lang()!=maplang)if(map.isCreator()||map.isCollaborator());else user.lang(maplang);break}if(self.header==null)self.header=new headerView({model:map});
self.content=new contentView({model:map,param:{mode:mode}});self.trackPageView();if(self.content.showSubPage)self.content.showSubPage(subpage)}},error:function(model,xhr,options){appRouter.siteFooter.show({action:"error",xhr:xhr})}};if(appFunc.isApp()&&mode=="trip")if(offline){map.offline=true;map.fetchOffline(mapData)}else map.fetch2(mapData);else map.fetch(mapData)}}if(this.content!=null)if(this.content.showSubPage)this.content.showSubPage(subpage)}this._header=this._content=null},showMaplist:function(mode,
defaultMapKey){var hasContent=this.content!=null;if((mode=="plan"||mode=="pre")&&user.get("userID")==null){alert(dict("Please login!")+"\n"+dict("You have to login to create and edit maps."));if(hasContent)history.back();else this.showHome();return;this.showPage("setting",0);if($("#page-setting-account").length>0)$("#page-setting-account").css({"border-color":"red","border-width":"2px"});return}var page="maplist";var page_out=this.maplists.where1({"page":page});if(page_out==null){this.showNotFound();
return}var headerView=window[page_out.get("header")];var contentView=window[page_out.get("content")];if(headerView===undefined){this.showError();return}if(contentView===undefined){this.showError();return}if(!(this.header&&this.header instanceof headerView)){if(this.header!=null)this.header.remove();this.header=new headerView}if(!(this.content&&this.content instanceof contentView)){if(this.content!=null)this.content.remove();this.content=new contentView({param:{mode:mode,mapKey:defaultMapKey}});this.trackPageView()}if(this.content.showSubPage)this.content.showSubPage(subpage);
this._header=this._content=null},showHome:function(){location.href="#page/home"},showNotFound:function(){this.showPage("404")},showError:function(){this.showPage("error")},showLogin:function(){location.href="#page/login"},showNotSupport:function(){this.showPage("notsupport")},showTrip:function(mapKey){this.showMaplist("trip",mapKey);location.href="#mode/trip"},activeAccount:function(account,pass){this.showPage("login","activate");location.href="#page/login/activate";$("#page-directlogin-activate #name").val(account);
$("#page-directlogin-activate #activatecode").val(pass);$("#page-directlogin-activate #name, #page-directlogin-activate #activatecode").disable(true)},resetPassword:function(email,pass){this.showPage("login","recovery");location.href="#page/login/recovery";$("#page-directlogin-recovery #email").val(email);$("#page-directlogin-recovery #recoverycode").val(pass);$("#page-directlogin-recovery #email, #page-directlogin-recovery #recoverycode").disable(true)},reloadPage:function(){var href=location.hash;
if(this.header!=null){this.header.remove();this.header=null}if(this.content!=null){this.content.remove();this.content=null}Backbone.history.loadUrl(href)},loadPage:function(url){if(this.header!=null){this.header.remove();this.header=null}if(this.content!=null){this.content.remove();this.content=null}if(url!=null){var href=url;Backbone.history.loadUrl(href)}},trackPageView:function(){try{var hash=location.hash;if(hash)_gaq.push(["_trackPageview",hash.substr(1)]);else _gaq.push(["_trackPageview"])}catch(err){}}});
templateLoader.load(["SiteHeaderView","HeaderView","NoHeaderView","SiteNoticeView","HomeView","InfoView","SettingView","NotFoundView","ErrorView","DirectLoginView","NotSupportView","MapListView","MapListView_SearchResult","PreviewView","PreviewHeaderView","NewMapView","NewMapHeaderView","PlanTripView","PlanTripHeaderView","PlanTripView_Tags","PlanTripView_Users","PlanTripView_Plot","PlanTripView_SearchCP","PlanTripView_CP","PlanTripView_NewCP","PlanTripView_CPDetail","PlanTripView_ReorderCP","PlanTripView_Task",
"PlanTripView_NewTask","PlanTripView_ReorderTask","PreTripView","PreTripHeaderView","PreTripView_CP","PreTripView_CPDetail","PreTripView_Task","PreTripView_NoteItem","TheTripView","TheTripHeaderView","TheTripView_CP","TheTripView_CPDetail","TheTripView_Task","AfterTripView","AfterTripHeaderView","AfterTripView_NoteItem","AfterTripView_CP","AfterTripView_CPDetail","AfterTripView_Task","Others_Tips"],function(){appRouter=new AppRouter;if(siteInfo.isApp())Backbone.history.start();else if(isLocal&&testPushState)Backbone.history.start({pushState:isDemo||
isLocal,root:"/StepOut/"});else if(isDemo&&testPushState)Backbone.history.start({pushState:isDemo||isLocal});else Backbone.history.start();if(siteInfo.isApp())$(document).delegate("a:not([data-bypass]):not([data-toggle])","click",function(evt){var href=$(this).attr("href");if(href.indexOf("javascript:")>=0)return;if(href.indexOf("http://")>=0){window.open(href,"_system");return false}if(href.indexOf("https://")>=0){window.open(href,"_system");return false}});appFunc.listenToCompass();window.fontLoader()});
